{"version":3,"file":"formCustomisation-8a41b461.js","sources":["../../../../desk/src/composables/formCustomisation.ts"],"sourcesContent":["import { Field } from \"@/types\";\n\nexport async function setupCustomizations(doc, obj) {\n  // Supporting old format, will have to refactor later\n  let data = doc.data ?? doc;\n  if (!data) return;\n  if (!data._form_script) return [];\n  let actions = [];\n  let onChangeFieldMap = {};\n  if (Array.isArray(data._form_script)) {\n    for (const script of data._form_script) {\n      const parsed = await parseScript(script, obj);\n      actions = actions.concat(parsed.actions);\n      if (parsed.onChange) {\n        parseOnChangeFn(onChangeFieldMap, parsed.onChange);\n      }\n    }\n  } else {\n    const parsed = await parseScript(data._form_script, obj);\n    actions = parsed.actions;\n    if (parsed.onChange) {\n      parseOnChangeFn(onChangeFieldMap, parsed.onChange);\n    }\n  }\n  data._customActions = actions;\n  if (Object.keys(onChangeFieldMap).length) {\n    data._customOnChange = onChangeFieldMap;\n  }\n}\n\nfunction parseOnChangeFn(fieldMap: object, currentField: object) {\n  for (const [key, value] of Object.entries(currentField)) {\n    if (!fieldMap[key]) {\n      fieldMap[key] = new Set();\n    }\n    fieldMap[key].add(value);\n  }\n}\n\nasync function parseScript(script, obj) {\n  const scriptFn = new Function(script + \"\\nreturn setupForm\")();\n  const formScript = await scriptFn(obj);\n  return {\n    actions: formScript?.actions || [],\n    onChange: formScript?.onChange || null,\n  };\n}\n\nexport function handleSelectFieldUpdate(\n  f: Field,\n  fieldname: string,\n  filters: any,\n  doc: any,\n  oldDoc: any\n) {\n  if (!filters || !filters.length) {\n    f.options = oldDoc.find((f) => f.fieldname === fieldname).options;\n    f.disabled = true;\n  } else {\n    f.options = filters.join(\"\\n\");\n    f.disabled = false;\n  }\n  // reset dependent field\n  doc[fieldname] = \"\";\n}\n\nexport function handleLinkFieldUpdate(\n  f: Field,\n  fieldname: string,\n  filters: any,\n  doc: any,\n  oldDoc: any\n) {\n  if (!filters || !filters.length) {\n    f.link_filters = oldDoc.find((f) => f.fieldname === fieldname).link_filters;\n    f.disabled = true;\n    return;\n  }\n  f.link_filters = JSON.stringify([[f.options, \"name\", \"in\", filters]]);\n  f.disabled = false;\n\n  // reset dependent field\n  doc[fieldname] = \"\";\n}\n\n//\nexport function parseField(field, doc) {\n  return {\n    display_via_depends_on: evaluateDependsOnValue(field?.depends_on, doc),\n    ...field,\n    required:\n      field.required ||\n      (field.mandatory_depends_on &&\n        evaluateDependsOnValue(field.mandatory_depends_on, doc)),\n    filters: field.link_filters && JSON.parse(field.link_filters),\n    disabled: field.disabled,\n    readonly:\n      field.readonly ||\n      (field.read_only_depends_on &&\n        evaluateDependsOnValue(field.read_only_depends_on, doc)),\n  };\n}\nexport function evaluateDependsOnValue(expression, doc) {\n  if (!expression) return true;\n  let out = null;\n  if (expression.substr(0, 5) == \"eval:\") {\n    try {\n      out = _eval(expression.substr(5), { doc });\n    } catch (e) {\n      out = true;\n    }\n  } else if (expression.substr(0, 4) == \"doc.\") {\n    out = doc[expression.substr(4)];\n  } else {\n    let value = doc[expression];\n    if (Array.isArray(value)) {\n      out = !!value.length;\n    } else {\n      out = !!value;\n    }\n  }\n  return out;\n}\nfunction _eval(code, context = {}) {\n  let variable_names = Object.keys(context);\n  let variables = Object.values(context);\n  code = `let out = ${code}; return out`;\n  try {\n    let expression_function = new Function(...variable_names, code);\n    return expression_function(...variables);\n  } catch (error) {\n    console.log(\"Error evaluating the following expression:\");\n    console.error(code);\n    throw error;\n  }\n}\n"],"names":["setupCustomizations","doc","obj","data","actions","onChangeFieldMap","script","parsed","parseScript","parseOnChangeFn","fieldMap","currentField","key","value","formScript","handleSelectFieldUpdate","f","fieldname","filters","oldDoc","handleLinkFieldUpdate","parseField","field","evaluateDependsOnValue","expression","out","_eval","code","context","variable_names","variables","error"],"mappings":"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"}