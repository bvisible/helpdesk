{"version":3,"file":"CommentBox-40099ccc.js","sources":["../../../../desk/src/components/CommentBox.vue"],"sourcesContent":["<template>\n  <div class=\"flex-col text-base flex-1\" ref=\"commentBoxRef\">\n    <div class=\"mb-1 ml-0.5 flex items-center justify-between\">\n      <div class=\"text-gray-600 flex items-center gap-2\">\n        <Avatar\n          size=\"md\"\n          :label=\"commenter\"\n          :image=\"getUser(commentedBy).user_image\"\n        />\n        <p>\n          <span class=\"font-medium text-gray-800\">\n            {{ commenter }}\n          </span>\n          <span> added a</span>\n          <span class=\"max-w-xs truncate font-medium text-gray-800\">\n            comment\n          </span>\n        </p>\n      </div>\n      <div class=\"flex items-center gap-1\">\n        <Tooltip :text=\"dateFormat(creation, dateTooltipFormat)\">\n          <span class=\"pl-0.5 text-sm text-gray-600\">\n            {{ timeAgo(creation) }}\n          </span>\n        </Tooltip>\n        <div v-if=\"authStore.userId === commentedBy && !editable\">\n          <Dropdown\n            :placement=\"'right'\"\n            :options=\"[\n              {\n                label: 'Edit',\n                onClick: () => handleEditMode(),\n                icon: 'edit-2',\n                condition: () => !isTicketMergedComment,\n              },\n              {\n                label: 'Delete',\n                onClick: () => (showDialog = true),\n                icon: 'trash-2',\n              },\n            ]\"\n          >\n            <Button\n              icon=\"more-horizontal\"\n              class=\"text-gray-600\"\n              variant=\"ghost\"\n            />\n          </Dropdown>\n        </div>\n      </div>\n    </div>\n    <div\n      :id=\"`comment-${name}`\"\n      class=\"rounded bg-gray-50 transition-colors px-4 py-3\"\n    >\n      <TextEditor\n        ref=\"editorRef\"\n        :editor-class=\"[\n          'prose-f shrink text-p-sm transition-all duration-300 ease-in-out block w-full content',\n          getFontFamily(_content),\n        ]\"\n        :content=\"_content\"\n        :editable=\"editable\"\n        :bubble-menu=\"textEditorMenuButtons\"\n        @change=\"(event:string) => {_content = event}\"\n      >\n        <template #bottom v-if=\"editable\">\n          <div class=\"flex flex-row-reverse gap-2\">\n            <Button label=\"Save\" @click=\"handleSaveComment\" variant=\"solid\" />\n            <Button label=\"Discard\" @click=\"handleDiscard\" />\n          </div>\n        </template>\n      </TextEditor>\n      <div class=\"flex flex-wrap gap-2\" v-if=\"!editable\">\n        <AttachmentItem\n          v-for=\"a in attachments\"\n          :key=\"a.file_url\"\n          :label=\"a.file_name\"\n          :url=\"a.file_url\"\n        />\n      </div>\n    </div>\n  </div>\n  <Dialog\n    v-model=\"showDialog\"\n    :options=\"{\n      title: 'Delete Comment',\n      message: 'Are you sure you want to confirm this action?',\n      actions: [\n        { label: 'Cancel', onClick: () => (showDialog = false) },\n        {\n          label: 'Delete',\n          onClick: () => deleteComment.submit(),\n          variant: 'solid',\n        },\n      ],\n    }\"\n  />\n</template>\n\n<script setup lang=\"ts\">\nimport { AttachmentItem } from \"@/components\";\nimport { useAuthStore } from \"@/stores/auth\";\nimport { updateRes as updateComment } from \"@/stores/knowledgeBase\";\nimport { useUserStore } from \"@/stores/user\";\nimport { CommentActivity } from \"@/types\";\nimport {\n  dateFormat,\n  dateTooltipFormat,\n  getFontFamily,\n  isContentEmpty,\n  textEditorMenuButtons,\n  timeAgo,\n} from \"@/utils\";\nimport {\n  Avatar,\n  Dialog,\n  Dropdown,\n  TextEditor,\n  createResource,\n  toast,\n} from \"frappe-ui\";\nimport { PropType, computed, onMounted, ref } from \"vue\";\nconst authStore = useAuthStore();\nconst props = defineProps({\n  activity: {\n    type: Object as PropType<CommentActivity>,\n    required: true,\n  },\n});\nconst { getUser } = useUserStore();\n\nconst { name, creation, content, commenter, commentedBy, attachments } =\n  props.activity;\n\nconst isTicketMergedComment = computed(() => {\n  const regex = /has been merged with ticket #\\d+/;\n  return regex.test(content);\n});\n\nconst emit = defineEmits([\"update\"]);\nconst showDialog = ref(false);\nconst editable = ref(false);\nconst _content = ref(content);\n\n// HTML refs\nconst commentBoxRef = ref(null);\nconst editorRef = ref(null);\n\nfunction handleEditMode() {\n  editable.value = true;\n  editorRef.value.editor.chain().focus(\"start\");\n}\n\nfunction handleDiscard() {\n  _content.value = content;\n  editable.value = false;\n}\n\nconst deleteComment = createResource({\n  url: \"frappe.client.delete\",\n  makeParams: () => ({\n    doctype: \"HD Ticket Comment\",\n    name: name,\n  }),\n  onSuccess() {\n    emit(\"update\");\n    showDialog.value = false;\n    toast.success(\"Comment deleted\");\n  },\n});\n\nfunction handleSaveComment() {\n  if (content === _content.value) {\n    editable.value = false;\n    return;\n  }\n  if (isContentEmpty(_content.value)) {\n    toast.error(\"Comment cannot be empty\");\n    return;\n  }\n\n  updateComment.submit(\n    {\n      doctype: \"HD Ticket Comment\",\n      name: name,\n      fieldname: \"content\",\n      value: _content.value,\n    },\n    {\n      onSuccess: () => {\n        editable.value = false;\n        emit(\"update\");\n        toast.success(\"Comment updated\");\n      },\n    }\n  );\n}\n\nonMounted(() => {\n  commentBoxRef.value.style.width = \"0px\";\n});\n</script>\n"],"names":["authStore","useAuthStore","props","__props","getUser","useUserStore","name","creation","content","commenter","commentedBy","attachments","isTicketMergedComment","computed","emit","__emit","showDialog","ref","editable","_content","commentBoxRef","editorRef","handleEditMode","handleDiscard","deleteComment","createResource","toast","handleSaveComment","isContentEmpty","updateComment","onMounted","_createElementVNode","_hoisted_1","_hoisted_2","_createVNode","_unref","Avatar","_hoisted_3","_toDisplayString","_cache","_hoisted_4","_component_Tooltip","dateFormat","dateTooltipFormat","_hoisted_5","timeAgo","_createElementBlock","_hoisted_6","Dropdown","_component_Button","TextEditor","getFontFamily","textEditorMenuButtons","event","_hoisted_8","_openBlock","_hoisted_9","_Fragment","_renderList","a","_createBlock","AttachmentItem","Dialog","$event"],"mappings":"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"}