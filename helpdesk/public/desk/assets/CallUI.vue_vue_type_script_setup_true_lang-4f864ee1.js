import{j as be,e as k,k as R,l as v,b8 as Ri,A as E,bo as Di,c as Li,d as Ae,u as Mi,b as Oi,r as qe,f as me,w as q,a8 as se,h as w,x as Pt,t as $i,v as H,C as Qt,V as Yt,a as ji,g as I,a_ as ze,W as Ui,z as Me,F as ut,G as Fi,H as Ni,Y as Vi,q as fe,aW as Hi,aY as Wi,a0 as Te,a4 as xe,X as ke,co as ei,an as Ne,ao as Ve,ai as ti,y as He,D as ii,E as ni,ab as Bi,cp as si,S as We,ar as Gi,a1 as At,$ as qi,am as zi,a9 as Qe}from"./index-b4c863a6.js";import{D as Ji}from"./Dropdown-f79f7542.js";import{_ as Ki}from"./chevron-right-cd59273c.js";import{j as oi,n as ri,g as Zi}from"./TypingIndicator.vue_vue_type_style_index_0_scoped_3f215bd3_lang-c8d975a4.js";import{P as Xi}from"./PhoneIcon-ea7dd5f1.js";import{u as dt}from"./telephony-64d62ea1.js";import{_ as Be}from"./Avatar.vue_vue_type_script_setup_true_lang-89128cfb.js";function Qi(t,e){for(var i=0;i<e.length;i++){const n=e[i];if(typeof n!="string"&&!Array.isArray(n)){for(const o in n)if(o!=="default"&&!(o in t)){const r=Object.getOwnPropertyDescriptor(n,o);r&&Object.defineProperty(t,o,r.get?r:{enumerable:!0,get:()=>n[o]})}}}return Object.freeze(Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}))}const Yi={},en={width:"18",height:"18",viewBox:"0 0 18 18",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function tn(t,e){return k(),R("svg",en,[...e[0]||(e[0]=[v("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M4.83144 1.7793L4.81079 1.7793C4.40911 1.77929 4.07754 1.77929 3.80742 1.80135C3.52685 1.82428 3.26886 1.87348 3.0265 1.99697C2.65072 2.18844 2.3452 2.49396 2.15373 2.86974C2.03024 3.1121 1.98104 3.37009 1.95811 3.65066C1.93604 3.92078 1.93605 4.25235 1.93606 4.65403L1.93606 4.67468V15.2533H1.6875C1.41136 15.2533 1.1875 15.4772 1.1875 15.7533C1.1875 16.0295 1.41136 16.2533 1.6875 16.2533H2.43606H9.92162H15.9101H16.6586C16.9348 16.2533 17.1586 16.0295 17.1586 15.7533C17.1586 15.4772 16.9348 15.2533 16.6586 15.2533H16.4101V10.6631V10.6425C16.4101 10.2408 16.4101 9.90924 16.388 9.63911C16.3651 9.35854 16.3159 9.10055 16.1924 8.85819C16.0009 8.48241 15.6954 8.17689 15.3196 7.98542C15.0773 7.86193 14.8193 7.81273 14.5387 7.7898C14.2686 7.76774 13.937 7.76774 13.5353 7.76775H13.5147H10.4216V4.67468V4.65402C10.4216 4.25235 10.4216 3.92077 10.3996 3.65066C10.3766 3.37009 10.3274 3.1121 10.2039 2.86974C10.0125 2.49396 9.70696 2.18844 9.33118 1.99697C9.08882 1.87348 8.83082 1.82428 8.55026 1.80135C8.28014 1.77929 7.94856 1.77929 7.54688 1.7793L7.52624 1.7793H4.83144ZM9.42162 15.2533H2.93606V4.67468C2.93606 4.2472 2.93645 3.95666 2.95479 3.73209C2.97266 3.51337 3.00505 3.40162 3.04473 3.32373C3.14033 3.13611 3.29287 2.98357 3.48049 2.88798C3.55838 2.84829 3.67013 2.8159 3.88885 2.79803C4.11342 2.77969 4.40396 2.7793 4.83144 2.7793H7.52624C7.95372 2.7793 8.24426 2.77969 8.46882 2.79803C8.68755 2.8159 8.7993 2.84829 8.87719 2.88798C9.06481 2.98357 9.21734 3.13611 9.31294 3.32373C9.35263 3.40162 9.38501 3.51337 9.40288 3.73209C9.42123 3.95666 9.42162 4.2472 9.42162 4.67468V8.26775V15.2533ZM10.4216 15.2533V8.76775H13.5147C13.9422 8.76775 14.2327 8.76814 14.4573 8.78648C14.676 8.80435 14.7877 8.83674 14.8656 8.87643C15.0533 8.97202 15.2058 9.12456 15.3014 9.31218C15.3411 9.39007 15.3735 9.50182 15.3913 9.72054C15.4097 9.94511 15.4101 10.2356 15.4101 10.6631V15.2533H10.4216ZM5.05616 4.77338C4.78002 4.77338 4.55616 4.99724 4.55616 5.27338C4.55616 5.54952 4.78002 5.77338 5.05616 5.77338H7.30183C7.57797 5.77338 7.80183 5.54952 7.80183 5.27338C7.80183 4.99724 7.57797 4.77338 7.30183 4.77338H5.05616ZM5.05616 7.76761C4.78002 7.76761 4.55616 7.99146 4.55616 8.26761C4.55616 8.54375 4.78002 8.76761 5.05616 8.76761H7.30183C7.57797 8.76761 7.80183 8.54375 7.80183 8.26761C7.80183 7.99146 7.57797 7.76761 7.30183 7.76761H5.05616ZM5.05616 10.7618C4.78002 10.7618 4.55616 10.9857 4.55616 11.2618C4.55616 11.538 4.78002 11.7618 5.05616 11.7618H7.30183C7.57797 11.7618 7.80183 11.538 7.80183 11.2618C7.80183 10.9857 7.57797 10.7618 7.30183 10.7618H5.05616Z",fill:"currentColor"},null,-1)])])}const nn=be(Yi,[["render",tn]]),sn=Ri("sidebar",()=>{const t=E(!0),e=Di("sidebar_is_expanded",!0),i=Li(()=>e.value?"224px":"50px");function n(r){t.value=r??!t.value}function o(r){e.value=r??!e.value}return{isExpanded:e,isOpen:t,toggle:n,toggleExpanded:o,width:i}}),Tr=Ae({__name:"SidebarLink",props:{icon:{},label:{},isExpanded:{type:Boolean},isActive:{type:Boolean,default:!1},onClick:{type:Function,default:()=>()=>!0},to:{default:""},bgColor:{default:"bg-white"},hvColor:{default:"hover:bg-gray-100"}},setup(t){const e=t,i=Mi(),{isMobileView:n}=Oi();function o(){if(e.onClick(),!!e.to&&!(e.to===i.currentRoute.value.name&&!i.currentRoute.value.query.view)){if(typeof e.to=="string"){i.push({name:e.to});return}i.push(e.to)}}return(r,s)=>{const a=qe("Tooltip");return k(),R("div",{class:se(["-all flex h-7 cursor-pointer items-center rounded pl-2 pr-1 text-gray-800 duration-300 ease-in-out",{"w-full":t.isExpanded,"w-8":!t.isExpanded,"shadow-sm":t.isActive,[t.bgColor]:t.isActive,[t.hvColor]:!t.isActive}]),onClick:o},[t.isExpanded?(k(),R("span",{key:1,class:se(["shrink-0 text-gray-700",{"text-gray-900":!t.isExpanded,"icon-emoji":w(n)}])},[(k(),me(Pt(t.icon),{class:"h-4 w-4"}))],2)):(k(),me(a,{key:0,text:t.label},{default:q(()=>[v("span",{class:se(["shrink-0 text-gray-700",{"text-gray-900":!t.isExpanded,"icon-emoji":w(n)}])},[(k(),me(Pt(t.icon),{class:"h-4 w-4"}))],2)]),_:1},8,["text"])),v("div",{class:se(["-all ml-2 flex shrink-0 grow items-center justify-between text-sm duration-300 ease-in-out",{"opacity-100":t.isExpanded,"opacity-0":!t.isExpanded,"-z-50":!t.isExpanded}])},[$i(H(t.label)+" ",1),Qt(r.$slots,"right")],2)],2)}}}),on={},rn={width:"118",height:"118",viewBox:"0 0 118 118",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function an(t,e){return k(),R("svg",rn,[...e[0]||(e[0]=[v("path",{d:"M93.9278 0H23.1013C10.3428 0 0 10.3428 0 23.1013V93.9278C0 106.686 10.3428 117.029 23.1013 117.029H93.9278C106.686 117.029 117.029 106.686 117.029 93.9278V23.1013C117.029 10.3428 106.686 0 93.9278 0Z",fill:"#7D42FB"},null,-1),v("path",{d:"M95.9759 50.8753V27.8265L21 27.8265V38.3271H85.5278V48.3027C81.3275 49.5103 78.2824 53.3955 78.2824 57.9632C78.2824 62.531 81.3275 66.3637 85.5278 67.5713V77.5468H31.5006V50.1403H21V88.0474H96.0284V64.9986L89.7805 60.5359V55.3906L96.0284 50.9278L95.9759 50.8753Z",fill:"#EDF7FF"},null,-1)])])}const cn=be(on,[["render",an]]),ln=["src"],un=Ae({__name:"BrandLogo",setup(t){const e=Yt();return(i,n)=>w(e).brandLogo?(k(),R("img",{key:0,src:w(e).brandLogo,alt:"Brand Logo",class:"h-8 w-8 shrink-0 object-cover"},null,8,ln)):(k(),me(cn,{key:1,class:"h-8 w-8 shrink-0 rounded"}))}}),dn={class:"text-base font-medium leading-none text-gray-900 truncate"},hn={class:"mt-1 text-sm leading-none text-gray-700"},xr=Ae({__name:"UserMenu",props:{options:{type:Array,required:!0}},setup(t){const e=Yt(),i=ji(),n=sn();return(o,r)=>{const s=qe("FeatherIcon");return k(),me(w(Ji),{options:t.options},{default:q(({open:a})=>[v("button",{class:se(["flex h-12 items-center rounded-md p-1 duration-300 ease-in-out w-full",a?" bg-white shadow-sm":" hover:bg-gray-200"])},[I(un),v("div",{class:se(["flex flex-1 flex-col text-left duration-300 ease-in-out overflow-hidden",w(n).isExpanded?"ml-2 w-auto opacity-100":"ml-0 w-0 overflow-hidden opacity-0"])},[v("div",dn,H(w(e).brandName||"Helpdesk"),1),v("div",hn,H(w(i).userName),1)],2),v("div",{class:se(["duration-300 ease-in-out",w(n).isExpanded?"ml-2 w-auto opacity-100":"ml-0 w-0 overflow-hidden opacity-0"])},[I(s,{name:"chevron-down",class:"h-4 w-4 text-gray-600","aria-hidden":"true"})],2)],2)]),_:1},8,["options"])}}}),pn={class:"lucide lucide-layout-dashboard",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"};function fn(t,e){return k(),R("svg",pn,[...e[0]||(e[0]=[v("rect",{width:"7",height:"9",x:"3",y:"3",rx:"1"},null,-1),v("rect",{width:"7",height:"5",x:"14",y:"3",rx:"1"},null,-1),v("rect",{width:"7",height:"9",x:"14",y:"12",rx:"1"},null,-1),v("rect",{width:"7",height:"5",x:"3",y:"16",rx:"1"},null,-1)])])}const kr=ze({name:"lucide-layout-dashboard",render:fn}),mn={},gn={fill:"none",height:"16",viewBox:"0 0 16 16",width:"16",xmlns:"http://www.w3.org/2000/svg"};function _n(t,e){return k(),R("svg",gn,[...e[0]||(e[0]=[v("path",{class:"","clip-rule":"evenodd",d:"M13.8496 4.69692L12.0062 6.54029C11.8109 6.73555 11.4944 6.73555 11.2991 6.54028L9.45572 4.69692C9.26046 4.50166 9.26046 4.18508 9.45572 3.98981L11.2991 2.14645C11.4944 1.95118 11.8109 1.95118 12.0062 2.14645L13.8496 3.98981C14.0448 4.18507 14.0448 4.50166 13.8496 4.69692ZM14.5567 3.28271C15.1425 3.86849 15.1425 4.81824 14.5567 5.40403L12.7133 7.24739C12.1275 7.83318 11.1778 7.83318 10.592 7.24739L8.74862 5.40402C8.16283 4.81824 8.16283 3.86849 8.74862 3.28271L10.592 1.43934C11.1778 0.853553 12.1275 0.853554 12.7133 1.43934L14.5567 3.28271ZM5.60691 4.34338C5.60691 5.3394 4.79948 6.14683 3.80346 6.14683C2.80743 6.14683 2 5.3394 2 4.34338C2 3.34736 2.80743 2.53992 3.80346 2.53992C4.79948 2.53992 5.60691 3.34736 5.60691 4.34338ZM6.60691 4.34338C6.60691 5.89168 5.35176 7.14683 3.80346 7.14683C2.25515 7.14683 1 5.89168 1 4.34338C1 2.79507 2.25515 1.53992 3.80346 1.53992C5.35176 1.53992 6.60691 2.79507 6.60691 4.34338ZM12.9565 10.3897H10.3495C10.0734 10.3897 9.84954 10.6136 9.84954 10.8897V13.4966C9.84954 13.7728 10.0734 13.9966 10.3495 13.9966H12.9565C13.2326 13.9966 13.4565 13.7728 13.4565 13.4966V10.8897C13.4565 10.6136 13.2326 10.3897 12.9565 10.3897ZM10.3495 9.38971C9.52112 9.38971 8.84954 10.0613 8.84954 10.8897V13.4966C8.84954 14.325 9.52111 14.9966 10.3495 14.9966H12.9565C13.7849 14.9966 14.4565 14.325 14.4565 13.4966V10.8897C14.4565 10.0613 13.7849 9.38971 12.9565 9.38971H10.3495ZM2.5 10.3897H5.10691C5.38305 10.3897 5.60691 10.6136 5.60691 10.8897V13.4966C5.60691 13.7728 5.38306 13.9966 5.10691 13.9966H2.5C2.22386 13.9966 2 13.7728 2 13.4966V10.8897C2 10.6136 2.22386 10.3897 2.5 10.3897ZM1 10.8897C1 10.0613 1.67157 9.38971 2.5 9.38971H5.10691C5.93534 9.38971 6.60691 10.0613 6.60691 10.8897V13.4966C6.60691 14.325 5.93534 14.9966 5.10691 14.9966H2.5C1.67157 14.9966 1 14.325 1 13.4966V10.8897Z",fill:"currentColor","fill-rule":"evenodd"},null,-1)])])}const vn=be(mn,[["render",_n]]),yn=["onClick"],bn={class:"flex gap-2"},Sn={class:"flex flex-col justify-between mx-3 p-1.5 rounded-lg border border-gray-100 bg-white shadow-xl"},wn={key:"name"},Cn=["href"],Tn=["src"],xn=["onClick"],Ir={__name:"Apps",setup(t){const e=Ui({url:"frappe.apps.get_apps",cache:"apps",auto:!0,transform:i=>{let n=[{name:"frappe",logo:"/assets/helpdesk/desk/desk.png",title:"Desk",route:"/desk/helpdesk"}];return i.map(o=>{o.name!=="helpdesk"&&n.push({name:o.name,logo:o.logo,title:o.title,route:o.route})}),n}});return(i,n)=>(k(),me(w(Ni),{placement:"right-start",class:"flex w-full",trigger:"hover",hoverDelay:.1,leaveDelay:.1},{target:q(({togglePopover:o})=>[v("button",{class:se(["group w-full flex h-7 items-center justify-between rounded px-2 text-base text-gray-800 hover:bg-gray-100"]),onClick:Me(r=>o(),["prevent"])},[v("div",bn,[I(vn),n[0]||(n[0]=v("span",{class:"whitespace-nowrap"},"Apps",-1))]),I(w(Ki),{class:"h-4 w-4 stroke-1.5"})],8,yn)]),body:q(()=>[v("div",Sn,[(k(!0),R(ut,null,Fi(w(e).data,o=>(k(),R("div",wn,[v("a",{href:o.route,class:"flex gap-2 rounded items-center hover:bg-gray-100 p-1.5"},[v("img",{class:"size-6",src:o.logo},null,8,Tn),v("div",{class:"text-sm",onClick:o.onClick},H(o.title),9,xn)],8,Cn)]))),128))])]),_:1}))}},kn={class:"lucide lucide-cloud-lightning",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"};function In(t,e){return k(),R("svg",kn,[...e[0]||(e[0]=[v("path",{d:"M6 16.326A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 .5 8.973"},null,-1),v("path",{d:"m13 12-3 5h4l-3 5"},null,-1)])])}const En=ze({name:"lucide-cloud-lightning",render:In}),Pn={class:"lucide lucide-contact-round",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"};function An(t,e){return k(),R("svg",Pn,[...e[0]||(e[0]=[Vi('<path d="M16 2v2"></path><path d="M17.915 22a6 6 0 0 0-12 0"></path><path d="M8 2v2"></path><circle cx="12" cy="12" r="4"></circle><rect x="3" y="4" width="18" height="18" rx="2"></rect>',5)])])}const Rn=ze({name:"lucide-contact-2",render:An}),Er=[{label:fe("Tickets"),icon:oi,to:"TicketsAgent"},{label:fe("Knowledge Base"),icon:ri,to:"AgentKnowledgeBase"},{label:fe("Canned Responses"),icon:En,to:"CannedResponses"},{label:fe("Customers"),icon:nn,to:"CustomerList"},{label:fe("Contacts"),icon:Rn,to:"ContactList"},{label:fe("Call Logs"),icon:Xi,to:"CallLogs"}],Pr=[{label:fe("Tickets"),icon:oi,to:"TicketsCustomer"},{label:fe("Knowledge Base"),icon:ri,to:"CustomerKnowledgeBase"}];var ht={exports:{}},Ie=typeof Reflect=="object"?Reflect:null,Rt=Ie&&typeof Ie.apply=="function"?Ie.apply:function(e,i,n){return Function.prototype.apply.call(e,i,n)},Ue;Ie&&typeof Ie.ownKeys=="function"?Ue=Ie.ownKeys:Object.getOwnPropertySymbols?Ue=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Ue=function(e){return Object.getOwnPropertyNames(e)};function Dn(t){console&&console.warn&&console.warn(t)}var ai=Number.isNaN||function(e){return e!==e};function O(){O.init.call(this)}ht.exports=O;ht.exports.once=$n;O.EventEmitter=O;O.prototype._events=void 0;O.prototype._eventsCount=0;O.prototype._maxListeners=void 0;var Dt=10;function Je(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(O,"defaultMaxListeners",{enumerable:!0,get:function(){return Dt},set:function(t){if(typeof t!="number"||t<0||ai(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");Dt=t}});O.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};O.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||ai(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function ci(t){return t._maxListeners===void 0?O.defaultMaxListeners:t._maxListeners}O.prototype.getMaxListeners=function(){return ci(this)};O.prototype.emit=function(e){for(var i=[],n=1;n<arguments.length;n++)i.push(arguments[n]);var o=e==="error",r=this._events;if(r!==void 0)o=o&&r.error===void 0;else if(!o)return!1;if(o){var s;if(i.length>0&&(s=i[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var l=r[e];if(l===void 0)return!1;if(typeof l=="function")Rt(l,this,i);else for(var c=l.length,u=pi(l,c),n=0;n<c;++n)Rt(u[n],this,i);return!0};function li(t,e,i,n){var o,r,s;if(Je(i),r=t._events,r===void 0?(r=t._events=Object.create(null),t._eventsCount=0):(r.newListener!==void 0&&(t.emit("newListener",e,i.listener?i.listener:i),r=t._events),s=r[e]),s===void 0)s=r[e]=i,++t._eventsCount;else if(typeof s=="function"?s=r[e]=n?[i,s]:[s,i]:n?s.unshift(i):s.push(i),o=ci(t),o>0&&s.length>o&&!s.warned){s.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=t,a.type=e,a.count=s.length,Dn(a)}return t}O.prototype.addListener=function(e,i){return li(this,e,i,!1)};O.prototype.on=O.prototype.addListener;O.prototype.prependListener=function(e,i){return li(this,e,i,!0)};function Ln(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function ui(t,e,i){var n={fired:!1,wrapFn:void 0,target:t,type:e,listener:i},o=Ln.bind(n);return o.listener=i,n.wrapFn=o,o}O.prototype.once=function(e,i){return Je(i),this.on(e,ui(this,e,i)),this};O.prototype.prependOnceListener=function(e,i){return Je(i),this.prependListener(e,ui(this,e,i)),this};O.prototype.removeListener=function(e,i){var n,o,r,s,a;if(Je(i),o=this._events,o===void 0)return this;if(n=o[e],n===void 0)return this;if(n===i||n.listener===i)--this._eventsCount===0?this._events=Object.create(null):(delete o[e],o.removeListener&&this.emit("removeListener",e,n.listener||i));else if(typeof n!="function"){for(r=-1,s=n.length-1;s>=0;s--)if(n[s]===i||n[s].listener===i){a=n[s].listener,r=s;break}if(r<0)return this;r===0?n.shift():Mn(n,r),n.length===1&&(o[e]=n[0]),o.removeListener!==void 0&&this.emit("removeListener",e,a||i)}return this};O.prototype.off=O.prototype.removeListener;O.prototype.removeAllListeners=function(e){var i,n,o;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var r=Object.keys(n),s;for(o=0;o<r.length;++o)s=r[o],s!=="removeListener"&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(i=n[e],typeof i=="function")this.removeListener(e,i);else if(i!==void 0)for(o=i.length-1;o>=0;o--)this.removeListener(e,i[o]);return this};function di(t,e,i){var n=t._events;if(n===void 0)return[];var o=n[e];return o===void 0?[]:typeof o=="function"?i?[o.listener||o]:[o]:i?On(o):pi(o,o.length)}O.prototype.listeners=function(e){return di(this,e,!0)};O.prototype.rawListeners=function(e){return di(this,e,!1)};O.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):hi.call(t,e)};O.prototype.listenerCount=hi;function hi(t){var e=this._events;if(e!==void 0){var i=e[t];if(typeof i=="function")return 1;if(i!==void 0)return i.length}return 0}O.prototype.eventNames=function(){return this._eventsCount>0?Ue(this._events):[]};function pi(t,e){for(var i=new Array(e),n=0;n<e;++n)i[n]=t[n];return i}function Mn(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function On(t){for(var e=new Array(t.length),i=0;i<e.length;++i)e[i]=t[i].listener||t[i];return e}function $n(t,e){return new Promise(function(i,n){function o(s){t.removeListener(e,r),n(s)}function r(){typeof t.removeListener=="function"&&t.removeListener("error",o),i([].slice.call(arguments))}fi(t,e,r,{once:!0}),e!=="error"&&jn(t,o,{once:!0})})}function jn(t,e,i){typeof t.on=="function"&&fi(t,"error",e,i)}function fi(t,e,i,n){if(typeof t.on=="function")n.once?t.once(e,i):t.on(e,i);else if(typeof t.addEventListener=="function")t.addEventListener(e,function o(r){n.once&&t.removeEventListener(e,o),i(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}var ie=ht.exports;class et extends ie.EventEmitter{constructor(e){super(),Object.defineProperties(this,{_attempts:{value:0,writable:!0},_duration:{enumerable:!1,get(){let i=this._min*Math.pow(this._factor,this._attempts);if(this._jitter){const n=Math.random(),o=Math.floor(n*this._jitter*i);i=Math.floor(n*10)&1?i+o:i-o}return Math.min(i,this._max)|0}},_factor:{value:e.factor||2},_jitter:{value:e.jitter>0&&e.jitter<=1?e.jitter:0},_max:{value:e.max||1e4},_min:{value:e.min||100},_timeoutID:{value:null,writable:!0}})}backoff(){const e=this._duration;this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=null),this.emit("backoff",this._attempts,e),this._timeoutID=setTimeout(()=>{this.emit("ready",this._attempts,e),this._attempts++},e)}reset(){this._attempts=0,this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=null)}}function K(t,e,i,n){function o(r){return r instanceof i?r:new i(function(s){s(r)})}return new(i||(i=Promise))(function(r,s){function a(u){try{c(n.next(u))}catch(d){s(d)}}function l(u){try{c(n.throw(u))}catch(d){s(d)}}function c(u){u.done?r(u.value):o(u.value).then(a,l)}c((n=n.apply(t,e||[])).next())})}var mi={exports:{}};(function(t){(function(e,i){t.exports?t.exports=i():e.log=i()})(Hi,function(){var e=function(){},i="undefined",n=typeof window!==i&&typeof window.navigator!==i&&/Trident\/|MSIE /.test(window.navigator.userAgent),o=["trace","debug","info","warn","error"],r={},s=null;function a(g,_){var y=g[_];if(typeof y.bind=="function")return y.bind(g);try{return Function.prototype.bind.call(y,g)}catch{return function(){return Function.prototype.apply.apply(y,[g,arguments])}}}function l(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(g){return g==="debug"&&(g="log"),typeof console===i?!1:g==="trace"&&n?l:console[g]!==void 0?a(console,g):console.log!==void 0?a(console,"log"):e}function u(){for(var g=this.getLevel(),_=0;_<o.length;_++){var y=o[_];this[y]=_<g?e:this.methodFactory(y,g,this.name)}if(this.log=this.debug,typeof console===i&&g<this.levels.SILENT)return"No console available for logging"}function d(g){return function(){typeof console!==i&&(u.call(this),this[g].apply(this,arguments))}}function h(g,_,y){return c(g)||d.apply(this,arguments)}function m(g,_){var y=this,M,V,U,J="loglevel";typeof g=="string"?J+=":"+g:typeof g=="symbol"&&(J=void 0);function Re(T){var F=(o[T]||"silent").toUpperCase();if(!(typeof window===i||!J)){try{window.localStorage[J]=F;return}catch{}try{window.document.cookie=encodeURIComponent(J)+"="+F+";"}catch{}}}function ue(){var T;if(!(typeof window===i||!J)){try{T=window.localStorage[J]}catch{}if(typeof T===i)try{var F=window.document.cookie,X=encodeURIComponent(J),de=F.indexOf(X+"=");de!==-1&&(T=/^([^;]+)/.exec(F.slice(de+X.length+1))[1])}catch{}return y.levels[T]===void 0&&(T=void 0),T}}function ge(){if(!(typeof window===i||!J)){try{window.localStorage.removeItem(J)}catch{}try{window.document.cookie=encodeURIComponent(J)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function ae(T){var F=T;if(typeof F=="string"&&y.levels[F.toUpperCase()]!==void 0&&(F=y.levels[F.toUpperCase()]),typeof F=="number"&&F>=0&&F<=y.levels.SILENT)return F;throw new TypeError("log.setLevel() called with invalid level: "+T)}y.name=g,y.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},y.methodFactory=_||h,y.getLevel=function(){return U??V??M},y.setLevel=function(T,F){return U=ae(T),F!==!1&&Re(U),u.call(y)},y.setDefaultLevel=function(T){V=ae(T),ue()||y.setLevel(T,!1)},y.resetLevel=function(){U=null,ge(),u.call(y)},y.enableAll=function(T){y.setLevel(y.levels.TRACE,T)},y.disableAll=function(T){y.setLevel(y.levels.SILENT,T)},y.rebuild=function(){if(s!==y&&(M=ae(s.getLevel())),u.call(y),s===y)for(var T in r)r[T].rebuild()},M=ae(s?s.getLevel():"WARN");var S=ue();S!=null&&(U=ae(S)),u.call(y)}s=new m,s.getLogger=function(_){if(typeof _!="symbol"&&typeof _!="string"||_==="")throw new TypeError("You must supply a name when creating a logger.");var y=r[_];return y||(y=r[_]=new m(_,s.methodFactory)),y};var b=typeof window!==i?window.log:void 0;return s.noConflict=function(){return typeof window!==i&&window.log===s&&(window.log=b),s},s.getLoggers=function(){return r},s.default=s,s})})(mi);var $e=mi.exports;const Un=Wi($e),Fn=Qi({__proto__:null,default:Un},[$e]);class x extends Error{constructor(e,i){super(),Object.setPrototypeOf(this,x.prototype);const n=typeof e=="string"?e:this.explanation,o=typeof e=="object"?e:i;this.message=`${this.name} (${this.code}): ${n}`,this.originalError=o}}var W;(function(t){class e extends x{constructor(r,s){super(r,s),this.causes=[],this.code=20101,this.description="Invalid access token",this.explanation="Twilio was unable to validate your Access Token",this.name="AccessTokenInvalid",this.solutions=[],Object.setPrototypeOf(this,t.AccessTokenInvalid.prototype);const a=typeof r=="string"?r:this.explanation,l=typeof r=="object"?r:s;this.message=`${this.name} (${this.code}): ${a}`,this.originalError=l}}t.AccessTokenInvalid=e;class i extends x{constructor(r,s){super(r,s),this.causes=[],this.code=20104,this.description="Access token expired or expiration date invalid",this.explanation="The Access Token provided to the Twilio API has expired, the expiration time specified in the token was invalid, or the expiration time specified was too far in the future",this.name="AccessTokenExpired",this.solutions=[],Object.setPrototypeOf(this,t.AccessTokenExpired.prototype);const a=typeof r=="string"?r:this.explanation,l=typeof r=="object"?r:s;this.message=`${this.name} (${this.code}): ${a}`,this.originalError=l}}t.AccessTokenExpired=i;class n extends x{constructor(r,s){super(r,s),this.causes=[],this.code=20151,this.description="Authentication Failed",this.explanation="The Authentication with the provided JWT failed",this.name="AuthenticationFailed",this.solutions=[],Object.setPrototypeOf(this,t.AuthenticationFailed.prototype);const a=typeof r=="string"?r:this.explanation,l=typeof r=="object"?r:s;this.message=`${this.name} (${this.code}): ${a}`,this.originalError=l}}t.AuthenticationFailed=n})(W||(W={}));var tt;(function(t){class e extends x{constructor(n,o){super(n,o),this.causes=["The access token has an invalid Account SID, API Key, or API Key Secret."],this.code=31202,this.description="Signature validation failed.",this.explanation="The provided access token failed signature validation.",this.name="AccessTokenSignatureValidationFailed",this.solutions=["Ensure the Account SID, API Key, and API Key Secret are valid when generating your access token."],Object.setPrototypeOf(this,t.AccessTokenSignatureValidationFailed.prototype);const r=typeof n=="string"?n:this.explanation,s=typeof n=="object"?n:o;this.message=`${this.name} (${this.code}): ${r}`,this.originalError=s}}t.AccessTokenSignatureValidationFailed=e})(tt||(tt={}));var ve;(function(t){class e extends x{constructor(s,a){super(s,a),this.causes=[],this.code=31400,this.description="Bad Request (HTTP/SIP)",this.explanation="The request could not be understood due to malformed syntax.",this.name="BadRequest",this.solutions=[],Object.setPrototypeOf(this,t.BadRequest.prototype);const l=typeof s=="string"?s:this.explanation,c=typeof s=="object"?s:a;this.message=`${this.name} (${this.code}): ${l}`,this.originalError=c}}t.BadRequest=e;class i extends x{constructor(s,a){super(s,a),this.causes=["The outbound call was made to an invalid phone number.","The TwiML application sid is missing a Voice URL."],this.code=31404,this.description="Not Found (HTTP/SIP)",this.explanation="The server has not found anything matching the request.",this.name="NotFound",this.solutions=["Ensure the phone number dialed is valid.","Ensure the TwiML application is configured correctly with a Voice URL link."],Object.setPrototypeOf(this,t.NotFound.prototype);const l=typeof s=="string"?s:this.explanation,c=typeof s=="object"?s:a;this.message=`${this.name} (${this.code}): ${l}`,this.originalError=c}}t.NotFound=i;class n extends x{constructor(s,a){super(s,a),this.causes=[],this.code=31480,this.description="Temporarily Unavailable (SIP)",this.explanation="The callee is currently unavailable.",this.name="TemporarilyUnavailable",this.solutions=[],Object.setPrototypeOf(this,t.TemporarilyUnavailable.prototype);const l=typeof s=="string"?s:this.explanation,c=typeof s=="object"?s:a;this.message=`${this.name} (${this.code}): ${l}`,this.originalError=c}}t.TemporarilyUnavailable=n;class o extends x{constructor(s,a){super(s,a),this.causes=[],this.code=31486,this.description="Busy Here (SIP)",this.explanation="The callee is busy.",this.name="BusyHere",this.solutions=[],Object.setPrototypeOf(this,t.BusyHere.prototype);const l=typeof s=="string"?s:this.explanation,c=typeof s=="object"?s:a;this.message=`${this.name} (${this.code}): ${l}`,this.originalError=c}}t.BusyHere=o})(ve||(ve={}));var it;(function(t){class e extends x{constructor(n,o){super(n,o),this.causes=[],this.code=31603,this.description="Decline (SIP)",this.explanation="The callee does not wish to participate in the call.",this.name="Decline",this.solutions=[],Object.setPrototypeOf(this,t.Decline.prototype);const r=typeof n=="string"?n:this.explanation,s=typeof n=="object"?n:o;this.message=`${this.name} (${this.code}): ${r}`,this.originalError=s}}t.Decline=e})(it||(it={}));var z;(function(t){class e extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31e3,this.description="Unknown Error",this.explanation="An unknown error has occurred. See error details for more information.",this.name="UnknownError",this.solutions=[],Object.setPrototypeOf(this,t.UnknownError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.UnknownError=e;class i extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31001,this.description="Application Not Found",this.explanation="",this.name="ApplicationNotFoundError",this.solutions=[],Object.setPrototypeOf(this,t.ApplicationNotFoundError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.ApplicationNotFoundError=i;class n extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31002,this.description="Connection Declined",this.explanation="",this.name="ConnectionDeclinedError",this.solutions=[],Object.setPrototypeOf(this,t.ConnectionDeclinedError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.ConnectionDeclinedError=n;class o extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31003,this.description="Connection Timeout",this.explanation="The server could not produce a response within a suitable amount of time.",this.name="ConnectionTimeoutError",this.solutions=[],Object.setPrototypeOf(this,t.ConnectionTimeoutError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.ConnectionTimeoutError=o;class r extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31005,this.description="Connection error",this.explanation="A connection error occurred during the call",this.name="ConnectionError",this.solutions=[],Object.setPrototypeOf(this,t.ConnectionError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.ConnectionError=r;class s extends x{constructor(c,u){super(c,u),this.causes=["The incoming call was cancelled because it was not answered in time or it was accepted/rejected by another application instance registered with the same identity."],this.code=31008,this.description="Call cancelled",this.explanation="Unable to answer because the call has ended",this.name="CallCancelledError",this.solutions=[],Object.setPrototypeOf(this,t.CallCancelledError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.CallCancelledError=s;class a extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31009,this.description="Transport error",this.explanation="No transport available to send or receive messages",this.name="TransportError",this.solutions=[],Object.setPrototypeOf(this,t.TransportError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.TransportError=a})(z||(z={}));var ce;(function(t){class e extends x{constructor(c,u){super(c,u),this.causes=["Invalid content or MessageType passed to sendMessage method."],this.code=31100,this.description="The request had malformed syntax.",this.explanation="The request could not be understood due to malformed syntax.",this.name="MalformedRequestError",this.solutions=["Ensure content and MessageType passed to sendMessage method are valid."],Object.setPrototypeOf(this,t.MalformedRequestError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.MalformedRequestError=e;class i extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31101,this.description="Missing parameter array in request",this.explanation="",this.name="MissingParameterArrayError",this.solutions=[],Object.setPrototypeOf(this,t.MissingParameterArrayError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.MissingParameterArrayError=i;class n extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31102,this.description="Authorization token missing in request.",this.explanation="",this.name="AuthorizationTokenMissingError",this.solutions=[],Object.setPrototypeOf(this,t.AuthorizationTokenMissingError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.AuthorizationTokenMissingError=n;class o extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31103,this.description="Maximum parameter length has been exceeded.",this.explanation="Length of parameters cannot exceed MAX_PARAM_LENGTH.",this.name="MaxParameterLengthExceededError",this.solutions=[],Object.setPrototypeOf(this,t.MaxParameterLengthExceededError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.MaxParameterLengthExceededError=o;class r extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31104,this.description="Invalid bridge token",this.explanation="",this.name="InvalidBridgeTokenError",this.solutions=[],Object.setPrototypeOf(this,t.InvalidBridgeTokenError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.InvalidBridgeTokenError=r;class s extends x{constructor(c,u){super(c,u),this.causes=["Client name contains invalid characters."],this.code=31105,this.description="Invalid client name",this.explanation="Client name should not contain control, space, delims, or unwise characters.",this.name="InvalidClientNameError",this.solutions=["Make sure that client name does not contain any of the invalid characters."],Object.setPrototypeOf(this,t.InvalidClientNameError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.InvalidClientNameError=s;class a extends x{constructor(c,u){super(c,u),this.causes=[],this.code=31107,this.description="The reconnect parameter is invalid",this.explanation="",this.name="ReconnectParameterInvalidError",this.solutions=[],Object.setPrototypeOf(this,t.ReconnectParameterInvalidError.prototype);const d=typeof c=="string"?c:this.explanation,h=typeof c=="object"?c:u;this.message=`${this.name} (${this.code}): ${d}`,this.originalError=h}}t.ReconnectParameterInvalidError=a})(ce||(ce={}));(function(t){class e extends x{constructor(d,h){super(d,h),this.causes=[],this.code=31201,this.description="Authorization error",this.explanation="The request requires user authentication. The server understood the request, but is refusing to fulfill it.",this.name="AuthorizationError",this.solutions=[],Object.setPrototypeOf(this,t.AuthorizationError.prototype);const m=typeof d=="string"?d:this.explanation,b=typeof d=="object"?d:h;this.message=`${this.name} (${this.code}): ${m}`,this.originalError=b}}t.AuthorizationError=e;class i extends x{constructor(d,h){super(d,h),this.causes=[],this.code=31203,this.description="No valid account",this.explanation="",this.name="NoValidAccountError",this.solutions=[],Object.setPrototypeOf(this,t.NoValidAccountError.prototype);const m=typeof d=="string"?d:this.explanation,b=typeof d=="object"?d:h;this.message=`${this.name} (${this.code}): ${m}`,this.originalError=b}}t.NoValidAccountError=i;class n extends x{constructor(d,h){super(d,h),this.causes=[],this.code=31204,this.description="Invalid JWT token",this.explanation="",this.name="InvalidJWTTokenError",this.solutions=[],Object.setPrototypeOf(this,t.InvalidJWTTokenError.prototype);const m=typeof d=="string"?d:this.explanation,b=typeof d=="object"?d:h;this.message=`${this.name} (${this.code}): ${m}`,this.originalError=b}}t.InvalidJWTTokenError=n;class o extends x{constructor(d,h){super(d,h),this.causes=[],this.code=31205,this.description="JWT token expired",this.explanation="",this.name="JWTTokenExpiredError",this.solutions=[],Object.setPrototypeOf(this,t.JWTTokenExpiredError.prototype);const m=typeof d=="string"?d:this.explanation,b=typeof d=="object"?d:h;this.message=`${this.name} (${this.code}): ${m}`,this.originalError=b}}t.JWTTokenExpiredError=o;class r extends x{constructor(d,h){super(d,h),this.causes=["Rate limit exceeded."],this.code=31206,this.description="Rate exceeded authorized limit.",this.explanation="The request performed exceeds the authorized limit.",this.name="RateExceededError",this.solutions=["Ensure message send rate does not exceed authorized limits."],Object.setPrototypeOf(this,t.RateExceededError.prototype);const m=typeof d=="string"?d:this.explanation,b=typeof d=="object"?d:h;this.message=`${this.name} (${this.code}): ${m}`,this.originalError=b}}t.RateExceededError=r;class s extends x{constructor(d,h){super(d,h),this.causes=[],this.code=31207,this.description="JWT token expiration too long",this.explanation="",this.name="JWTTokenExpirationTooLongError",this.solutions=[],Object.setPrototypeOf(this,t.JWTTokenExpirationTooLongError.prototype);const m=typeof d=="string"?d:this.explanation,b=typeof d=="object"?d:h;this.message=`${this.name} (${this.code}): ${m}`,this.originalError=b}}t.JWTTokenExpirationTooLongError=s;class a extends x{constructor(d,h){super(d,h),this.causes=[],this.code=31209,this.description="Reconnect attempt is not authorized.",this.explanation="",this.name="ReconnectAttemptError",this.solutions=[],Object.setPrototypeOf(this,t.ReconnectAttemptError.prototype);const m=typeof d=="string"?d:this.explanation,b=typeof d=="object"?d:h;this.message=`${this.name} (${this.code}): ${m}`,this.originalError=b}}t.ReconnectAttemptError=a;class l extends x{constructor(d,h){super(d,h),this.causes=["The Call Message Event Type is invalid and is not understood by Twilio Voice."],this.code=31210,this.description="Call Message Event Type is invalid.",this.explanation="The Call Message Event Type is invalid and is not understood by Twilio Voice.",this.name="CallMessageEventTypeInvalidError",this.solutions=["Ensure the Call Message Event Type is Valid and understood by Twilio Voice and try again."],Object.setPrototypeOf(this,t.CallMessageEventTypeInvalidError.prototype);const m=typeof d=="string"?d:this.explanation,b=typeof d=="object"?d:h;this.message=`${this.name} (${this.code}): ${m}`,this.originalError=b}}t.CallMessageEventTypeInvalidError=l;class c extends x{constructor(d,h){super(d,h),this.causes=["The payload size of Call Message Event exceeds the authorized limit."],this.code=31212,this.description="Call Message Event Payload size exceeded authorized limit.",this.explanation="The request performed to send a Call Message Event exceeds the payload size authorized limit",this.name="PayloadSizeExceededError",this.solutions=["Reduce payload size of Call Message Event to be within the authorized limit and try again."],Object.setPrototypeOf(this,t.PayloadSizeExceededError.prototype);const m=typeof d=="string"?d:this.explanation,b=typeof d=="object"?d:h;this.message=`${this.name} (${this.code}): ${m}`,this.originalError=b}}t.PayloadSizeExceededError=c})(W||(W={}));var Pe;(function(t){class e extends x{constructor(o,r){super(o,r),this.causes=["The user denied the getUserMedia request.","The browser denied the getUserMedia request."],this.code=31401,this.description="UserMedia Permission Denied Error",this.explanation="The browser or end-user denied permissions to user media. Therefore we were unable to acquire input audio.",this.name="PermissionDeniedError",this.solutions=["The user should accept the request next time prompted. If the browser saved the deny, the user should change that permission in their browser.","The user should to verify that the browser has permission to access the microphone at this address."],Object.setPrototypeOf(this,t.PermissionDeniedError.prototype);const s=typeof o=="string"?o:this.explanation,a=typeof o=="object"?o:r;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=a}}t.PermissionDeniedError=e;class i extends x{constructor(o,r){super(o,r),this.causes=["NotFoundError - The deviceID specified was not found.","The getUserMedia constraints were overconstrained and no devices matched."],this.code=31402,this.description="UserMedia Acquisition Failed Error",this.explanation="The browser and end-user allowed permissions, however getting the media failed. Usually this is due to bad constraints, but can sometimes fail due to browser, OS or hardware issues.",this.name="AcquisitionFailedError",this.solutions=["Ensure the deviceID being specified exists.","Try acquiring media with fewer constraints."],Object.setPrototypeOf(this,t.AcquisitionFailedError.prototype);const s=typeof o=="string"?o:this.explanation,a=typeof o=="object"?o:r;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=a}}t.AcquisitionFailedError=i})(Pe||(Pe={}));var te;(function(t){class e extends x{constructor(o,r){super(o,r),this.causes=[],this.code=53e3,this.description="Signaling connection error",this.explanation="Raised whenever a signaling connection error occurs that is not covered by a more specific error code.",this.name="ConnectionError",this.solutions=[],Object.setPrototypeOf(this,t.ConnectionError.prototype);const s=typeof o=="string"?o:this.explanation,a=typeof o=="object"?o:r;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=a}}t.ConnectionError=e;class i extends x{constructor(o,r){super(o,r),this.causes=["The device running your application lost its Internet connection."],this.code=53001,this.description="Signaling connection disconnected",this.explanation="Raised whenever the signaling connection is unexpectedly disconnected.",this.name="ConnectionDisconnected",this.solutions=["Ensure the device running your application has access to a stable Internet connection."],Object.setPrototypeOf(this,t.ConnectionDisconnected.prototype);const s=typeof o=="string"?o:this.explanation,a=typeof o=="object"?o:r;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=a}}t.ConnectionDisconnected=i})(te||(te={}));var re;(function(t){class e extends x{constructor(r,s){super(r,s),this.causes=["The Client may not be using a supported WebRTC implementation.","The Client may not have the necessary resources to create or apply a new media description."],this.code=53400,this.description="Client is unable to create or apply a local media description",this.explanation="Raised whenever a Client is unable to create or apply a local media description.",this.name="ClientLocalDescFailed",this.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation."],Object.setPrototypeOf(this,t.ClientLocalDescFailed.prototype);const a=typeof r=="string"?r:this.explanation,l=typeof r=="object"?r:s;this.message=`${this.name} (${this.code}): ${a}`,this.originalError=l}}t.ClientLocalDescFailed=e;class i extends x{constructor(r,s){super(r,s),this.causes=["The Client may not be using a supported WebRTC implementation.","The Client may be connecting peer-to-peer with another Participant that is not using a supported WebRTC implementation.","The Client may not have the necessary resources to apply a new media description."],this.code=53402,this.description="Client is unable to apply a remote media description",this.explanation="Raised whenever the Client receives a remote media description but is unable to apply it.",this.name="ClientRemoteDescFailed",this.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation."],Object.setPrototypeOf(this,t.ClientRemoteDescFailed.prototype);const a=typeof r=="string"?r:this.explanation,l=typeof r=="object"?r:s;this.message=`${this.name} (${this.code}): ${a}`,this.originalError=l}}t.ClientRemoteDescFailed=i;class n extends x{constructor(r,s){super(r,s),this.causes=["The Client was unable to establish a media connection.","A media connection which was active failed liveliness checks."],this.code=53405,this.description="Media connection failed",this.explanation="Raised by the Client or Server whenever a media connection fails.",this.name="ConnectionError",this.solutions=["If the problem persists, try connecting to another region.","Check your Client's network connectivity.","If you've provided custom ICE Servers then ensure that the URLs and credentials are valid."],Object.setPrototypeOf(this,t.ConnectionError.prototype);const a=typeof r=="string"?r:this.explanation,l=typeof r=="object"?r:s;this.message=`${this.name} (${this.code}): ${a}`,this.originalError=l}}t.ConnectionError=n})(re||(re={}));const pt=new Map([[20101,W.AccessTokenInvalid],[20104,W.AccessTokenExpired],[20151,W.AuthenticationFailed],[31202,tt.AccessTokenSignatureValidationFailed],[31400,ve.BadRequest],[31404,ve.NotFound],[31480,ve.TemporarilyUnavailable],[31486,ve.BusyHere],[31603,it.Decline],[31e3,z.UnknownError],[31001,z.ApplicationNotFoundError],[31002,z.ConnectionDeclinedError],[31003,z.ConnectionTimeoutError],[31005,z.ConnectionError],[31008,z.CallCancelledError],[31009,z.TransportError],[31100,ce.MalformedRequestError],[31101,ce.MissingParameterArrayError],[31102,ce.AuthorizationTokenMissingError],[31103,ce.MaxParameterLengthExceededError],[31104,ce.InvalidBridgeTokenError],[31105,ce.InvalidClientNameError],[31107,ce.ReconnectParameterInvalidError],[31201,W.AuthorizationError],[31203,W.NoValidAccountError],[31204,W.InvalidJWTTokenError],[31205,W.JWTTokenExpiredError],[31206,W.RateExceededError],[31207,W.JWTTokenExpirationTooLongError],[31209,W.ReconnectAttemptError],[31210,W.CallMessageEventTypeInvalidError],[31212,W.PayloadSizeExceededError],[31401,Pe.PermissionDeniedError],[31402,Pe.AcquisitionFailedError],[53e3,te.ConnectionError],[53001,te.ConnectionDisconnected],[53400,re.ClientLocalDescFailed],[53402,re.ClientRemoteDescFailed],[53405,re.ConnectionError]]);Object.freeze(pt);const Nn=new Set([31001,31002,31003,31101,31102,31103,31104,31105,31107,31201,31202,31203,31204,31205,31207,31404,31480,31486,31603]);function nt(t,e){if(!(typeof e!="number"||!Hn(e)||!(t||!Nn.has(e))))return Vn(e)}class L extends Error{constructor(e){super(e),this.name="InvalidArgumentError"}}class ne extends Error{constructor(e){super(e),this.name="InvalidStateError"}}class G extends Error{constructor(e){super(e),this.name="NotSupportedError"}}function Vn(t){const e=pt.get(t);if(!e)throw new L(`Error code ${t} not found`);return e}function Hn(t){return pt.has(t)}const gi="@twilio/voice-sdk",Ee="2.16.0",ft="https://sdk.twilio.com/js/client/sounds/releases/1.0.0",Wn=`${ft}/cowbell.mp3?cache=${Ee}`,Bn=2e4;class B{static getLogLevelInstance(e){if(!B.loglevelInstance)try{B.loglevelInstance=(e&&e.LogLevelModule?e.LogLevelModule:Fn).getLogger(gi)}catch{console.warn("Cannot create custom logger"),B.loglevelInstance=console}return B.loglevelInstance}constructor(e,i){this._log=B.getLogLevelInstance(i),this._prefix=`[TwilioVoice][${e}]`}debug(...e){this._log.debug(this._prefix,...e)}error(...e){this._log.error(this._prefix,...e)}info(...e){this._log.info(this._prefix,...e)}setDefaultLevel(e){this._log.setDefaultLevel?this._log.setDefaultLevel(e):console.warn("Logger cannot setDefaultLevel")}warn(...e){this._log.warn(this._prefix,...e)}}B.levels=$e.levels;B.getLogLevelInstance();const Gn=`${ft}/outgoing.mp3`;class Lt{constructor(e,i,n,o){this._name=e,this._availableDevices=i,this._beforeChange=n,this._isSupported=o,this._activeDevices=new Set,this._log=new B("OutputDeviceCollection")}delete(e){this._log.debug(".delete",e);const i=!!this._activeDevices.delete(e),n=this._availableDevices.get("default")||Array.from(this._availableDevices.values())[0];!this._activeDevices.size&&n&&this._activeDevices.add(n);const o=Array.from(this._activeDevices.values()).map(r=>r.deviceId);return this._beforeChange(this._name,o),!!i}get(){return this._activeDevices}set(e){if(this._log.debug(".set",e),!this._isSupported)return Promise.reject(new G("This browser does not support audio output selection"));const i=Array.isArray(e)?e:[e];if(!i.length)return Promise.reject(new L("Must specify at least one device to set"));const n=[],o=i.map(r=>{const s=this._availableDevices.get(r);return s||n.push(r),s});return n.length?Promise.reject(new L(`Devices not found: ${n.join(", ")}`)):new Promise(r=>{r(this._beforeChange(this._name,i))}).then(()=>{this._activeDevices.clear(),o.forEach(this._activeDevices.add,this._activeDevices)})}test(e=Gn){return this._isSupported?this._activeDevices.size?Promise.all(Array.from(this._activeDevices).map(i=>{let n;return new Promise(o=>{n=new Audio(e),n.oncanplay=o}).then(()=>n.setSinkId(i.deviceId).then(()=>n.play()))})):Promise.reject(new ne("No active output devices to test")):Promise.reject(new G("This browser does not support audio output selection"))}}class qn{constructor(e){Object.defineProperties(this,{deviceId:{get(){return e.deviceId}},groupId:{get(){return e.groupId}},kind:{get(){return e.kind}},label:{get(){return e.label}}})}}function Ge(t){if(!(this instanceof Ge))return new Ge(t);this.message=t}Ge.prototype.toString=function(){return`Twilio.Exception: ${this.message}`};function Oe(t){return t&&t.length?t.reduce((e,i)=>e+i)/t.length:0}function mt(t,e,i){i=i||(o=>o);const n=new Set(e.map(i));return t.filter(o=>!n.has(i(o)))}function _i(t){return!!t.userAgent.match("Electron")}function gt(t,e){const i=!!e.userAgent.match("CriOS"),n=!!e.userAgent.match("HeadlessChrome"),o=typeof t.chrome<"u"&&e.vendor==="Google Inc."&&e.userAgent.indexOf("OPR")===-1&&e.userAgent.indexOf("Edge")===-1;return i||_i(e)||o||n}function zn(t){return t=t||(typeof window>"u"?global.navigator:window.navigator),!!t&&typeof t.userAgent=="string"&&/firefox|fxios/i.test(t.userAgent)}function Ke(t){return t=t||(typeof window>"u"?global.navigator:window.navigator),!!t&&typeof t.userAgent=="string"&&/edge\/\d+/i.test(t.userAgent)}function Jn(t){return!!t.vendor&&t.vendor.indexOf("Apple")!==-1&&t.userAgent&&t.userAgent.indexOf("CriOS")===-1&&t.userAgent.indexOf("FxiOS")===-1}function vi(t){return t?t.split("&").reduce((e,i)=>{const n=i.split("="),o=n[0],r=decodeURIComponent((n[1]||"").replace(/\+/g,"%20"));return o&&(e[o]=r),e},{}):""}function st(t,e){const i=t instanceof Map||t instanceof Set?Array.from(t.values()):t;return e=e||(n=>n),i.reduce((n,o)=>{const r=e(o);return n.concat(r)},[])}function ot(t,e,i){return new Promise((n,o)=>{function r(){t.removeListener(i,s),n()}function s(){t.removeListener(e,r),o()}t.once(e,r),t.once(i,s)})}function yi(t,e){const i=e.map(n=>"audio/"+n.toLowerCase());return t.sort((n,o)=>{const r=i.indexOf(n.mimeType.toLowerCase()),s=i.indexOf(o.mimeType.toLowerCase()),a=r>=0?r:Number.MAX_VALUE,l=s>=0?s:Number.MAX_VALUE;return a-l})}const Kn=Ge,bi=Object.freeze(Object.defineProperty({__proto__:null,Exception:Kn,average:Oe,difference:mt,flatMap:st,isChrome:gt,isElectron:_i,isFirefox:zn,isLegacyEdge:Ke,isSafari:Jn,promisifyEvents:ot,queryToJson:vi,sortByMimeTypes:yi},Symbol.toStringTag,{value:"Module"})),Zn={audioinput:"Audio Input",audiooutput:"Audio Output"};class rt extends ie.EventEmitter{get audioConstraints(){return this._audioConstraints}get inputDevice(){return this._inputDevice}get inputStream(){return this._processedStream||this._selectedInputDeviceStream}get processedStream(){return this._processedStream}constructor(e,i,n){super(),this.availableInputDevices=new Map,this.availableOutputDevices=new Map,this._audioConstraints=null,this._defaultInputDeviceStream=null,this._enabledSounds={[f.SoundName.Disconnect]:!0,[f.SoundName.Incoming]:!0,[f.SoundName.Outgoing]:!0},this._inputDevice=null,this._inputDevicePromise=null,this._isPollingInputVolume=!1,this._log=new B("AudioHelper"),this._processedStream=null,this._selectedInputDeviceStream=null,this._unknownDeviceIndexes={audioinput:{},audiooutput:{}},this._updateAvailableDevices=()=>!this._mediaDevices||!this._enumerateDevices?Promise.reject("Enumeration not supported"):this._enumerateDevices().then(a=>{this._updateDevices(a.filter(c=>c.kind==="audiooutput"),this.availableOutputDevices,this._removeLostOutput),this._updateDevices(a.filter(c=>c.kind==="audioinput"),this.availableInputDevices,this._removeLostInput);const l=this.availableOutputDevices.get("default")||Array.from(this.availableOutputDevices.values())[0];[this.speakerDevices,this.ringtoneDevices].forEach(c=>{!c.get().size&&this.availableOutputDevices.size&&this.isOutputSelectionSupported&&c.set(l.deviceId).catch(u=>{this._log.warn(`Unable to set audio output devices. ${u}`)})})}),this._removeLostInput=a=>{if(!this.inputDevice||this.inputDevice.deviceId!==a.deviceId)return!1;this._destroyProcessedStream(),this._replaceStream(null),this._inputDevice=null,this._maybeStopPollingVolume();const l=this.availableInputDevices.get("default")||Array.from(this.availableInputDevices.values())[0];return l&&this.setInputDevice(l.deviceId),!0},this._removeLostOutput=a=>{const l=this.speakerDevices.delete(a),c=this.ringtoneDevices.delete(a);return l||c},n=Object.assign({AudioContext:typeof AudioContext<"u"&&AudioContext,setSinkId:typeof HTMLAudioElement<"u"&&HTMLAudioElement.prototype.setSinkId},n),this._beforeSetInputDevice=n.beforeSetInputDevice||(()=>Promise.resolve()),this._updateUserOptions(n),this._audioProcessorEventObserver=n.audioProcessorEventObserver,this._mediaDevices=n.mediaDevices||navigator.mediaDevices,this._onActiveInputChanged=i,this._enumerateDevices=typeof n.enumerateDevices=="function"?n.enumerateDevices:this._mediaDevices&&this._mediaDevices.enumerateDevices.bind(this._mediaDevices);const o=!!(n.AudioContext||n.audioContext),r=!!this._enumerateDevices;n.enabledSounds&&(this._enabledSounds=n.enabledSounds);const s=typeof n.setSinkId=="function";this.isOutputSelectionSupported=r&&s,this.isVolumeSupported=o,this.isVolumeSupported&&(this._audioContext=n.audioContext||n.AudioContext&&new n.AudioContext,this._audioContext&&(this._inputVolumeAnalyser=this._audioContext.createAnalyser(),this._inputVolumeAnalyser.fftSize=32,this._inputVolumeAnalyser.smoothingTimeConstant=.3)),this.ringtoneDevices=new Lt("ringtone",this.availableOutputDevices,e,this.isOutputSelectionSupported),this.speakerDevices=new Lt("speaker",this.availableOutputDevices,e,this.isOutputSelectionSupported),this.addListener("newListener",a=>{a==="inputVolume"&&this._maybeStartPollingVolume()}),this.addListener("removeListener",a=>{a==="inputVolume"&&this._maybeStopPollingVolume()}),this.once("newListener",()=>{this.isOutputSelectionSupported||this._log.warn("Warning: This browser does not support audio output selection."),this.isVolumeSupported||this._log.warn("Warning: This browser does not support Twilio's volume indicator feature.")}),r&&this._initializeEnumeration(),navigator&&navigator.permissions&&typeof navigator.permissions.query=="function"?navigator.permissions.query({name:"microphone"}).then(a=>{if(a.state!=="granted"){const l=()=>{this._updateAvailableDevices(),this._stopMicrophonePermissionListener()};a.addEventListener("change",l),this._microphonePermissionStatus=a,this._onMicrophonePermissionStatusChanged=l}}).catch(a=>this._log.warn(`Warning: unable to listen for microphone permission changes. ${a}`)):this._log.warn("Warning: current browser does not support permissions API.")}_destroy(){this._stopDefaultInputDeviceStream(),this._stopSelectedInputDeviceStream(),this._destroyProcessedStream(),this._maybeStopPollingVolume(),this.removeAllListeners(),this._stopMicrophonePermissionListener(),this._unbind()}_getInputDevicePromise(){return this._inputDevicePromise}_maybeStartPollingVolume(){if(!this.isVolumeSupported||!this.inputStream||(this._updateVolumeSource(),this._isPollingInputVolume||!this._inputVolumeAnalyser))return;const e=this._inputVolumeAnalyser.frequencyBinCount,i=new Uint8Array(e);this._isPollingInputVolume=!0;const n=()=>{if(this._isPollingInputVolume){if(this._inputVolumeAnalyser){this._inputVolumeAnalyser.getByteFrequencyData(i);const o=Oe(i);this.emit("inputVolume",o/255)}requestAnimationFrame(n)}};requestAnimationFrame(n)}_maybeStopPollingVolume(){this.isVolumeSupported&&(!this._isPollingInputVolume||this.inputStream&&this.listenerCount("inputVolume")||(this._inputVolumeSource&&(this._inputVolumeSource.disconnect(),delete this._inputVolumeSource),this._isPollingInputVolume=!1))}_openDefaultDeviceWithConstraints(e){return this._log.info("Opening default device with constraints",e),this._getUserMedia(e).then(i=>(this._log.info("Opened default device. Updating available devices."),this._updateAvailableDevices().catch(n=>{this._log.warn("Unable to updateAvailableDevices after gUM call",n)}),this._defaultInputDeviceStream=i,this._maybeCreateProcessedStream(i)))}_stopDefaultInputDeviceStream(){this._defaultInputDeviceStream&&(this._log.info("stopping default device stream"),this._defaultInputDeviceStream.getTracks().forEach(e=>e.stop()),this._defaultInputDeviceStream=null,this._destroyProcessedStream())}_unbind(){var e;!((e=this._mediaDevices)===null||e===void 0)&&e.removeEventListener&&this._mediaDevices.removeEventListener("devicechange",this._updateAvailableDevices)}_updateUserOptions(e){typeof e.enumerateDevices=="function"&&(this._enumerateDevices=e.enumerateDevices),typeof e.getUserMedia=="function"&&(this._getUserMedia=e.getUserMedia)}addProcessor(e){if(this._log.debug(".addProcessor"),this._processor)throw new G("Adding multiple AudioProcessors is not supported at this time.");if(typeof e!="object"||e===null)throw new L("Missing AudioProcessor argument.");if(typeof e.createProcessedStream!="function")throw new L("Missing createProcessedStream() method.");if(typeof e.destroyProcessedStream!="function")throw new L("Missing destroyProcessedStream() method.");return this._processor=e,this._audioProcessorEventObserver.emit("add"),this._restartStreams()}disconnect(e){return this._log.debug(".disconnect",e),this._maybeEnableSound(f.SoundName.Disconnect,e)}incoming(e){return this._log.debug(".incoming",e),this._maybeEnableSound(f.SoundName.Incoming,e)}outgoing(e){return this._log.debug(".outgoing",e),this._maybeEnableSound(f.SoundName.Outgoing,e)}removeProcessor(e){if(this._log.debug(".removeProcessor"),typeof e!="object"||e===null)throw new L("Missing AudioProcessor argument.");if(this._processor!==e)throw new L("Cannot remove an AudioProcessor that has not been previously added.");return this._destroyProcessedStream(),this._processor=null,this._audioProcessorEventObserver.emit("remove"),this._restartStreams()}setAudioConstraints(e){return this._log.debug(".setAudioConstraints",e),this._audioConstraints=Object.assign({},e),delete this._audioConstraints.deviceId,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()}setInputDevice(e){return this._log.debug(".setInputDevice",e),this._setInputDevice(e,!1)}unsetAudioConstraints(){return this._log.debug(".unsetAudioConstraints"),this._audioConstraints=null,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()}unsetInputDevice(){return this._log.debug(".unsetInputDevice",this.inputDevice),this.inputDevice?(this._destroyProcessedStream(),this._onActiveInputChanged(null).then(()=>{this._replaceStream(null),this._inputDevice=null,this._maybeStopPollingVolume()})):Promise.resolve()}_destroyProcessedStream(){if(this._processor&&this._processedStream){this._log.info("destroying processed stream");const e=this._processedStream;this._processedStream.getTracks().forEach(i=>i.stop()),this._processedStream=null,this._processor.destroyProcessedStream(e),this._audioProcessorEventObserver.emit("destroy")}}_getUnknownDeviceIndex(e){const i=e.deviceId,n=e.kind;let o=this._unknownDeviceIndexes[n][i];return o||(o=Object.keys(this._unknownDeviceIndexes[n]).length+1,this._unknownDeviceIndexes[n][i]=o),o}_initializeEnumeration(){if(!this._mediaDevices||!this._enumerateDevices)throw new G("Enumeration is not supported");this._mediaDevices.addEventListener&&this._mediaDevices.addEventListener("devicechange",this._updateAvailableDevices),this._updateAvailableDevices().then(()=>{this.isOutputSelectionSupported&&Promise.all([this.speakerDevices.set("default"),this.ringtoneDevices.set("default")]).catch(e=>{this._log.warn(`Warning: Unable to set audio output devices. ${e}`)})})}_maybeCreateProcessedStream(e){return this._processor?(this._log.info("Creating processed stream"),this._processor.createProcessedStream(e).then(i=>(this._processedStream=i,this._audioProcessorEventObserver.emit("create"),this._processedStream))):Promise.resolve(e)}_maybeEnableSound(e,i){return typeof i<"u"&&(this._enabledSounds[e]=i),this._enabledSounds[e]}_replaceStream(e){this._log.info("Replacing with new stream."),this._selectedInputDeviceStream&&(this._log.info("Old stream detected. Stopping tracks."),this._stopSelectedInputDeviceStream()),this._selectedInputDeviceStream=e}_restartStreams(){if(this.inputDevice&&this._selectedInputDeviceStream)return this._log.info("Restarting selected input device"),this._setInputDevice(this.inputDevice.deviceId,!0);if(this._defaultInputDeviceStream){const e=this.availableInputDevices.get("default")||Array.from(this.availableInputDevices.values())[0];return this._log.info("Restarting default input device, now becoming selected."),this._setInputDevice(e.deviceId,!0)}return Promise.resolve()}_setInputDevice(e,i){return K(this,void 0,void 0,function*(){const n=()=>K(this,void 0,void 0,function*(){if(yield this._beforeSetInputDevice(),typeof e!="string")return Promise.reject(new L("Must specify the device to set"));const o=this.availableInputDevices.get(e);if(!o)return Promise.reject(new L(`Device not found: ${e}`));if(this._log.info("Setting input device. ID: "+e),this._inputDevice&&this._inputDevice.deviceId===e&&this._selectedInputDeviceStream){if(!i)return Promise.resolve();this._log.info("Same track detected on setInputDevice, stopping old tracks."),this._stopSelectedInputDeviceStream()}this._stopDefaultInputDeviceStream();const r={audio:Object.assign({deviceId:{exact:e}},this.audioConstraints)};return this._log.info("setInputDevice: getting new tracks."),this._getUserMedia(r).then(s=>(this._destroyProcessedStream(),this._maybeCreateProcessedStream(s).then(a=>(this._log.info("setInputDevice: invoking _onActiveInputChanged."),this._onActiveInputChanged(a).then(()=>{this._replaceStream(s),this._inputDevice=o,this._maybeStartPollingVolume()})))))});return this._inputDevicePromise=n().finally(()=>{this._inputDevicePromise=null})})}_stopMicrophonePermissionListener(){var e;!((e=this._microphonePermissionStatus)===null||e===void 0)&&e.removeEventListener&&this._microphonePermissionStatus.removeEventListener("change",this._onMicrophonePermissionStatusChanged)}_stopSelectedInputDeviceStream(){this._selectedInputDeviceStream&&(this._log.info("Stopping selected device stream"),this._selectedInputDeviceStream.getTracks().forEach(e=>e.stop()))}_updateDevices(e,i,n){const o=e.map(c=>c.deviceId),r=Array.from(i.values()).map(c=>c.deviceId),s=[],a=mt(r,o);a.forEach(c=>{const u=i.get(c);u&&(i.delete(c),n(u)&&s.push(u))});let l=!1;if(e.forEach(c=>{const u=i.get(c.deviceId),d=this._wrapMediaDeviceInfo(c);(!u||u.label!==d.label)&&(i.set(c.deviceId,d),l=!0)}),l||a.length){const c="default",u=this.inputDevice&&this.inputDevice.deviceId===c,d=this._defaultInputDeviceStream&&this.availableInputDevices.get(c);(u||d)&&(this._log.warn("Calling getUserMedia after device change to ensure that the           tracks of the active device (default) have not gone stale."),setTimeout(()=>{this._setInputDevice(c,!0)},0)),this._log.debug("#deviceChange",s),this.emit("deviceChange",s)}}_updateVolumeSource(){if(!(!this.inputStream||!this._audioContext||!this._inputVolumeAnalyser)){this._inputVolumeSource&&this._inputVolumeSource.disconnect();try{this._inputVolumeSource=this._audioContext.createMediaStreamSource(this.inputStream),this._inputVolumeSource.connect(this._inputVolumeAnalyser)}catch(e){this._log.warn("Unable to update volume source",e),delete this._inputVolumeSource}}}_wrapMediaDeviceInfo(e){const i={deviceId:e.deviceId,groupId:e.groupId,kind:e.kind,label:e.label};if(!i.label)if(i.deviceId==="default")i.label="Default";else{const n=this._getUnknownDeviceIndex(e);i.label=`Unknown ${Zn[i.kind]} Device ${n}`}return new qn(i)}}rt||(rt={});var Xn=rt;class Qn extends ie.EventEmitter{constructor(){super(),this._log=new B("AudioProcessorEventObserver"),this._log.info("Creating AudioProcessorEventObserver instance"),this.on("enabled",()=>this._reEmitEvent("enabled")),this.on("add",()=>this._reEmitEvent("add")),this.on("remove",()=>this._reEmitEvent("remove")),this.on("create",()=>this._reEmitEvent("create-processed-stream")),this.on("destroy",()=>this._reEmitEvent("destroy-processed-stream"))}destroy(){this.removeAllListeners()}_reEmitEvent(e){this._log.info(`AudioProcessor:${e}`),this.emit("event",{name:e,group:"audio-processor"})}}const Yn={dtmf0:[1360,960],dtmf1:[1230,720],dtmf2:[1360,720],dtmf3:[1480,720],dtmf4:[1230,790],dtmf5:[1360,790],dtmf6:[1480,790],dtmf7:[1230,870],dtmf8:[1360,870],dtmf9:[1480,870],dtmfh:[1480,960],dtmfs:[1230,960]};class es{constructor(e){this._context=e,this._gainNodes=[],this._gainNodes=[this._context.createGain(),this._context.createGain()],this._gainNodes.forEach(i=>{i.connect(this._context.destination),i.gain.value=.1,this._gainNodes.push(i)})}cleanup(){this._gainNodes.forEach(e=>{e.disconnect()})}play(e){const i=Yn[e];if(!i)throw new L("Invalid DTMF sound name");[this._context.createOscillator(),this._context.createOscillator()].forEach((o,r)=>{o.type="sine",o.frequency.value=i[r],o.connect(this._gainNodes[r]),o.start(),o.stop(this._context.currentTime+.1),o.addEventListener("ended",()=>o.disconnect())})}}function ts(t,e,i){const n=JSON.stringify(e.body||{}),o=new Headers;e.headers=e.headers||[],Object.entries(e.headers).forEach(([r,s])=>o.append(r,s)),fetch(e.url,{body:n,headers:o,method:t}).then(r=>r.text(),i).then(r=>i(null,r),i)}const _t=ts;_t.get=function(e,i){return new this("GET",e,i)};_t.post=function(e,i){return new this("POST",e,i)};class Z extends ie.EventEmitter{constructor(e,i,n){if(super(),!(this instanceof Z))return new Z(e,i,n);n=Object.assign({defaultPayload(){return{}}},n);let o=n.defaultPayload;typeof o!="function"&&(o=()=>Object.assign({},n.defaultPayload));let r=!0;const s=Object.assign({app_name:void 0,app_version:void 0},n.metadata);Object.defineProperties(this,{_defaultPayload:{value:o},_host:{value:n.host,writable:!0},_isEnabled:{get(){return r},set(a){r=a}},_log:{value:new B("EventPublisher")},_request:{value:n.request||_t,writable:!0},_token:{value:i,writable:!0},isEnabled:{enumerable:!0,get(){return r}},metadata:{enumerable:!0,get(){return s}},productName:{enumerable:!0,value:e},token:{enumerable:!0,get(){return this._token}}})}}Z.prototype._post=function(e,i,n,o,r,s,a){if(!this.isEnabled&&!a||!this._host)return this._log.debug("Publishing cancelled",JSON.stringify({isEnabled:this.isEnabled,force:a,host:this._host})),Promise.resolve();if(!s||(!s.parameters||!s.parameters.CallSid)&&!s.outboundConnectionId)return s?this._log.debug("Publishing cancelled. Missing connection info",JSON.stringify({outboundConnectionId:s.outboundConnectionId,parameters:s.parameters})):this._log.debug("Publishing cancelled. Missing connection object"),Promise.resolve();const l={group:n,level:i.toUpperCase(),name:o,payload:r&&r.forEach?r.slice(0):Object.assign(this._defaultPayload(s),r),payload_type:"application/json",private:!1,publisher:this.productName,timestamp:new Date().toISOString()};this.metadata&&(l.publisher_metadata=this.metadata),e==="EndpointEvents"&&this._log.debug("Publishing insights",JSON.stringify({endpointName:e,event:l,force:a,host:this._host}));const c={body:l,headers:{"Content-Type":"application/json","X-Twilio-Token":this.token},url:`https://${this._host}/v4/${e}`};return new Promise((u,d)=>{this._request.post(c,h=>{h?(this.emit("error",h),d(h)):u()})}).catch(u=>{this._log.error(`Unable to post ${n} ${o} event to Insights. Received error: ${u}`)})};Z.prototype.post=function(e,i,n,o,r,s){return this._post("EndpointEvents",e,i,n,o,r,s)};Z.prototype.debug=function(e,i,n,o){return this.post("debug",e,i,n,o)};Z.prototype.info=function(e,i,n,o){return this.post("info",e,i,n,o)};Z.prototype.warn=function(e,i,n,o){return this.post("warning",e,i,n,o)};Z.prototype.error=function(e,i,n,o){return this.post("error",e,i,n,o)};Z.prototype.postMetrics=function(e,i,n,o,r){return new Promise(s=>{const a=n.map(is).map(l=>Object.assign(l,o));s(this._post("EndpointMetrics","info",e,i,a,r))})};Z.prototype.setHost=function(e){this._host=e};Z.prototype.setToken=function(e){this._token=e};Z.prototype.enable=function(){this._isEnabled=!0};Z.prototype.disable=function(){this._isEnabled=!1};function is(t){return{audio_codec:t.codecName,audio_level_in:t.audioInputLevel,audio_level_out:t.audioOutputLevel,bytes_received:t.bytesReceived,bytes_sent:t.bytesSent,call_volume_input:t.inputVolume,call_volume_output:t.outputVolume,jitter:t.jitter,mos:t.mos&&Math.round(t.mos*100)/100,packets_lost:t.packetsLost,packets_lost_fraction:t.packetsLostFraction&&Math.round(t.packetsLostFraction*100)/100,packets_received:t.packetsReceived,rtt:t.rtt,timestamp:new Date(t.timestamp).toISOString(),total_bytes_received:t.totals.bytesReceived,total_bytes_sent:t.totals.bytesSent,total_packets_lost:t.totals.packetsLost,total_packets_received:t.totals.packetsReceived,total_packets_sent:t.totals.packetsSent}}const Mt=32767,Ot=typeof window<"u"?window.RTCStatsReport:void 0;function oe(t){if(!(this instanceof oe))return new oe(t);const e=this;Object.defineProperties(this,{_map:{value:t},size:{enumerable:!0,get(){return e._map.size}}}),this[Symbol.iterator]=t[Symbol.iterator]}Ot&&(oe.prototype=Object.create(Ot.prototype),oe.prototype.constructor=oe);["entries","forEach","get","has","keys","values"].forEach(t=>{oe.prototype[t]=function(...e){return this._map[t](...e)}});oe.fromArray=function(e){return new oe(e.reduce((i,n)=>(i.set(n.id,n),i),new Map))};oe.fromRTCStatsResponse=function(e){let i;const n=new Map,o=e.result().reduce((r,s)=>{const a=s.id;switch(s.type){case"googCertificate":r.set(a,cs(s));break;case"datachannel":r.set(a,ls(s));break;case"googCandidatePair":wi(s,"googActiveConnection")&&(i=a),r.set(a,as(s));break;case"localcandidate":r.set(a,jt(s,!1));break;case"remotecandidate":r.set(a,jt(s,!0));break;case"ssrc":ye(s,"packetsReceived")?r.set(`rtp-${a}`,os(s)):r.set(`rtp-${a}`,rs(s)),r.set(`track-${a}`,ss(s)),r.set(`codec-${a}`,ns(s));break;case"googComponent":const l=$t(s);n.set(l.selectedCandidatePairId,a),r.set(a,$t(s));break}return r},new Map);if(i){const r=n.get(i);r&&(o.get(r).dtlsState="connected")}return new oe(o)};function $t(t){return{bytesReceived:void 0,bytesSent:void 0,dtlsState:void 0,id:t.id,localCertificateId:t.stat("localCertificateId"),remoteCertificateId:t.stat("remoteCertificateId"),rtcpTransportStatsId:void 0,selectedCandidatePairId:t.stat("selectedCandidatePairId"),timestamp:Date.parse(t.timestamp),type:"transport"}}function ns(t){return{channels:void 0,clockRate:void 0,id:t.id,implementation:void 0,mimeType:`${t.stat("mediaType")}/${t.stat("googCodecName")}`,payloadType:void 0,sdpFmtpLine:void 0,timestamp:Date.parse(t.timestamp),type:"codec"}}function ss(t){return{audioLevel:ye(t,"audioOutputLevel")?D(t,"audioOutputLevel")/Mt:(D(t,"audioInputLevel")||0)/Mt,detached:void 0,echoReturnLoss:ct(t,"googEchoCancellationReturnLoss"),echoReturnLossEnhancement:ct(t,"googEchoCancellationReturnLossEnhancement"),ended:void 0,frameHeight:ye(t,"googFrameHeightReceived")?D(t,"googFrameHeightReceived"):D(t,"googFrameHeightSent"),frameWidth:ye(t,"googFrameWidthReceived")?D(t,"googFrameWidthReceived"):D(t,"googFrameWidthSent"),framesCorrupted:void 0,framesDecoded:D(t,"framesDecoded"),framesDropped:void 0,framesPerSecond:void 0,framesReceived:void 0,framesSent:D(t,"framesEncoded"),fullFramesLost:void 0,id:t.id,kind:t.stat("mediaType"),partialFramesLost:void 0,remoteSource:void 0,ssrcIds:void 0,timestamp:Date.parse(t.timestamp),trackIdentifier:t.stat("googTrackId"),type:"track"}}function Si(t,e){return{associateStatsId:void 0,codecId:`codec-${t.id}`,firCount:e?D(t,"googFirsSent"):void 0,id:t.id,isRemote:void 0,mediaType:t.stat("mediaType"),nackCount:e?D(t,"googNacksSent"):D(t,"googNacksReceived"),pliCount:e?D(t,"googPlisSent"):D(t,"googPlisReceived"),qpSum:D(t,"qpSum"),sliCount:void 0,ssrc:t.stat("ssrc"),timestamp:Date.parse(t.timestamp),trackId:`track-${t.id}`,transportId:t.stat("transportId")}}function os(t){const e=Si(t,!0);return Object.assign(e,{burstDiscardCount:void 0,burstDiscardRate:void 0,burstLossCount:void 0,burstLossRate:void 0,burstPacketsDiscarded:void 0,burstPacketsLost:void 0,bytesReceived:D(t,"bytesReceived"),fractionLost:void 0,framesDecoded:D(t,"framesDecoded"),gapDiscardRate:void 0,gapLossRate:void 0,jitter:at(t.stat("googJitterReceived")),packetsDiscarded:void 0,packetsLost:D(t,"packetsLost"),packetsReceived:D(t,"packetsReceived"),packetsRepaired:void 0,roundTripTime:at(t.stat("googRtt")),type:"inbound-rtp"}),e}function rs(t){const e=Si(t,!1);return Object.assign(e,{bytesSent:D(t,"bytesSent"),framesEncoded:D(t,"framesEncoded"),packetsSent:D(t,"packetsSent"),remoteTimestamp:void 0,targetBitrate:void 0,type:"outbound-rtp"}),e}function jt(t,e){return{candidateType:us(t.stat("candidateType")),deleted:void 0,id:t.id,ip:t.stat("ipAddress"),isRemote:e,port:D(t,"portNumber"),priority:ct(t,"priority"),protocol:t.stat("transport"),relayProtocol:void 0,timestamp:Date.parse(t.timestamp),transportId:void 0,type:e?"remote-candidate":"local-candidate",url:void 0}}function as(t){return{availableIncomingBitrate:void 0,availableOutgoingBitrate:void 0,bytesReceived:D(t,"bytesReceived"),bytesSent:D(t,"bytesSent"),consentRequestsSent:D(t,"consentRequestsSent"),currentRoundTripTime:at(t.stat("googRtt")),id:t.id,lastPacketReceivedTimestamp:void 0,lastPacketSentTimestamp:void 0,localCandidateId:t.stat("localCandidateId"),nominated:void 0,priority:void 0,readable:void 0,remoteCandidateId:t.stat("remoteCandidateId"),requestsReceived:D(t,"requestsReceived"),requestsSent:D(t,"requestsSent"),responsesReceived:D(t,"responsesReceived"),responsesSent:D(t,"responsesSent"),retransmissionsReceived:void 0,retransmissionsSent:void 0,state:void 0,timestamp:Date.parse(t.timestamp),totalRoundTripTime:void 0,transportId:t.stat("googChannelId"),type:"candidate-pair",writable:wi(t,"googWritable")}}function cs(t){return{base64Certificate:t.stat("googDerBase64"),fingerprint:t.stat("googFingerprint"),fingerprintAlgorithm:t.stat("googFingerprintAlgorithm"),id:t.id,issuerCertificateId:t.stat("googIssuerId"),timestamp:Date.parse(t.timestamp),type:"certificate"}}function ls(t){return{bytesReceived:void 0,bytesSent:void 0,datachannelid:t.stat("datachannelid"),id:t.id,label:t.stat("label"),messagesReceived:void 0,messagesSent:void 0,protocol:t.stat("protocol"),state:t.stat("state"),timestamp:Date.parse(t.timestamp),transportId:t.stat("transportId"),type:"data-channel"}}function at(t){return isNaN(t)||t===""?void 0:parseInt(t,10)/1e3}function us(t){switch(t){case"peerreflexive":return"prflx";case"serverreflexive":return"srflx";case"host":case"relay":default:return t}}function D(t,e){const i=t.stat(e);return ye(t,e)?parseInt(i,10):void 0}function ct(t,e){const i=t.stat(e);return ye(t,e)?parseFloat(i):void 0}function wi(t,e){const i=t.stat(e);return ye(t,e)?i==="true"||i===!0:void 0}function ye(t,e){const i=t.stat(e);return typeof i<"u"&&i!==""}const ds="PeerConnection is null",hs="WebRTC statistics are unsupported";function we(t,e){return typeof t.get=="function"?t.get(e):t.find(i=>i.id===e)}function Ci(t){if(!t)return Promise.reject(new L(ds));if(typeof t.getStats!="function")return Promise.reject(new G(hs));let e;try{e=t.getStats()}catch{e=new Promise(n=>t.getStats(n)).then(oe.fromRTCStatsResponse)}return e}function ps(t,e){return e=Object.assign({createRTCSample:gs},e),Ci(t).then(e.createRTCSample)}function fs(t){return Ci(t).then(e=>{const{candidatePairs:i,localCandidates:n,remoteCandidates:o,transport:r}=Array.from(e.values()).reduce((l,c)=>{switch(["candidatePairs","localCandidates","remoteCandidates"].forEach(u=>{l[u]||(l[u]=[])}),c.type){case"candidate-pair":l.candidatePairs.push(c);break;case"local-candidate":l.localCandidates.push(c);break;case"remote-candidate":l.remoteCandidates.push(c);break;case"transport":c.selectedCandidatePairId&&(l.transport=c);break}return l},{}),s=i.find(l=>l.selected||r&&l.id===r.selectedCandidatePairId);let a;return s&&(a={localCandidate:n.find(l=>l.id===s.localCandidateId),remoteCandidate:o.find(l=>l.id===s.remoteCandidateId)}),{iceCandidateStats:[...n,...o],selectedIceCandidatePairStats:a}})}function ms(){}function gs(t){let e=null;const i=new ms;let n;Array.from(t.values()).forEach(l=>{if(l.isRemote)return;const c=l.type.replace("-","");if(n=n||l.timestamp,l.remoteId){const u=we(t,l.remoteId);u&&u.roundTripTime&&(i.rtt=u.roundTripTime*1e3)}switch(c){case"inboundrtp":i.timestamp=i.timestamp||l.timestamp,i.jitter=l.jitter*1e3,i.packetsLost=l.packetsLost,i.packetsReceived=l.packetsReceived,i.bytesReceived=l.bytesReceived;break;case"outboundrtp":if(i.timestamp=l.timestamp,i.packetsSent=l.packetsSent,i.bytesSent=l.bytesSent,l.codecId){const u=we(t,l.codecId);i.codecName=u?u.mimeType&&u.mimeType.match(/(.*\/)?(.*)/)[2]:l.codecId}break;case"transport":e=l.id;break}}),i.timestamp||(i.timestamp=n);const o=we(t,e);if(!o)return i;const r=we(t,o.selectedCandidatePairId);if(!r)return i;const s=we(t,r.localCandidateId),a=we(t,r.remoteCandidateId);return i.rtt||(i.rtt=r&&r.currentRoundTripTime*1e3),Object.assign(i,{localAddress:s&&(s.address||s.ip),remoteAddress:a&&(a.address||a.ip)}),i}class j extends ie.EventEmitter{constructor(e,i){super(),this._hasInsightsErrored=!1,this._log=new B("PreflightTest"),this._networkTiming={},this._options={codecPreferences:[p.Codec.PCMU,p.Codec.Opus],edge:"roaming",fakeMicInput:!1,logLevel:"error",signalingTimeoutMs:1e4},this._status=j.Status.Connecting,Object.assign(this._options,i),this._samples=[],this._warnings=[],this._startTime=Date.now(),this._initDevice(e,Object.assign(Object.assign({},this._options),{fileInputStream:this._options.fakeMicInput?this._getStreamFromFile():void 0}));const n=["codecPreferences","edge","fakeMicInput","logLevel","signalingTimeoutMs"],o=["audioContext","deviceFactory","fileInputStream","getRTCIceCandidateStatsReport","iceServers","rtcConfiguration"];if(typeof i=="object"){const r=Object.assign({},i);Object.keys(r).forEach(s=>{!n.includes(s)&&!o.includes(s)&&delete r[s],o.includes(s)&&(r[s]=!0)}),this._log.debug(".constructor",JSON.stringify(r))}}stop(){this._log.debug(".stop");const e=new z.CallCancelledError;this._device?(this._device.once(f.EventName.Unregistered,()=>this._onFailed(e)),this._device.destroy()):this._onFailed(e)}_emitWarning(e,i,n){const o={name:e,description:i};n&&(o.rtcWarning=n),this._warnings.push(o),this._log.debug(`#${j.Events.Warning}`,JSON.stringify(o)),this.emit(j.Events.Warning,o)}_getCallQuality(e){return e>4.2?j.CallQuality.Excellent:e>=4.1&&e<=4.2?j.CallQuality.Great:e>=3.7&&e<=4?j.CallQuality.Good:e>=3.1&&e<=3.6?j.CallQuality.Fair:j.CallQuality.Degraded}_getReport(){var e,i,n;const o=this._getRTCStats(),r={start:this._startTime};this._endTime&&(r.end=this._endTime,r.duration=this._endTime-this._startTime);const s={callSid:this._callSid,edge:this._edge,iceCandidateStats:(i=(e=this._rtcIceCandidateStatsReport)===null||e===void 0?void 0:e.iceCandidateStats)!==null&&i!==void 0?i:[],networkTiming:this._networkTiming,samples:this._samples,selectedEdge:this._options.edge,stats:o,testTiming:r,totals:this._getRTCSampleTotals(),warnings:this._warnings},a=(n=this._rtcIceCandidateStatsReport)===null||n===void 0?void 0:n.selectedIceCandidatePairStats;return a&&(s.selectedIceCandidatePairStats=a,s.isTurnRequired=a.localCandidate.candidateType==="relay"||a.remoteCandidate.candidateType==="relay"),o&&(s.callQuality=this._getCallQuality(o.mos.average)),s}_getRTCSampleTotals(){if(this._latestSample)return Object.assign({},this._latestSample.totals)}_getRTCStats(){const e=this._samples.findIndex(n=>typeof n.mos=="number"&&n.mos>0),i=e>=0?this._samples.slice(e):[];if(!(!i||!i.length))return["jitter","mos","rtt"].reduce((n,o)=>{const r=i.map(s=>s[o]);return Object.assign(Object.assign({},n),{[o]:{average:Number((r.reduce((s,a)=>s+a)/r.length).toPrecision(5)),max:Math.max(...r),min:Math.min(...r)}})},{})}_getStreamFromFile(){const e=this._options.audioContext;if(!e)throw new G("Cannot fake input audio stream: AudioContext is not supported by this browser.");const i=new Audio(Wn);i.addEventListener("canplaythrough",()=>i.play()),typeof i.setAttribute=="function"&&i.setAttribute("crossorigin","anonymous");const n=e.createMediaElementSource(i),o=e.createMediaStreamDestination();return n.connect(o),o.stream}_initDevice(e,i){try{this._device=new(i.deviceFactory||f)(e,{chunderw:i.chunderw,codecPreferences:i.codecPreferences,edge:i.edge,eventgw:i.eventgw,fileInputStream:i.fileInputStream,logLevel:i.logLevel,preflight:!0}),this._device.once(f.EventName.Registered,()=>{this._onDeviceRegistered()}),this._device.once(f.EventName.Error,n=>{this._onDeviceError(n)}),this._device.register()}catch(n){setTimeout(()=>{this._onFailed(n)});return}this._signalingTimeoutTimer=setTimeout(()=>{this._onDeviceError(new te.ConnectionError("WebSocket Connection Timeout"))},i.signalingTimeoutMs)}_onDeviceError(e){this._device.destroy(),this._onFailed(e)}_onDeviceRegistered(){return K(this,void 0,void 0,function*(){if(clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._call=yield this._device.connect({rtcConfiguration:this._options.rtcConfiguration}),this._networkTiming.signaling={start:Date.now()},this._setupCallHandlers(this._call),this._edge=this._device.edge||void 0,this._options.fakeMicInput){this._echoTimer=setTimeout(()=>this._device.disconnectAll(),Bn);const i=this._device.audio;i&&(i.disconnect(!1),i.outgoing(!1))}this._call.once("disconnect",()=>{this._device.once(f.EventName.Unregistered,()=>this._onUnregistered()),this._device.destroy()}),this._call._publisher.on("error",()=>{this._hasInsightsErrored||this._emitWarning("insights-connection-error","Received an error when attempting to connect to Insights gateway"),this._hasInsightsErrored=!0})})}_onFailed(e){clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._releaseHandlers(),this._endTime=Date.now(),this._status=j.Status.Failed,this._log.debug(`#${j.Events.Failed}`,e),this.emit(j.Events.Failed,e)}_onUnregistered(){setTimeout(()=>{this._status!==j.Status.Failed&&(clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._releaseHandlers(),this._endTime=Date.now(),this._status=j.Status.Completed,this._report=this._getReport(),this._log.debug(`#${j.Events.Completed}`,JSON.stringify(this._report)),this.emit(j.Events.Completed,this._report))},10)}_releaseHandlers(){[this._device,this._call].forEach(e=>{e&&e.eventNames().forEach(i=>e.removeAllListeners(i))})}_setupCallHandlers(e){this._options.fakeMicInput&&e.once("volume",()=>{e._mediaHandler.outputs.forEach(i=>i.audio.muted=!0)}),e.on("warning",(i,n)=>{this._emitWarning(i,"Received an RTCWarning. See .rtcWarning for the RTCWarning",n)}),e.once("accept",()=>{this._callSid=e._mediaHandler.callSid,this._status=j.Status.Connected,this._log.debug(`#${j.Events.Connected}`),this.emit(j.Events.Connected)}),e.on("sample",i=>K(this,void 0,void 0,function*(){this._latestSample||(this._rtcIceCandidateStatsReport=yield(this._options.getRTCIceCandidateStatsReport||fs)(e._mediaHandler.version.pc)),this._latestSample=i,this._samples.push(i),this._log.debug(`#${j.Events.Sample}`,JSON.stringify(i)),this.emit(j.Events.Sample,i)})),[{reportLabel:"peerConnection",type:"pcconnection"},{reportLabel:"ice",type:"iceconnection"},{reportLabel:"dtls",type:"dtlstransport"},{reportLabel:"signaling",type:"signaling"}].forEach(({type:i,reportLabel:n})=>{const o=`on${i}statechange`,r=e._mediaHandler[o];e._mediaHandler[o]=s=>{const a=this._networkTiming[n]=this._networkTiming[n]||{start:0};s==="connecting"||s==="checking"?a.start=Date.now():(s==="connected"||s==="stable")&&!a.duration&&(a.end=Date.now(),a.duration=a.end-a.start),r(s)}})}get callSid(){return this._callSid}get endTime(){return this._endTime}get latestSample(){return this._latestSample}get report(){return this._report}get startTime(){return this._startTime}get status(){return this._status}}(function(t){(function(e){e.Excellent="excellent",e.Great="great",e.Good="good",e.Fair="fair",e.Degraded="degraded"})(t.CallQuality||(t.CallQuality={})),function(e){e.Completed="completed",e.Connected="connected",e.Failed="failed",e.Sample="sample",e.Warning="warning"}(t.Events||(t.Events={})),function(e){e.Connecting="connecting",e.Connected="connected",e.Completed="completed",e.Failed="failed"}(t.Status||(t.Status={}))})(j||(j={}));const Ce=globalThis.WebSocket,_s=1e4,vs=5e3,Ut=15e3,ys=15e3,bs=1/0,Ss=1e3,ws=2e4;var Y;(function(t){t.Connecting="connecting",t.Closed="closed",t.Open="open"})(Y||(Y={}));class Ze extends ie.EventEmitter{constructor(e,i={}){super(),this.state=Y.Closed,this._backoffStartTime={preferred:null,primary:null},this._connectedUri=null,this._log=new B("WSTransport"),this._shouldFallback=!1,this._uriIndex=0,this._moveUriIndex=()=>{this._uriIndex++,this._uriIndex>=this._uris.length&&(this._uriIndex=0)},this._onSocketClose=n=>{if(this._log.error(`Received websocket close event code: ${n.code}. Reason: ${n.reason}`),n.code===1006||n.code===1015){this.emit("error",{code:31005,message:n.reason||"Websocket connection to Twilio's signaling servers were unexpectedly ended. If this is happening consistently, there may be an issue resolving the hostname provided. If a region or an edge is being specified in Device setup, ensure it is valid.",twilioError:new te.ConnectionError});const o=this.state===Y.Open||this._previousState===Y.Open;(this._shouldFallback||!o)&&this._moveUriIndex(),this._shouldFallback=!0}this._closeSocket()},this._onSocketError=n=>{this._log.error(`WebSocket received error: ${n.message}`),this.emit("error",{code:31e3,message:n.message||"WSTransport socket error",twilioError:new te.ConnectionDisconnected})},this._onSocketMessage=n=>{if(this._setHeartbeatTimeout(),this._socket&&n.data===`
`){this._socket.send(`
`),this._log.debug("heartbeat");return}n&&typeof n.data=="string"&&this._log.debug(`Received: ${n.data}`),this.emit("message",n)},this._onSocketOpen=()=>{this._log.info("WebSocket opened successfully."),this._timeOpened=Date.now(),this._shouldFallback=!1,this._setState(Y.Open),clearTimeout(this._connectTimeout),this._resetBackoffs(),this._setHeartbeatTimeout(),this.emit("open")},this._options=Object.assign(Object.assign({},Ze.defaultConstructorOptions),i),this._uris=e,this._backoff=this._setupBackoffs()}close(){this._log.info("WSTransport.close() called..."),this._close()}open(){if(this._log.info("WSTransport.open() called..."),this._socket&&(this._socket.readyState===Ce.CONNECTING||this._socket.readyState===Ce.OPEN)){this._log.info("WebSocket already open.");return}this._preferredUri?this._connect(this._preferredUri):this._connect(this._uris[this._uriIndex])}send(e){if(this._log.debug(`Sending: ${e}`),!this._socket||this._socket.readyState!==Ce.OPEN)return this._log.debug("Cannot send message. WebSocket is not open."),!1;try{this._socket.send(e)}catch(i){return this._log.error("Error while sending message:",i.message),this._closeSocket(),!1}return!0}updatePreferredURI(e){this._preferredUri=e}updateURIs(e){typeof e=="string"&&(e=[e]),this._uris=e,this._uriIndex=0}_close(){this._setState(Y.Closed),this._closeSocket()}_closeSocket(){if(clearTimeout(this._connectTimeout),clearTimeout(this._heartbeatTimeout),this._log.info("Closing and cleaning up WebSocket..."),!this._socket){this._log.info("No WebSocket to clean up.");return}this._socket.removeEventListener("close",this._onSocketClose),this._socket.removeEventListener("error",this._onSocketError),this._socket.removeEventListener("message",this._onSocketMessage),this._socket.removeEventListener("open",this._onSocketOpen),(this._socket.readyState===Ce.CONNECTING||this._socket.readyState===Ce.OPEN)&&this._socket.close(),this._timeOpened&&Date.now()-this._timeOpened>_s&&this._resetBackoffs(),this.state!==Y.Closed&&this._performBackoff(),delete this._socket,this.emit("close")}_connect(e,i){this._log.info(typeof i=="number"?`Attempting to reconnect (retry #${i})...`:"Attempting to connect..."),this._closeSocket(),this._setState(Y.Connecting),this._connectedUri=e;try{this._socket=new this._options.WebSocket(this._connectedUri)}catch(n){this._log.error("Could not connect to endpoint:",n.message),this._close(),this.emit("error",{code:31e3,message:n.message||`Could not connect to ${this._connectedUri}`,twilioError:new te.ConnectionDisconnected});return}this._socket.addEventListener("close",this._onSocketClose),this._socket.addEventListener("error",this._onSocketError),this._socket.addEventListener("message",this._onSocketMessage),this._socket.addEventListener("open",this._onSocketOpen),delete this._timeOpened,this._connectTimeout=setTimeout(()=>{this._log.info("WebSocket connection attempt timed out."),this._moveUriIndex(),this._closeSocket()},this._options.connectTimeoutMs)}_performBackoff(){this._preferredUri?(this._log.info("Preferred URI set; backing off."),this._backoff.preferred.backoff()):(this._log.info("Preferred URI not set; backing off."),this._backoff.primary.backoff())}_resetBackoffs(){this._backoff.preferred.reset(),this._backoff.primary.reset(),this._backoffStartTime.preferred=null,this._backoffStartTime.primary=null}_setHeartbeatTimeout(){clearTimeout(this._heartbeatTimeout),this._heartbeatTimeout=setTimeout(()=>{this._log.info(`No messages received in ${Ut/1e3} seconds. Reconnecting...`),this._shouldFallback=!0,this._closeSocket()},Ut)}_setState(e){this._previousState=this.state,this.state=e}_setupBackoffs(){const e={factor:2,jitter:.4,max:this._options.maxPreferredDelayMs,min:100};this._log.info("Initializing preferred transport backoff using config: ",e);const i=new et(e);i.on("backoff",(r,s)=>{if(this.state===Y.Closed){this._log.info("Preferred backoff initiated but transport state is closed; not attempting a connection.");return}this._log.info(`Will attempt to reconnect Websocket to preferred URI in ${s}ms`),r===0&&(this._backoffStartTime.preferred=Date.now(),this._log.info(`Preferred backoff start; ${this._backoffStartTime.preferred}`))}),i.on("ready",(r,s)=>{if(this.state===Y.Closed){this._log.info("Preferred backoff ready but transport state is closed; not attempting a connection.");return}if(this._backoffStartTime.preferred===null){this._log.info("Preferred backoff start time invalid; not attempting a connection.");return}if(Date.now()-this._backoffStartTime.preferred>this._options.maxPreferredDurationMs){this._log.info("Max preferred backoff attempt time exceeded; falling back to primary backoff."),this._preferredUri=null,this._backoff.primary.backoff();return}if(typeof this._preferredUri!="string"){this._log.info("Preferred URI cleared; falling back to primary backoff."),this._preferredUri=null,this._backoff.primary.backoff();return}this._connect(this._preferredUri,r+1)});const n={factor:2,jitter:.4,max:this._options.maxPrimaryDelayMs,min:this._uris&&this._uris.length>1?Math.floor(Math.random()*(5e3-1e3+1))+1e3:100};this._log.info("Initializing primary transport backoff using config: ",n);const o=new et(n);return o.on("backoff",(r,s)=>{if(this.state===Y.Closed){this._log.info("Primary backoff initiated but transport state is closed; not attempting a connection.");return}this._log.info(`Will attempt to reconnect WebSocket in ${s}ms`),r===0&&(this._backoffStartTime.primary=Date.now(),this._log.info(`Primary backoff start; ${this._backoffStartTime.primary}`))}),o.on("ready",(r,s)=>{if(this.state===Y.Closed){this._log.info("Primary backoff ready but transport state is closed; not attempting a connection.");return}if(this._backoffStartTime.primary===null){this._log.info("Primary backoff start time invalid; not attempting a connection.");return}if(Date.now()-this._backoffStartTime.primary>this._options.maxPrimaryDurationMs){this._log.info("Max primary backoff attempt time exceeded; not attempting a connection.");return}this._connect(this._uris[this._uriIndex],r+1)}),{preferred:i,primary:o}}get uri(){return this._connectedUri}}Ze.defaultConstructorOptions={WebSocket:Ce,connectTimeoutMs:vs,maxPreferredDelayMs:Ss,maxPreferredDurationMs:ys,maxPrimaryDelayMs:ws,maxPrimaryDurationMs:bs};const Cs="1.6",Ts=30;class $ extends ie.EventEmitter{constructor(e,i,n){if(super(),!(this instanceof $))return new $(e,i,n);const o={TransportFactory:Ze};n=n||{};for(const s in o)s in n||(n[s]=o[s]);this.options=n,this.token=e||"",this.status="disconnected",this.gateway=null,this.region=null,this._messageQueue=[],this._preferredUri=null,this._uris=i,this._handleTransportClose=this._handleTransportClose.bind(this),this._handleTransportError=this._handleTransportError.bind(this),this._handleTransportMessage=this._handleTransportMessage.bind(this),this._handleTransportOpen=this._handleTransportOpen.bind(this),this._log=new B("PStream"),this.on("error",()=>{this._log.warn("Unexpected error handled in pstream")});const r=this;return this.addListener("ready",()=>{r.status="ready"}),this.addListener("offline",()=>{r.status="offline"}),this.addListener("close",()=>{r._log.info('Received "close" from server. Destroying PStream...'),r._destroy()}),this.transport=new this.options.TransportFactory(this._uris,{backoffMaxMs:this.options.backoffMaxMs,maxPreferredDurationMs:this.options.maxPreferredDurationMs}),Object.defineProperties(this,{uri:{enumerable:!0,get(){return this.transport.uri}}}),this.transport.on("close",this._handleTransportClose),this.transport.on("error",this._handleTransportError),this.transport.on("message",this._handleTransportMessage),this.transport.on("open",this._handleTransportOpen),this.transport.open(),this}}$.prototype._handleTransportClose=function(){this.emit("transportClose"),this.status!=="disconnected"&&(this.status!=="offline"&&this.emit("offline",this),this.status="disconnected")};$.prototype._handleTransportError=function(t){if(!t){this.emit("error",{error:{code:31e3,message:"Websocket closed without a provided reason",twilioError:new te.ConnectionDisconnected}});return}this.emit("error",typeof t.code<"u"?{error:t}:t)};$.prototype._handleTransportMessage=function(t){if(!t||!t.data||typeof t.data!="string")return;const{type:e,payload:i={}}=JSON.parse(t.data);this.gateway=i.gateway||this.gateway,this.region=i.region||this.region,e==="error"&&i.error&&(i.error.twilioError=new te.ConnectionError),this.emit(e,i)};$.prototype._handleTransportOpen=function(){this.status="connected",this.setToken(this.token),this.emit("transportOpen"),this._messageQueue.splice(0,this._messageQueue.length).forEach(e=>this._publish(...e))};$.toString=()=>"[Twilio.PStream class]";$.prototype.toString=()=>"[Twilio.PStream instance]";$.prototype.setToken=function(t){this._log.info("Setting token and publishing listen"),this.token=t;let e=0;const i=this.options.maxPreferredDurationMs;this._log.info(`maxPreferredDurationMs:${i}`),typeof i=="number"&&i>=0&&(e=Math.min(Math.ceil(i/1e3),Ts)),this._log.info(`reconnectTimeout:${e}`);const n={browserinfo:xs(),reconnectTimeout:e,token:t};this._publish("listen",n)};$.prototype.sendMessage=function(t,e,i="application/json",n,o){const r={callsid:t,content:e,contenttype:i,messagetype:n,voiceeventsid:o};this._publish("message",r,!0)};$.prototype.register=function(t){const e={media:t};this._publish("register",e,!0)};$.prototype.invite=function(t,e,i){const n={callsid:e,sdp:t,twilio:i?{params:i}:{}};this._publish("invite",n,!0)};$.prototype.reconnect=function(t,e,i){const n={callsid:e,reconnect:i,sdp:t,twilio:{}};this._publish("invite",n,!0)};$.prototype.answer=function(t,e){this._publish("answer",{sdp:t,callsid:e},!0)};$.prototype.dtmf=function(t,e){this._publish("dtmf",{callsid:t,dtmf:e},!0)};$.prototype.hangup=function(t,e){const i=e?{callsid:t,message:e}:{callsid:t};this._publish("hangup",i,!0)};$.prototype.reject=function(t){this._publish("reject",{callsid:t},!0)};$.prototype.reinvite=function(t,e){this._publish("reinvite",{sdp:t,callsid:e},!1)};$.prototype._destroy=function(){this.transport.removeListener("close",this._handleTransportClose),this.transport.removeListener("error",this._handleTransportError),this.transport.removeListener("message",this._handleTransportMessage),this.transport.removeListener("open",this._handleTransportOpen),this.transport.close(),this.emit("offline",this)};$.prototype.destroy=function(){return this._log.info("PStream.destroy() called..."),this._destroy(),this};$.prototype.updatePreferredURI=function(t){this._preferredUri=t,this.transport.updatePreferredURI(t)};$.prototype.updateURIs=function(t){this._uris=t,this.transport.updateURIs(this._uris)};$.prototype.publish=function(t,e){return this._publish(t,e,!0)};$.prototype._publish=function(t,e,i){const n=JSON.stringify({payload:e,type:t,version:Cs});!!this.transport.send(n)||(this.emit("error",{error:{code:31009,message:"No transport available to send or receive messages",twilioError:new z.TransportError}}),i&&this._messageQueue.push([t,e,!0]))};function xs(){const t=typeof navigator<"u"?navigator:{};return{browser:{platform:t.platform||"unknown",userAgent:t.userAgent||"unknown"},p:"browser",plugin:"rtc",v:Ee}}var N;(function(t){t.Sydney="sydney",t.SaoPaulo="sao-paulo",t.Dublin="dublin",t.Frankfurt="frankfurt",t.Tokyo="tokyo",t.Singapore="singapore",t.Ashburn="ashburn",t.Umatilla="umatilla",t.Roaming="roaming",t.AshburnIx="ashburn-ix",t.SanJoseIx="san-jose-ix",t.LondonIx="london-ix",t.FrankfurtIx="frankfurt-ix",t.SingaporeIx="singapore-ix",t.SydneyIx="sydney-ix",t.TokyoIx="tokyo-ix"})(N||(N={}));var A;(function(t){t.Au1="au1",t.Au1Ix="au1-ix",t.Br1="br1",t.De1="de1",t.De1Ix="de1-ix",t.Gll="gll",t.Ie1="ie1",t.Ie1Ix="ie1-ix",t.Ie1Tnx="ie1-tnx",t.Jp1="jp1",t.Jp1Ix="jp1-ix",t.Sg1="sg1",t.Sg1Ix="sg1-ix",t.Sg1Tnx="sg1-tnx",t.Us1="us1",t.Us1Ix="us1-ix",t.Us1Tnx="us1-tnx",t.Us2="us2",t.Us2Ix="us2-ix",t.Us2Tnx="us2-tnx"})(A||(A={}));const ks={ASIAPAC_SINGAPORE:A.Sg1,ASIAPAC_SYDNEY:A.Au1,ASIAPAC_TOKYO:A.Jp1,EU_FRANKFURT:A.De1,EU_IRELAND:A.Ie1,SOUTH_AMERICA_SAO_PAULO:A.Br1,US_EAST_VIRGINIA:A.Us1,US_WEST_OREGON:A.Us2},Is={[A.Au1]:N.Sydney,[A.Br1]:N.SaoPaulo,[A.Ie1]:N.Dublin,[A.De1]:N.Frankfurt,[A.Jp1]:N.Tokyo,[A.Sg1]:N.Singapore,[A.Us1]:N.Ashburn,[A.Us2]:N.Umatilla,[A.Gll]:N.Roaming,[A.Us1Ix]:N.AshburnIx,[A.Us2Ix]:N.SanJoseIx,[A.Ie1Ix]:N.LondonIx,[A.De1Ix]:N.FrankfurtIx,[A.Sg1Ix]:N.SingaporeIx,[A.Au1Ix]:N.SydneyIx,[A.Jp1Ix]:N.TokyoIx,[A.Us1Tnx]:N.AshburnIx,[A.Us2Tnx]:N.AshburnIx,[A.Ie1Tnx]:N.LondonIx,[A.Sg1Tnx]:N.SingaporeIx},Es=N.Roaming,Ps="eventgw.twilio.com";function Ft(t){return`voice-js.${t}.twilio.com`}function Nt(t){return t?`eventgw.${t}.twilio.com`:Ps}function Vt(t){return`wss://${t}/signal`}function Ht(t){if(t&&typeof t!="string"&&!Array.isArray(t))throw new L("If `edge` is provided, it must be of type `string` or an array of strings.");let e;return t?e=(Array.isArray(t)?t:[t]).map(n=>Ft(n)):e=[Ft(Es)],e}function As(t){return ks[t]||null}const Wt={0:"PCMU",8:"PCMA"},Rs=111,Ds=51e4,Ls=6e3;function Ms(t){const[,e,i]=/a=rtpmap:(\d+) (\S+)/m.exec(t)||[null,"",""],n=new RegExp(`a=fmtp:${e} (\\S+)`,"m"),[,o]=n.exec(t)||[null,""];return{codecName:i,codecParams:o}}function Os(t){return gt(window,window.navigator)?t.split(`
`).filter(e=>e.indexOf("a=ice-lite")===-1).join(`
`):t}function Ti(t,e){if(typeof e!="number"||e<Ls||e>Ds)return t;const i=/a=rtpmap:(\d+) opus/m.exec(t),n=i&&i.length?i[1]:Rs,o=new RegExp(`a=fmtp:${n}`);return t.split(`
`).map(s=>o.test(s)?s+`;maxaveragebitrate=${e}`:s).join(`
`)}function xi(t,e){const i=$s(t);return[t.split(`\r
m=`)[0]].concat(i.map(o=>{if(!/^m=(audio|video)/.test(o))return o;const r=o.match(/^m=(audio|video)/)[1],s=js(o),a=Us(s,e),l=Fs(a,o),c=s.get("pcma")||[],u=s.get("pcmu")||[];return(r==="audio"?new Set(c.concat(u)):new Set).has(a[0])?l.replace(/\r\nb=(AS|TIAS):([0-9]+)/g,""):l})).join(`\r
`)}function $s(t,e,i){return t.replace(/\r\n\r\n$/,`\r
`).split(`\r
m=`).slice(1).map(n=>`m=${n}`).filter(n=>{const o=new RegExp("m=.*","gm"),r=new RegExp("a=.*","gm");return o.test(n)&&r.test(n)})}function js(t){return Array.from(Ns(t)).reduce((e,i)=>{const n=i[0],o=i[1],r=e.get(o)||[];return e.set(o,r.concat(n))},new Map)}function Us(t,e){e=e.map(r=>r.toLowerCase());const i=st(e,r=>t.get(r)||[]),n=mt(Array.from(t.keys()),e),o=st(n,r=>t.get(r));return i.concat(o)}function Fs(t,e){const i=e.split(`\r
`);let n=i[0];const o=i.slice(1);return n=n.replace(/([0-9]+\s?)+$/,t.join(" ")),[n].concat(o).join(`\r
`)}function Ns(t){return Vs(t).reduce((e,i)=>{const n=new RegExp(`a=rtpmap:${i} ([^/]+)`),o=t.match(n),r=o?o[1].toLowerCase():Wt[i]?Wt[i].toLowerCase():"";return e.set(i,r)},new Map)}function Vs(t){const i=t.split(`\r
`)[0].match(/([0-9]+)/g);return i?i.slice(1).map(n=>parseInt(n,10)):[]}function ee(t){if(this.log=new B("RTCPC"),typeof window>"u"){this.log.info("No RTCPeerConnection implementation available. The window object was not found.");return}t&&t.RTCPeerConnection?this.RTCPeerConnection=t.RTCPeerConnection:typeof window.RTCPeerConnection=="function"?this.RTCPeerConnection=window.RTCPeerConnection:typeof window.webkitRTCPeerConnection=="function"?this.RTCPeerConnection=webkitRTCPeerConnection:typeof window.mozRTCPeerConnection=="function"?(this.RTCPeerConnection=mozRTCPeerConnection,window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate):this.log.info("No RTCPeerConnection implementation available")}ee.prototype.create=function(t){this.pc=new this.RTCPeerConnection(t)};ee.prototype.createModernConstraints=t=>{if(typeof t>"u")return null;const e=Object.assign({},t);return typeof webkitRTCPeerConnection<"u"&&!Ke()?(e.mandatory={},typeof t.audio<"u"&&(e.mandatory.OfferToReceiveAudio=t.audio),typeof t.video<"u"&&(e.mandatory.OfferToReceiveVideo=t.video)):(typeof t.audio<"u"&&(e.offerToReceiveAudio=t.audio),typeof t.video<"u"&&(e.offerToReceiveVideo=t.video)),delete e.audio,delete e.video,e};ee.prototype.createOffer=function(t,e,i,n){return e=this.createModernConstraints(e),Ii(this.pc.createOffer,this.pc)(e).then(o=>{if(!this.pc)return Promise.resolve();const r=Ti(o.sdp,t);return Xe(this.pc.setLocalDescription,this.pc)(new RTCSessionDescription({sdp:r,type:"offer"}))}).then(i,n)};ee.prototype.createAnswer=function(t,e,i,n){return e=this.createModernConstraints(e),Ii(this.pc.createAnswer,this.pc)(e).then(o=>{if(!this.pc)return Promise.resolve();const r=Ti(o.sdp,t);return Xe(this.pc.setLocalDescription,this.pc)(new RTCSessionDescription({sdp:r,type:"answer"}))}).then(i,n)};ee.prototype.processSDP=function(t,e,i,n,o,r){i=xi(i,e);const s=new RTCSessionDescription({sdp:i,type:"offer"});return Xe(this.pc.setRemoteDescription,this.pc)(s).then(()=>{this.createAnswer(t,n,o,r)})};ee.prototype.getSDP=function(){return this.pc.localDescription.sdp};ee.prototype.processAnswer=function(t,e,i,n){return this.pc?(e=xi(e,t),Xe(this.pc.setRemoteDescription,this.pc)(new RTCSessionDescription({sdp:e,type:"answer"})).then(i,n)):Promise.resolve()};ee.test=()=>{if(typeof navigator=="object"){const t=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(Ke(navigator))return!1;if(t&&typeof window.RTCPeerConnection=="function")return!0;if(t&&typeof window.webkitRTCPeerConnection=="function")return!0;if(t&&typeof window.mozRTCPeerConnection=="function"){try{if(typeof new window.mozRTCPeerConnection().getLocalStreams!="function")return!1}catch{return!1}return!0}else if(typeof RTCIceGatherer<"u")return!0}return!1};function ki(t,e,i,n){return function(){const o=Array.prototype.slice.call(arguments);return new Promise(r=>{const s=t.apply(e,o);if(!n){r(s);return}if(typeof s=="object"&&typeof s.then=="function")r(s);else throw new Error}).catch(()=>new Promise((r,s)=>{t.apply(e,i?[r,s].concat(o):o.concat([r,s]))}))}}function Ii(t,e){return ki(t,e,!0,!0)}function Xe(t,e){return ki(t,e,!1,!1)}const Hs=15e3,Ws="none",Bs="timeout",Gs="new",Bt=50;function C(t,e,i){if(!t||!e)throw new L("Audiohelper, and pstream are required arguments");if(!(this instanceof C))return new C(t,e,i);this._log=new B("PeerConnection");function n(){this._log.warn("Unexpected noop call in peerconnection")}this.onaudio=n,this.onopen=n,this.onerror=n,this.onclose=n,this.ondisconnected=n,this.onfailed=n,this.onconnected=n,this.onreconnected=n,this.onsignalingstatechange=n,this.ondtlstransportstatechange=n,this.onicegatheringfailure=n,this.onicegatheringstatechange=n,this.oniceconnectionstatechange=n,this.onpcconnectionstatechange=n,this.onicecandidate=n,this.onselectedcandidatepairchange=n,this.onvolume=n,this.version=null,this.pstream=e,this.stream=null,this.sinkIds=new Set(["default"]),this.outputs=new Map,this.status="connecting",this.callSid=null,this.isMuted=!1;const o=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);return this._isSinkSupported=!!o&&typeof HTMLAudioElement<"u"&&HTMLAudioElement.prototype.setSinkId,this._audioContext=o&&t._audioContext,this._audioHelper=t,this._hasIceCandidates=!1,this._hasIceGatheringFailures=!1,this._iceGatheringTimeoutId=null,this._masterAudio=null,this._masterAudioDeviceId=null,this._mediaStreamSource=null,this._dtmfSender=null,this._dtmfSenderUnsupported=!1,this._callEvents=[],this._nextTimeToPublish=Date.now(),this._onAnswerOrRinging=n,this._onHangup=n,this._remoteStream=null,this._shouldManageStream=!0,this._iceState=Gs,this.options=i=i||{},this.navigator=i.navigator||(typeof navigator<"u"?navigator:null),this.util=i.util||bi,this.codecPreferences=i.codecPreferences,this}C.prototype.uri=function(){return this._uri};C.prototype.openDefaultDeviceWithConstraints=function(t){return this._audioHelper._openDefaultDeviceWithConstraints(t).then(this._setInputTracksFromStream.bind(this,!1))};C.prototype.setInputTracksFromStream=function(t){const e=this;return this._setInputTracksFromStream(!0,t).then(()=>{e._shouldManageStream=!1})};C.prototype._createAnalyser=(t,e)=>{e=Object.assign({fftSize:32,smoothingTimeConstant:.3},e);const i=t.createAnalyser();for(const n in e)i[n]=e[n];return i};C.prototype._setVolumeHandler=function(t){this.onvolume=t};C.prototype._startPollingVolume=function(){if(!this._audioContext||!this.stream||!this._remoteStream)return;const t=this._audioContext,i=(this._inputAnalyser=this._createAnalyser(t)).frequencyBinCount,n=new Uint8Array(i);this._inputAnalyser2=this._createAnalyser(t,{maxDecibels:0,minDecibels:-127,smoothingTimeConstant:0});const r=(this._outputAnalyser=this._createAnalyser(t)).frequencyBinCount,s=new Uint8Array(r);this._outputAnalyser2=this._createAnalyser(t,{maxDecibels:0,minDecibels:-127,smoothingTimeConstant:0}),this._updateInputStreamSource(this.stream),this._updateOutputStreamSource(this._remoteStream);const a=this;setTimeout(function l(){if(a._audioContext){if(a.status==="closed"){a._inputAnalyser.disconnect(),a._outputAnalyser.disconnect(),a._inputAnalyser2.disconnect(),a._outputAnalyser2.disconnect();return}}else return;a._inputAnalyser.getByteFrequencyData(n);const c=a.util.average(n);a._inputAnalyser2.getByteFrequencyData(n);const u=a.util.average(n);a._outputAnalyser.getByteFrequencyData(s);const d=a.util.average(s);a._outputAnalyser2.getByteFrequencyData(s);const h=a.util.average(s);a.onvolume(c/255,d/255,u,h),setTimeout(l,Bt)},Bt)};C.prototype._stopStream=function(){this._shouldManageStream&&this._audioHelper._stopDefaultInputDeviceStream()};C.prototype._updateInputStreamSource=function(t){this._inputStreamSource&&this._inputStreamSource.disconnect();try{this._inputStreamSource=this._audioContext.createMediaStreamSource(t),this._inputStreamSource.connect(this._inputAnalyser),this._inputStreamSource.connect(this._inputAnalyser2)}catch(e){this._log.warn("Unable to update input MediaStreamSource",e),this._inputStreamSource=null}};C.prototype._updateOutputStreamSource=function(t){this._outputStreamSource&&this._outputStreamSource.disconnect();try{this._outputStreamSource=this._audioContext.createMediaStreamSource(t),this._outputStreamSource.connect(this._outputAnalyser),this._outputStreamSource.connect(this._outputAnalyser2)}catch(e){this._log.warn("Unable to update output MediaStreamSource",e),this._outputStreamSource=null}};C.prototype._setInputTracksFromStream=function(t,e){if(!e)return Promise.reject(new L("Can not set input stream to null while in a call"));if(!e.getAudioTracks().length)return Promise.reject(new L("Supplied input stream has no audio tracks"));const i=this.stream,n=()=>(this.mute(this.isMuted),Promise.resolve(this.stream));if(!i)this.stream=t?Gt(e,this.options.MediaStream):e;else return this._shouldManageStream&&this._stopStream(),this._sender||(this._sender=this.version.pc.getSenders()[0]),this._sender.replaceTrack(e.getAudioTracks()[0]).then(()=>(this._updateInputStreamSource(e),this.stream=t?Gt(e,this.options.MediaStream):e,n()));return n()};C.prototype._onInputDevicesChanged=function(){if(!this.stream)return;this.stream.getAudioTracks().every(e=>e.readyState==="ended")&&this._shouldManageStream&&this.openDefaultDeviceWithConstraints({audio:!0})};C.prototype._onIceGatheringFailure=function(t){this._hasIceGatheringFailures=!0,this.onicegatheringfailure(t)};C.prototype._onMediaConnectionStateChange=function(t){const e=this._iceState;if(e===t||t!=="connected"&&t!=="disconnected"&&t!=="failed")return;this._iceState=t;let i;switch(t){case"connected":e==="disconnected"||e==="failed"?(i="ICE liveliness check succeeded. Connection with Twilio restored",this._log.info(i),this.onreconnected(i)):(i="Media connection established.",this._log.info(i),this.onconnected(i)),this._stopIceGatheringTimeout(),this._hasIceGatheringFailures=!1;break;case"disconnected":i="ICE liveliness check failed. May be having trouble connecting to Twilio",this._log.warn(i),this.ondisconnected(i);break;case"failed":i="Connection with Twilio was interrupted.",this._log.warn(i),this.onfailed(i);break}};C.prototype._setSinkIds=function(t){return this._isSinkSupported?(this.sinkIds=new Set(t.forEach?t:[t]),this.version?this._updateAudioOutputs():Promise.resolve()):Promise.reject(new G("Audio output selection is not supported by this browser"))};C.prototype._startIceGatheringTimeout=function(){this._stopIceGatheringTimeout(),this._iceGatheringTimeoutId=setTimeout(()=>{this._onIceGatheringFailure(Bs)},Hs)};C.prototype._stopIceGatheringTimeout=function(){clearInterval(this._iceGatheringTimeoutId)};C.prototype._updateAudioOutputs=function(){const e=Array.from(this.sinkIds).filter(function(r){return!this.outputs.has(r)},this),i=Array.from(this.outputs.keys()).filter(function(r){return!this.sinkIds.has(r)},this),n=this,o=e.map(this._createAudioOutput,this);return Promise.all(o).then(()=>Promise.all(i.map(n._removeAudioOutput,n)))};C.prototype._createAudio=function(e){const i=new Audio(e);return this.onaudio(i),i};C.prototype._createAudioOutput=function(e){let i=null;this._mediaStreamSource&&(i=this._audioContext.createMediaStreamDestination(),this._mediaStreamSource.connect(i));const n=this._createAudio();vt(n,i&&i.stream?i.stream:this.pcStream);const o=this;return n.setSinkId(e).then(()=>n.play()).then(()=>{o.outputs.set(e,{audio:n,dest:i})})};C.prototype._removeAudioOutputs=function(){return this._masterAudio&&typeof this._masterAudioDeviceId<"u"&&(this._disableOutput(this,this._masterAudioDeviceId),this.outputs.delete(this._masterAudioDeviceId),this._masterAudioDeviceId=null,this._masterAudio.paused||this._masterAudio.pause(),typeof this._masterAudio.srcObject<"u"?this._masterAudio.srcObject=null:this._masterAudio.src="",this._masterAudio=null),Array.from(this.outputs.keys()).map(this._removeAudioOutput,this)};C.prototype._disableOutput=function(e,i){const n=e.outputs.get(i);n&&(n.audio&&(n.audio.pause(),n.audio.src=""),n.dest&&n.dest.disconnect())};C.prototype._reassignMasterOutput=function(e,i){const n=e.outputs.get(i);e.outputs.delete(i);const o=this,r=Array.from(e.outputs.keys())[0],s=typeof r=="string"?r:"default";return n.audio.setSinkId(s).then(()=>{o._disableOutput(e,s),e.outputs.set(s,n),e._masterAudioDeviceId=s}).catch(function(){e.outputs.set(i,n),o._log.info("Could not reassign master output. Attempted to roll back.")})};C.prototype._removeAudioOutput=function(e){return this._masterAudioDeviceId===e?this._reassignMasterOutput(this,e):(this._disableOutput(this,e),this.outputs.delete(e),Promise.resolve())};C.prototype._onAddTrack=function(e,i){const n=e._masterAudio=this._createAudio();vt(n,i),n.play();const o=Array.from(e.outputs.keys())[0],r=typeof o=="string"?o:"default";e._masterAudioDeviceId=r,e.outputs.set(r,{audio:n});try{e._mediaStreamSource=e._audioContext.createMediaStreamSource(i)}catch(s){this._log.warn("Unable to create a MediaStreamSource from onAddTrack",s),this._mediaStreamSource=null}e.pcStream=i,e._updateAudioOutputs()};C.prototype._fallbackOnAddTrack=function(e,i){const n=document&&document.createElement("audio");n.autoplay=!0,vt(n,i)||e._log.info("Error attaching stream to element."),e.outputs.set("default",{audio:n})};C.prototype._setEncodingParameters=function(t){if(!t||!this._sender||typeof this._sender.getParameters!="function"||typeof this._sender.setParameters!="function")return;const e=this._sender.getParameters();!e.priority&&!(e.encodings&&e.encodings.length)||(e.priority="high",e.encodings&&e.encodings.length&&e.encodings.forEach(i=>{i.priority="high",i.networkPriority="high"}),this._sender.setParameters(e))};C.prototype._setupPeerConnection=function(t){const e=this,i=new(this.options.rtcpcFactory||ee)({RTCPeerConnection:this.options.RTCPeerConnection});i.create(t),qs(i.pc,this.stream);const n=RTCRtpReceiver.getCapabilities("audio").codecs;this._log.debug("sorting codecs",n,this.codecPreferences);const o=yi(n,this.codecPreferences),[r]=i.pc.getTransceivers();this._log.debug("setting sorted codecs",o),r.setCodecPreferences(o);const s="ontrack"in i.pc?"ontrack":"onaddstream";return i.pc[s]=a=>{const l=e._remoteStream=a.stream||a.streams[0];typeof i.pc.getSenders=="function"&&(this._sender=i.pc.getSenders()[0]),e._isSinkSupported?e._onAddTrack(e,l):e._fallbackOnAddTrack(e,l),e._startPollingVolume()},i};C.prototype._maybeSetIceAggressiveNomination=function(t){return this.options.forceAggressiveIceNomination?Os(t):t};C.prototype._setupChannel=function(){const t=this.version.pc;this.version.pc.onopen=()=>{this.status="open",this.onopen()},this.version.pc.onstatechange=()=>{this.version.pc&&this.version.pc.readyState==="stable"&&(this.status="open",this.onopen())},this.version.pc.onsignalingstatechange=()=>{const e=t.signalingState;this._log.info(`signalingState is "${e}"`),this.version.pc&&this.version.pc.signalingState==="stable"&&(this.status="open",this.onopen()),this.onsignalingstatechange(t.signalingState)},t.onconnectionstatechange=e=>{let i=t.connectionState;if(!i&&e&&e.target){const n=e.target;i=n.connectionState||n.connectionState_,this._log.info(`pc.connectionState not detected. Using target PC. State=${i}`)}i?this._log.info(`pc.connectionState is "${i}"`):this._log.warn(`onconnectionstatechange detected but state is "${i}"`),this.onpcconnectionstatechange(i),this._onMediaConnectionStateChange(i)},t.onicecandidate=e=>{const{candidate:i}=e;i&&(this._hasIceCandidates=!0,this.onicecandidate(i),this._setupRTCIceTransportListener()),this._log.info(`ICE Candidate: ${JSON.stringify(i)}`)},t.onicegatheringstatechange=()=>{const e=t.iceGatheringState;e==="gathering"?this._startIceGatheringTimeout():e==="complete"&&(this._stopIceGatheringTimeout(),this._hasIceCandidates||this._onIceGatheringFailure(Ws),this._hasIceCandidates&&this._hasIceGatheringFailures&&this._startIceGatheringTimeout()),this._log.info(`pc.iceGatheringState is "${t.iceGatheringState}"`),this.onicegatheringstatechange(e)},t.oniceconnectionstatechange=()=>{this._log.info(`pc.iceConnectionState is "${t.iceConnectionState}"`),this.oniceconnectionstatechange(t.iceConnectionState),this._onMediaConnectionStateChange(t.iceConnectionState)}};C.prototype._initializeMediaStream=function(t){return this.status==="open"?!1:this.pstream.status==="disconnected"?(this.onerror({info:{code:31e3,message:"Cannot establish connection. Client is disconnected",twilioError:new te.ConnectionDisconnected}}),this.close(),!1):(this.version=this._setupPeerConnection(t),this._setupChannel(),!0)};C.prototype._removeReconnectionListeners=function(){this.pstream&&(this.pstream.removeListener("answer",this._onAnswerOrRinging),this.pstream.removeListener("hangup",this._onHangup))};C.prototype._setupRTCDtlsTransportListener=function(){const t=this.getRTCDtlsTransport();if(!t||t.onstatechange)return;const e=()=>{this._log.info(`dtlsTransportState is "${t.state}"`),this.ondtlstransportstatechange(t.state)};e(),t.onstatechange=e};C.prototype._setupRTCIceTransportListener=function(){const t=this._getRTCIceTransport();!t||t.onselectedcandidatepairchange||(t.onselectedcandidatepairchange=()=>this.onselectedcandidatepairchange(t.getSelectedCandidatePair()))};C.prototype.iceRestart=function(){this._log.info("Attempting to restart ICE..."),this._hasIceCandidates=!1,this.version.createOffer(this.options.maxAverageBitrate,{iceRestart:!0}).then(()=>{this._removeReconnectionListeners(),this._onAnswerOrRinging=t=>{if(this._removeReconnectionListeners(),!t.sdp||this.version.pc.signalingState!=="have-local-offer"){const i=`Invalid state or param during ICE Restart:hasSdp:${!!t.sdp}, signalingState:${this.version.pc.signalingState}`;this._log.warn(i);return}const e=this._maybeSetIceAggressiveNomination(t.sdp);this._answerSdp=e,this.status!=="closed"&&this.version.processAnswer(this.codecPreferences,e,null,i=>{const n=i&&i.message?i.message:i;this._log.error(`Failed to process answer during ICE Restart. Error: ${n}`)})},this._onHangup=()=>{this._log.info("Received hangup during ICE Restart"),this._removeReconnectionListeners()},this.pstream.on("answer",this._onAnswerOrRinging),this.pstream.on("hangup",this._onHangup),this.pstream.reinvite(this.version.getSDP(),this.callSid)}).catch(t=>{const e=t&&t.message?t.message:t;this._log.error(`Failed to createOffer during ICE Restart. Error: ${e}`),this.onfailed(e)})};C.prototype.makeOutgoingCall=function(t,e,i,n,o){if(!this._initializeMediaStream(n))return;const r=this;this.callSid=i;function s(){r.options&&r._setEncodingParameters(r.options.dscp),o(r.version.pc)}function a(u){const d=u.message||u;r.onerror({info:{code:31e3,message:`Error processing answer: ${d}`,twilioError:new re.ClientRemoteDescFailed}})}this._onAnswerOrRinging=u=>{if(!u.sdp)return;const d=this._maybeSetIceAggressiveNomination(u.sdp);r._answerSdp=d,r.status!=="closed"&&r.version.processAnswer(this.codecPreferences,d,s,a),r.pstream.removeListener("answer",r._onAnswerOrRinging),r.pstream.removeListener("ringing",r._onAnswerOrRinging)},this.pstream.on("answer",this._onAnswerOrRinging),this.pstream.on("ringing",this._onAnswerOrRinging);function l(){r.status!=="closed"&&(e?r.pstream.reconnect(r.version.getSDP(),r.callSid,e):r.pstream.invite(r.version.getSDP(),r.callSid,t),r._setupRTCDtlsTransportListener())}function c(u){const d=u.message||u;r.onerror({info:{code:31e3,message:`Error creating the offer: ${d}`,twilioError:new re.ClientLocalDescFailed}})}this.version.createOffer(this.options.maxAverageBitrate,{audio:!0},l,c)};C.prototype.answerIncomingCall=function(t,e,i,n){if(!this._initializeMediaStream(i))return;e=this._maybeSetIceAggressiveNomination(e),this._answerSdp=e.replace(/^a=setup:actpass$/gm,"a=setup:passive"),this.callSid=t;const o=this;function r(){o.status!=="closed"&&(o.pstream.answer(o.version.getSDP(),t),o.options&&o._setEncodingParameters(o.options.dscp),n(o.version.pc),o._setupRTCDtlsTransportListener())}function s(a){const l=a.message||a;o.onerror({info:{code:31e3,message:`Error creating the answer: ${l}`,twilioError:new re.ClientRemoteDescFailed}})}this.version.processSDP(this.options.maxAverageBitrate,this.codecPreferences,e,{audio:!0},r,s)};C.prototype.close=function(){this.version&&this.version.pc&&(this.version.pc.signalingState!=="closed"&&this.version.pc.close(),this.version.pc=null),this.stream&&(this.mute(!1),this._stopStream()),this.stream=null,this._removeReconnectionListeners(),this._stopIceGatheringTimeout(),Promise.all(this._removeAudioOutputs()).catch(()=>{}),this._mediaStreamSource&&this._mediaStreamSource.disconnect(),this._inputAnalyser&&this._inputAnalyser.disconnect(),this._outputAnalyser&&this._outputAnalyser.disconnect(),this._inputAnalyser2&&this._inputAnalyser2.disconnect(),this._outputAnalyser2&&this._outputAnalyser2.disconnect(),this.status="closed",this.onclose()};C.prototype.reject=function(t){this.callSid=t};C.prototype.ignore=function(t){this.callSid=t};C.prototype.mute=function(t){this.isMuted=t,this.stream&&(this._sender&&this._sender.track?this._sender.track.enabled=!t:(typeof this.stream.getAudioTracks=="function"?this.stream.getAudioTracks():this.stream.audioTracks).forEach(i=>{i.enabled=!t}))};C.prototype.getOrCreateDTMFSender=function(){if(this._dtmfSender||this._dtmfSenderUnsupported)return this._dtmfSender||null;const e=this,i=this.version.pc;if(!i)return this._log.warn("No RTCPeerConnection available to call createDTMFSender on"),null;if(typeof i.getSenders=="function"&&(typeof RTCDTMFSender=="function"||typeof RTCDtmfSender=="function")){const n=i.getSenders().find(o=>o.dtmf);if(n)return this._log.info("Using RTCRtpSender#dtmf"),this._dtmfSender=n.dtmf,this._dtmfSender}if(typeof i.createDTMFSender=="function"&&typeof i.getLocalStreams=="function"){const n=i.getLocalStreams().map(o=>{const r=e._getAudioTracks(o);return r&&r[0]})[0];return n?(this._log.info("Creating RTCDTMFSender"),this._dtmfSender=i.createDTMFSender(n),this._dtmfSender):(this._log.warn("No local audio MediaStreamTrack available on the RTCPeerConnection to pass to createDTMFSender"),null)}return this._log.info("RTCPeerConnection does not support RTCDTMFSender"),this._dtmfSenderUnsupported=!0,null};C.prototype.getRTCDtlsTransport=function(){const e=this.version&&this.version.pc&&typeof this.version.pc.getSenders=="function"&&this.version.pc.getSenders()[0];return e&&e.transport||null};C.prototype._canStopMediaStreamTrack=()=>typeof MediaStreamTrack.prototype.stop=="function";C.prototype._getAudioTracks=t=>typeof t.getAudioTracks=="function"?t.getAudioTracks():t.audioTracks;C.prototype._getRTCIceTransport=function(){const e=this.getRTCDtlsTransport();return e&&e.iceTransport||null};C.protocol=(()=>ee.test()?new ee:null)();function qs(t,e){typeof t.addTrack=="function"?e.getAudioTracks().forEach(i=>{t.addTrack(i,e)}):t.addStream(e)}function Gt(t,e){let i;return e?i=new e:typeof MediaStream<"u"?i=new MediaStream:i=new webkitMediaStream,t.getAudioTracks().forEach(i.addTrack,i),i}function vt(t,e){if(typeof t.srcObject<"u")t.srcObject=e;else if(typeof t.mozSrcObject<"u")t.mozSrcObject=e;else if(typeof t.src<"u"){const i=t.options.window||window;t.src=(i.URL||i.webkitURL).createObjectURL(e)}else return!1;return!0}C.enabled=ee.test();function zs(){return ee.test()}function Js(){return typeof RTCIceGatherer<"u"?"ORTC":"WebRTC"}function Ks(t,e){return e=e||{},e.util=e.util||bi,e.navigator=e.navigator||(typeof navigator<"u"?navigator:null),new Promise((i,n)=>{if(!e.navigator)throw new G("getUserMedia is not supported");switch("function"){case typeof(e.navigator.mediaDevices&&e.navigator.mediaDevices.getUserMedia):return i(e.navigator.mediaDevices.getUserMedia(t));case typeof e.navigator.webkitGetUserMedia:return e.navigator.webkitGetUserMedia(t,i,n);case typeof e.navigator.mozGetUserMedia:return e.navigator.mozGetUserMedia(t,i,n);case typeof e.navigator.getUserMedia:return e.navigator.getUserMedia(t,i,n);default:throw new G("getUserMedia is not supported")}}).catch(i=>{throw e.util.isFirefox()&&i.name==="NotReadableError"?new G(`Firefox does not currently support opening multiple audio input trackssimultaneously, even across different tabs.
Related Bugzilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324`):i})}function Zs(){if(typeof window!="object")throw new G("This platform is not supported.");const{crypto:t}=window;if(typeof t!="object")throw new G("The `crypto` module is not available on this platform.");if(typeof t.getRandomValues!="function")throw new G("The function `crypto.getRandomValues` is not available on this platform.");if(typeof window.Uint8Array!="function")throw new G("The `Uint8Array` module is not available on this platform.");return t.getRandomValues(new window.Uint8Array(16)).reduce((e,i)=>`${e}${i.toString(16).padStart(2,"0")}`,"")}function lt(){return`KX${Zs()}`}let Xs=class{constructor(){this._promise=new Promise((e,i)=>{this._resolve=e,this._reject=i})}get promise(){return this._promise}reject(e){this._reject(e)}resolve(e){this._resolve(e)}};class Qs{constructor(){this._operations=[]}enqueue(e){const i=!!this._operations.length,n=new Xs;return this._operations.push({deferred:n,callback:e}),i||this._processQueue(),n.promise}_processQueue(){return K(this,void 0,void 0,function*(){for(;this._operations.length;){const{deferred:e,callback:i}=this._operations[0];let n,o,r;try{n=yield i(),r=!0}catch(s){o=s}this._operations.shift(),r?e.resolve(n):e.reject(o)}})}}class Ys{get reject(){return this._reject}get resolve(){return this._resolve}constructor(){this.promise=new Promise((e,i)=>{this._resolve=e,this._reject=i})}}class eo{constructor(){this._eventEmitter=new ie.EventEmitter}addEventListener(e,i){return this._eventEmitter.addListener(e,i)}dispatchEvent(e,...i){return this._eventEmitter.emit(e,...i)}removeEventListener(e,i){return this._eventEmitter.removeListener(e,i)}}class qt extends eo{get destination(){return this._destination}get loop(){return this._loop}set loop(e){const i=this;function n(){i._audioNode.removeEventListener("ended",n),i.pause()}!e&&this.loop&&!this.paused&&this._audioNode.addEventListener("ended",n),this._loop=e}get muted(){return this._gainNode.gain.value===0}set muted(e){this._gainNode.gain.value=e?0:1}get paused(){return this._audioNode===null}get src(){return this._src}set src(e){this._load(e)}get srcObject(){return this._audioElement.srcObject}set srcObject(e){this._audioElement.srcObject=e}get sinkId(){return this._sinkId}constructor(e,i={},n={}){super(),this._audioNode=null,this._loop=!1,this._pendingPlayDeferreds=[],this._sinkId="default",this._src="",typeof i!="string"&&(n=i),this._audioContext=e,this._audioElement=new(n.AudioFactory||Audio),this._bufferPromise=this._createPlayDeferred().promise,this._destination=this._audioContext.destination,this._gainNode=this._audioContext.createGain(),this._gainNode.connect(this._destination),this._XMLHttpRequest=n.XMLHttpRequestFactory||XMLHttpRequest,this.addEventListener("canplaythrough",()=>{this._resolvePlayDeferreds()}),typeof i=="string"&&(this.src=i)}load(){this._load(this._src)}pause(){this.paused||(this._audioElement.pause(),this._audioNode.stop(),this._audioNode.disconnect(this._gainNode),this._audioNode=null,this._rejectPlayDeferreds(new Error("The play() request was interrupted by a call to pause().")))}play(){return K(this,void 0,void 0,function*(){if(!this.paused){if(yield this._bufferPromise,!this.paused)return;throw new Error("The play() request was interrupted by a call to pause().")}this._audioNode=this._audioContext.createBufferSource(),this._audioNode.loop=this.loop,this._audioNode.addEventListener("ended",()=>{this._audioNode&&this._audioNode.loop||this.dispatchEvent("ended")});const e=yield this._bufferPromise;if(this.paused)throw new Error("The play() request was interrupted by a call to pause().");if(this._audioNode.buffer=e,this._audioNode.connect(this._gainNode),this._audioNode.start(),this._audioElement.srcObject)return this._audioElement.play()})}setSinkId(e){return K(this,void 0,void 0,function*(){if(typeof this._audioElement.setSinkId!="function")throw new Error("This browser does not support setSinkId.");if(e!==this.sinkId){if(e==="default"){this.paused||this._gainNode.disconnect(this._destination),this._audioElement.srcObject=null,this._destination=this._audioContext.destination,this._gainNode.connect(this._destination),this._sinkId=e;return}yield this._audioElement.setSinkId(e),!this._audioElement.srcObject&&(this._gainNode.disconnect(this._audioContext.destination),this._destination=this._audioContext.createMediaStreamDestination(),this._audioElement.srcObject=this._destination.stream,this._sinkId=e,this._gainNode.connect(this._destination))}})}_createPlayDeferred(){const e=new Ys;return this._pendingPlayDeferreds.push(e),e}_load(e){this._src&&this._src!==e&&this.pause(),this._src=e,this._bufferPromise=new Promise((i,n)=>K(this,void 0,void 0,function*(){if(!e)return this._createPlayDeferred().promise;const o=yield to(this._audioContext,this._XMLHttpRequest,e);this.dispatchEvent("canplaythrough"),i(o)}))}_rejectPlayDeferreds(e){const i=this._pendingPlayDeferreds;i.splice(0,i.length).forEach(({reject:n})=>n(e))}_resolvePlayDeferreds(e){const i=this._pendingPlayDeferreds;i.splice(0,i.length).forEach(({resolve:n})=>n(e))}}function to(t,e,i){return K(this,void 0,void 0,function*(){const n=new e;n.open("GET",i,!0),n.responseType="arraybuffer";const o=yield new Promise(r=>{n.addEventListener("load",r),n.send()});try{return t.decodeAudioData(o.target.response)}catch{return new Promise(s=>{t.decodeAudioData(o.target.response,s)})}})}function le(t,e,i){if(!(this instanceof le))return new le(t,e,i);if(!t||!e)throw new L("name and url are required arguments");i=Object.assign({AudioFactory:typeof Audio<"u"?Audio:null,maxDuration:0,shouldLoop:!1},i),i.AudioPlayer=i.audioContext?qt.bind(qt,i.audioContext):i.AudioFactory,Object.defineProperties(this,{_Audio:{value:i.AudioPlayer},_activeEls:{value:new Map},_isSinkSupported:{value:i.AudioFactory!==null&&typeof i.AudioFactory.prototype.setSinkId=="function"},_maxDuration:{value:i.maxDuration},_maxDurationTimeout:{value:null,writable:!0},_operations:{value:new Qs},_playPromise:{value:null,writable:!0},_shouldLoop:{value:i.shouldLoop},_sinkIds:{value:["default"]},isPlaying:{enumerable:!0,get(){return!!this._playPromise}},name:{enumerable:!0,value:t},url:{enumerable:!0,value:e}}),this._Audio&&this._play(!0,!1)}function Ei(t){t&&(t.pause(),t.src="",t.srcObject=null,t.load())}le.prototype._playAudioElement=function(e,i,n){const o=this._activeEls.get(e);if(!o)throw new L(`sinkId: "${e}" doesn't have an audio element`);return o.muted=!!i,o.loop=!!n,o.play().then(()=>o).catch(r=>{throw Ei(o),this._activeEls.delete(e),r})};le.prototype._play=function(e,i){this.isPlaying&&this._stop(),this._maxDuration>0&&(this._maxDurationTimeout=setTimeout(this._stop.bind(this),this._maxDuration)),i=typeof i=="boolean"?i:this._shouldLoop;const n=this;return this._playPromise=Promise.all(this._sinkIds.map(function(s){if(!n._Audio)return Promise.resolve();let a=n._activeEls.get(s);return a?n._playAudioElement(s,e,i):(a=new n._Audio(n.url),typeof a.setAttribute=="function"&&a.setAttribute("crossorigin","anonymous"),new Promise(l=>{a.addEventListener("canplaythrough",l)}).then(()=>(n._isSinkSupported?a.setSinkId(s):Promise.resolve()).then(function(){return n._activeEls.set(s,a),n._playPromise?n._playAudioElement(s,e,i):Promise.resolve()})))}))};le.prototype._stop=function(){this._activeEls.forEach((e,i)=>{this._sinkIds.includes(i)?(e.pause(),e.currentTime=0):(Ei(e),this._activeEls.delete(i))}),clearTimeout(this._maxDurationTimeout),this._playPromise=null,this._maxDurationTimeout=null};le.prototype.setSinkIds=function(e){this._isSinkSupported&&(e=e.forEach?e:[e],[].splice.apply(this._sinkIds,[0,this._sinkIds.length].concat(e)))};le.prototype.stop=function(){this._operations.enqueue(()=>(this._stop(),Promise.resolve()))};le.prototype.play=function(){return this._operations.enqueue(()=>this._play())};const io=3e4,no=2e3,so="twilio-js-sdk",oo='Parameter "token" must be of type "string".';class f extends ie.EventEmitter{static get audioContext(){return f._audioContext}static get extension(){const e=typeof document<"u"?document.createElement("audio"):{canPlayType:!1};let i;try{i=e.canPlayType&&!!e.canPlayType("audio/mpeg").replace(/no/,"")}catch{i=!1}let n;try{n=e.canPlayType&&!!e.canPlayType("audio/ogg;codecs='vorbis'").replace(/no/,"")}catch{n=!1}return n&&!i?"ogg":"mp3"}static get isSupported(){return zs()}static get packageName(){return gi}static runPreflight(e,i){return new j(e,Object.assign({audioContext:f._getOrCreateAudioContext()},i))}static toString(){return"[Twilio.Device class]"}static get version(){return Ee}static _getOrCreateAudioContext(){return f._audioContext||(typeof AudioContext<"u"?f._audioContext=new AudioContext:typeof webkitAudioContext<"u"&&(f._audioContext=new webkitAudioContext)),f._audioContext}constructor(e,i={}){if(super(),this._activeCall=null,this._audio=null,this._audioProcessorEventObserver=null,this._callInputStream=null,this._calls=[],this._callSinkIds=["default"],this._chunderURIs=[],this._defaultOptions={allowIncomingWhileBusy:!1,closeProtection:!1,codecPreferences:[p.Codec.PCMU,p.Codec.Opus],dscp:!0,enableImprovedSignalingErrorPrecision:!1,forceAggressiveIceNomination:!1,logLevel:$e.levels.ERROR,maxCallSignalingTimeoutMs:0,preflight:!1,sounds:{},tokenRefreshMs:1e4,voiceEventSidGenerator:lt},this._edge=null,this._home=null,this._identity=null,this._log=new B("Device"),this._makeCallPromise=null,this._options={},this._preferredURI=null,this._publisher=null,this._region=null,this._regTimer=null,this._shouldReRegister=!1,this._soundcache=new Map,this._state=f.State.Unregistered,this._stateEventMapping={[f.State.Destroyed]:f.EventName.Destroyed,[f.State.Unregistered]:f.EventName.Unregistered,[f.State.Registering]:f.EventName.Registering,[f.State.Registered]:f.EventName.Registered},this._stream=null,this._streamConnectedPromise=null,this._tokenWillExpireTimeout=null,this._createDefaultPayload=r=>{const s={aggressive_nomination:this._options.forceAggressiveIceNomination,browser_extension:this._isBrowserExtension,dscp:!!this._options.dscp,ice_restart_enabled:!0,platform:Js(),sdk_version:Ee};function a(l,c){c&&(s[l]=c)}if(r){const l=r.parameters.CallSid;a("call_sid",/^TJ/.test(l)?void 0:l),a("temp_call_sid",r.outboundConnectionId),a("audio_codec",r.codec),s.direction=r.direction}return a("gateway",this._stream&&this._stream.gateway),a("region",this._stream&&this._stream.region),s},this._onSignalingClose=()=>{this._stream=null,this._streamConnectedPromise=null},this._onSignalingConnected=r=>{var s;const a=As(r.region);if(this._edge=r.edge||Is[a]||r.region,this._region=a||r.region,this._home=r.home,(s=this._publisher)===null||s===void 0||s.setHost(Nt(r.home)),r.token&&(this._identity=r.token.identity,typeof r.token.ttl=="number"&&typeof this._options.tokenRefreshMs=="number")){const c=r.token.ttl*1e3,u=Math.max(0,c-this._options.tokenRefreshMs);this._tokenWillExpireTimeout=setTimeout(()=>{this._log.debug("#tokenWillExpire"),this.emit("tokenWillExpire",this),this._tokenWillExpireTimeout&&(clearTimeout(this._tokenWillExpireTimeout),this._tokenWillExpireTimeout=null)},u)}const l=this._getChunderws()||Ht(this._edge);if(l.length>0){const[c]=l;this._preferredURI=Vt(c)}else this._log.warn("Could not parse a preferred URI from the stream#connected event.");this._shouldReRegister&&this.register()},this._onSignalingError=r=>{if(typeof r!="object"){this._log.warn("Invalid signaling error payload",r);return}const{error:s,callsid:a,voiceeventsid:l}=r;if(typeof s!="object"||l){this._log.warn("Ignoring signaling error payload",{originalError:s,voiceeventsid:l});return}const c=typeof a=="string"&&this._findCall(a)||void 0,{code:u,message:d}=s;let{twilioError:h}=s;if(typeof u=="number")if(u===31201)h=new W.AuthenticationFailed(s);else if(u===31204)h=new W.AccessTokenInvalid(s);else if(u===31205)this._stopRegistrationTimer(),h=new W.AccessTokenExpired(s);else{const m=nt(!!this._options.enableImprovedSignalingErrorPrecision,u);typeof m<"u"&&(h=new m(s))}h||(this._log.error("Unknown signaling error: ",s),h=new z.UnknownError(d,s)),this._log.error("Received error: ",h),this._log.debug("#error",s),this.emit(f.EventName.Error,h,c)},this._onSignalingInvite=r=>K(this,void 0,void 0,function*(){var s;const a=!!this._activeCall;if(a&&!this._options.allowIncomingWhileBusy){this._log.info("Device busy; ignoring incoming invite");return}if(!r.callsid||!r.sdp){this._log.debug("#error",r),this.emit(f.EventName.Error,new ve.BadRequest("Malformed invite from gateway"));return}const l=r.parameters||{};l.CallSid=l.CallSid||r.callsid;const c=Object.assign({},vi(l.Params));this._makeCallPromise=this._makeCall(c,{callParameters:l,enableImprovedSignalingErrorPrecision:!!this._options.enableImprovedSignalingErrorPrecision,offerSdp:r.sdp,reconnectToken:r.reconnect,voiceEventSidGenerator:this._options.voiceEventSidGenerator});let u;try{u=yield this._makeCallPromise}finally{this._makeCallPromise=null}this._calls.push(u),u.once("accept",()=>{this._soundcache.get(f.SoundName.Incoming).stop(),this._publishNetworkChange()});const d=!((s=this._audio)===null||s===void 0)&&s.incoming()&&!a?()=>this._soundcache.get(f.SoundName.Incoming).play():()=>Promise.resolve();this._showIncomingCall(u,d)}),this._onSignalingOffline=()=>{this._log.info("Stream is offline"),this._edge=null,this._region=null,this._shouldReRegister=this.state!==f.State.Unregistered,this._setState(f.State.Unregistered)},this._onSignalingReady=()=>{this._log.info("Stream is ready"),this._setState(f.State.Registered)},this._publishNetworkChange=()=>{this._activeCall&&this._networkInformation&&this._publisher.info("network-information","network-change",{connection_type:this._networkInformation.type,downlink:this._networkInformation.downlink,downlinkMax:this._networkInformation.downlinkMax,effective_type:this._networkInformation.effectiveType,rtt:this._networkInformation.rtt},this._activeCall)},this._updateInputStream=r=>{const s=this._activeCall;return s&&!r?Promise.reject(new ne("Cannot unset input device while a call is in progress.")):(this._callInputStream=r,s?s._setInputTracksFromStream(r):Promise.resolve())},this._updateSinkIds=(r,s)=>(r==="ringtone"?this._updateRingtoneSinkIds(s):this._updateSpeakerSinkIds(s)).then(()=>{this._publisher.info("audio",`${r}-devices-set`,{audio_device_ids:s},this._activeCall)},l=>{throw this._publisher.error("audio",`${r}-devices-set-failed`,{audio_device_ids:s,message:l.message},this._activeCall),l}),this._setupLoglevel(i.logLevel),this._logOptions("constructor",i),this.updateToken(e),Ke())throw new G("Microsoft Edge Legacy (https://support.microsoft.com/en-us/help/4533505/what-is-microsoft-edge-legacy) is deprecated and will not be able to connect to Twilio to make or receive calls after September 1st, 2020. Please see this documentation for a list of supported browsers https://www.twilio.com/docs/voice/client/javascript#supported-browsers");if(!f.isSupported&&i.ignoreBrowserSupport)throw window&&window.location&&window.location.protocol==="http:"?new G("twilio.js wasn't able to find WebRTC browser support.           This is most likely because this page is served over http rather than https,           which does not support WebRTC in many browsers. Please load this page over https and           try again."):new G("twilio.js 1.3+ SDKs require WebRTC browser support.         For more information, see <https://www.twilio.com/docs/api/client/twilio-js>.         If you have any questions about this announcement, please contact         Twilio Support at <help@twilio.com>.");const n=globalThis,o=n.msBrowser||n.browser||n.chrome;if(this._isBrowserExtension=!!o&&!!o.runtime&&!!o.runtime.id||!!n.safari&&!!n.safari.extension,this._isBrowserExtension&&this._log.info("Running as browser extension."),navigator){const r=navigator;this._networkInformation=r.connection||r.mozConnection||r.webkitConnection}this._networkInformation&&typeof this._networkInformation.addEventListener=="function"&&this._networkInformation.addEventListener("change",this._publishNetworkChange),f._getOrCreateAudioContext(),f._audioContext&&(f._dialtonePlayer||(f._dialtonePlayer=new es(f._audioContext))),this._boundDestroy=this.destroy.bind(this),this._boundConfirmClose=this._confirmClose.bind(this),typeof window<"u"&&window.addEventListener&&(window.addEventListener("unload",this._boundDestroy),window.addEventListener("pagehide",this._boundDestroy)),this.updateOptions(i)}get audio(){return this._audio}connect(){return K(this,arguments,void 0,function*(e={}){if(this._log.debug(".connect",JSON.stringify(e)),this._throwIfDestroyed(),this._activeCall)throw new ne("A Call is already active");let i,n,o;if(e.connectToken){try{const c=JSON.parse(decodeURIComponent(atob(e.connectToken)));i=c.customParameters,n=c.parameters,o=c.signalingReconnectToken}catch{throw new L("Cannot parse connectToken")}if(!n||!n.CallSid||!o)throw new L("Invalid connectToken")}let r=!1,s={};const a={enableImprovedSignalingErrorPrecision:!!this._options.enableImprovedSignalingErrorPrecision,rtcConfiguration:e.rtcConfiguration,voiceEventSidGenerator:this._options.voiceEventSidGenerator};o&&n?(r=!0,a.callParameters=n,a.reconnectCallSid=n.CallSid,a.reconnectToken=o,s=i||s):s=e.params||s;let l;this._makeCallPromise=this._makeCall(s,a,r);try{l=this._activeCall=yield this._makeCallPromise}finally{this._makeCallPromise=null}return this._calls.splice(0).forEach(c=>c.ignore()),this._soundcache.get(f.SoundName.Incoming).stop(),l.accept({rtcConstraints:e.rtcConstraints}),this._publishNetworkChange(),l})}get calls(){return this._calls}destroy(){var e;this._log.debug(".destroy"),this._log.debug("Rejecting any incoming calls"),this._calls.slice(0).forEach(n=>n.reject()),this.disconnectAll(),this._stopRegistrationTimer(),this._destroyStream(),this._destroyAudioHelper(),(e=this._audioProcessorEventObserver)===null||e===void 0||e.destroy(),this._destroyPublisher(),this._networkInformation&&typeof this._networkInformation.removeEventListener=="function"&&this._networkInformation.removeEventListener("change",this._publishNetworkChange),typeof window<"u"&&window.removeEventListener&&(window.removeEventListener("beforeunload",this._boundConfirmClose),window.removeEventListener("unload",this._boundDestroy),window.removeEventListener("pagehide",this._boundDestroy)),this._setState(f.State.Destroyed),ie.EventEmitter.prototype.removeAllListeners.call(this)}disconnectAll(){this._log.debug(".disconnectAll"),this._calls.splice(0).forEach(i=>i.disconnect()),this._activeCall&&this._activeCall.disconnect()}get edge(){return this._edge}get home(){return this._home}get identity(){return this._identity}get isBusy(){return!!this._activeCall}register(){return K(this,void 0,void 0,function*(){if(this._log.debug(".register"),this.state!==f.State.Unregistered)throw new ne(`Attempt to register when device is in state "${this.state}". Must be "${f.State.Unregistered}".`);this._shouldReRegister=!1,this._setState(f.State.Registering),yield this._streamConnectedPromise||this._setupStream(),yield this._sendPresence(!0),yield ot(this,f.State.Registered,f.State.Unregistered)})}get state(){return this._state}get token(){return this._token}toString(){return"[Twilio.Device instance]"}unregister(){return K(this,void 0,void 0,function*(){if(this._log.debug(".unregister"),this.state!==f.State.Registered)throw new ne(`Attempt to unregister when device is in state "${this.state}". Must be "${f.State.Registered}".`);this._shouldReRegister=!1;const e=yield this._streamConnectedPromise,i=new Promise(n=>{e.on("offline",n)});yield this._sendPresence(!1),yield i})}updateOptions(e={}){if(this._logOptions("updateOptions",e),this.state===f.State.Destroyed)throw new ne(`Attempt to "updateOptions" when device is in state "${this.state}".`);this._options=Object.assign(Object.assign(Object.assign({},this._defaultOptions),this._options),e);const i=new Set(this._chunderURIs),n=this._chunderURIs=(this._getChunderws()||Ht(this._options.edge)).map(Vt);let o=i.size!==n.length;if(!o){for(const r of n)if(!i.has(r)){o=!0;break}}if(this.isBusy&&o)throw new ne("Cannot change Edge while on an active Call");this._setupLoglevel(this._options.logLevel);for(const r of Object.keys(f._defaultSounds)){const s=f._defaultSounds[r],a=`${ft}/${s.filename}.${f.extension}?cache=${Ee}`,l=this._options.sounds&&this._options.sounds[r]||a,c=new(this._options.Sound||le)(r,l,{audioContext:this._options.disableAudioContextSounds?null:f.audioContext,maxDuration:s.maxDuration,shouldLoop:s.shouldLoop});this._soundcache.set(r,c)}this._setupAudioHelper(),this._setupPublisher(),o&&this._streamConnectedPromise&&this._setupStream(),typeof window<"u"&&typeof window.addEventListener=="function"&&this._options.closeProtection&&(window.removeEventListener("beforeunload",this._boundConfirmClose),window.addEventListener("beforeunload",this._boundConfirmClose))}updateToken(e){if(this._log.debug(".updateToken"),this.state===f.State.Destroyed)throw new ne(`Attempt to "updateToken" when device is in state "${this.state}".`);if(typeof e!="string")throw new L(oo);this._token=e,this._stream&&this._stream.setToken(this._token),this._publisher&&this._publisher.setToken(this._token)}_confirmClose(e){if(!this._activeCall)return"";const i=this._options.closeProtection||!1,n=typeof i!="string"?"A call is currently in-progress. Leaving or reloading this page will end the call.":i;return(e||window.event).returnValue=n,n}_destroyAudioHelper(){this._audio&&(this._audio._destroy(),this._audio=null)}_destroyPublisher(){this._publisher&&(this._publisher=null)}_destroyStream(){this._stream&&(this._stream.removeListener("close",this._onSignalingClose),this._stream.removeListener("connected",this._onSignalingConnected),this._stream.removeListener("error",this._onSignalingError),this._stream.removeListener("invite",this._onSignalingInvite),this._stream.removeListener("offline",this._onSignalingOffline),this._stream.removeListener("ready",this._onSignalingReady),this._stream.destroy(),this._stream=null),this._onSignalingOffline(),this._streamConnectedPromise=null}_findCall(e){return this._calls.find(i=>i.parameters.CallSid===e||i.outboundConnectionId===e)||null}_getChunderws(){return typeof this._options.chunderw=="string"?[this._options.chunderw]:Array.isArray(this._options.chunderw)?this._options.chunderw:null}_logOptions(e,i={}){const n=["allowIncomingWhileBusy","appName","appVersion","closeProtection","codecPreferences","disableAudioContextSounds","dscp","edge","enableImprovedSignalingErrorPrecision","forceAggressiveIceNomination","logLevel","maxAverageBitrate","maxCallSignalingTimeoutMs","sounds","tokenRefreshMs"],o=["RTCPeerConnection","enumerateDevices","getUserMedia","MediaStream"];if(typeof i=="object"){const r=Object.assign({},i);Object.keys(r).forEach(s=>{!n.includes(s)&&!o.includes(s)&&delete r[s],o.includes(s)&&(r[s]=!0)}),this._log.debug(`.${e}`,JSON.stringify(r))}}_makeCall(e,i){return K(this,arguments,void 0,function*(n,o,r=!1){var s;const a=(s=this._audio)===null||s===void 0?void 0:s._getInputDevicePromise();a&&(this._log.debug("inputDevicePromise detected, waiting..."),yield a,this._log.debug("inputDevicePromise resolved"));const l={audioHelper:this._audio,onIgnore:()=>{this._soundcache.get(f.SoundName.Incoming).stop()},pstream:yield this._streamConnectedPromise||this._setupStream(),publisher:this._publisher,soundcache:this._soundcache};o=Object.assign({MediaStream:this._options.MediaStream,RTCPeerConnection:this._options.RTCPeerConnection,beforeAccept:d=>{!this._activeCall||this._activeCall===d||(this._activeCall.disconnect(),this._removeCall(this._activeCall))},codecPreferences:this._options.codecPreferences,customSounds:this._options.sounds,dialtonePlayer:f._dialtonePlayer,dscp:this._options.dscp,forceAggressiveIceNomination:this._options.forceAggressiveIceNomination,getInputStream:()=>this._options.fileInputStream||this._callInputStream,getSinkIds:()=>this._callSinkIds,maxAverageBitrate:this._options.maxAverageBitrate,preflight:this._options.preflight,rtcConstraints:this._options.rtcConstraints,shouldPlayDisconnect:()=>{var d;return(d=this._audio)===null||d===void 0?void 0:d.disconnect()},twimlParams:n,voiceEventSidGenerator:this._options.voiceEventSidGenerator},o);const c=()=>{if(!this._stream){this._log.warn("UnsetPreferredUri called without a stream");return}this._activeCall===null&&this._calls.length===0&&this._stream.updatePreferredURI(null)},u=new(this._options.Call||p)(l,o);return this._publisher.info("settings","init",{MediaStream:!!this._options.MediaStream,RTCPeerConnection:!!this._options.RTCPeerConnection,enumerateDevices:!!this._options.enumerateDevices,getUserMedia:!!this._options.getUserMedia},u),u.once("accept",()=>{var d,h,m;this._stream.updatePreferredURI(this._preferredURI),this._removeCall(u),this._activeCall=u,this._audio&&this._audio._maybeStartPollingVolume(),u.direction===p.CallDirection.Outgoing&&(!((d=this._audio)===null||d===void 0)&&d.outgoing())&&!r&&this._soundcache.get(f.SoundName.Outgoing).play();const b={edge:this._edge||this._region};this._options.edge&&(b.selected_edge=Array.isArray(this._options.edge)?this._options.edge:[this._options.edge]),this._publisher.info("settings","edge",b,u),!((h=this._audio)===null||h===void 0)&&h.processedStream&&((m=this._audioProcessorEventObserver)===null||m===void 0||m.emit("enabled"))}),u.addListener("error",d=>{u.status()==="closed"&&(this._removeCall(u),c()),this._audio&&this._audio._maybeStopPollingVolume(),this._maybeStopIncomingSound()}),u.once("cancel",()=>{this._log.info(`Canceled: ${u.parameters.CallSid}`),this._removeCall(u),c(),this._audio&&this._audio._maybeStopPollingVolume(),this._maybeStopIncomingSound()}),u.once("disconnect",()=>{this._audio&&this._audio._maybeStopPollingVolume(),this._removeCall(u),c(),this._maybeStopIncomingSound()}),u.once("reject",()=>{this._log.info(`Rejected: ${u.parameters.CallSid}`),this._audio&&this._audio._maybeStopPollingVolume(),this._removeCall(u),c(),this._maybeStopIncomingSound()}),u.on("transportClose",()=>{u.status()===p.State.Pending&&(this._audio&&this._audio._maybeStopPollingVolume(),this._removeCall(u),this._maybeStopIncomingSound())}),u})}_maybeStopIncomingSound(){this._calls.length||this._soundcache.get(f.SoundName.Incoming).stop()}_removeCall(e){this._activeCall===e&&(this._activeCall=null,this._makeCallPromise=null);for(let i=this._calls.length-1;i>=0;i--)e===this._calls[i]&&this._calls.splice(i,1)}_sendPresence(e){return K(this,void 0,void 0,function*(){const i=yield this._streamConnectedPromise;i&&(i.register({audio:e}),e?this._startRegistrationTimer():this._stopRegistrationTimer())})}_setState(e){if(e===this.state)return;this._state=e;const i=this._stateEventMapping[e];this._log.debug(`#${i}`),this.emit(i)}_setupAudioHelper(){this._audioProcessorEventObserver||(this._audioProcessorEventObserver=new Qn,this._audioProcessorEventObserver.on("event",({name:i,group:n})=>{this._publisher.info(n,i,{},this._activeCall)}));const e={audioContext:f.audioContext,audioProcessorEventObserver:this._audioProcessorEventObserver,beforeSetInputDevice:()=>this._makeCallPromise?(this._log.debug("beforeSetInputDevice pause detected"),this._makeCallPromise):(this._log.debug("beforeSetInputDevice pause not detected, setting default"),Promise.resolve()),enumerateDevices:this._options.enumerateDevices,getUserMedia:this._options.getUserMedia||Ks};if(this._audio){this._log.info("Found existing audio helper; updating options..."),this._audio._updateUserOptions(e);return}this._audio=new(this._options.AudioHelper||Xn)(this._updateSinkIds,this._updateInputStream,e),this._audio.on("deviceChange",i=>{const n=this._activeCall,o=i.map(r=>r.deviceId);this._publisher.info("audio","device-change",{lost_active_device_ids:o},n),n&&n._mediaHandler._onInputDevicesChanged()})}_setupLoglevel(e){const i=typeof e=="number"||typeof e=="string"?e:$e.levels.ERROR;this._log.setDefaultLevel(i),this._log.info("Set logger default level to",i)}_setupPublisher(){this._publisher&&(this._log.info("Found existing publisher; destroying..."),this._destroyPublisher());const e={defaultPayload:this._createDefaultPayload,metadata:{app_name:this._options.appName,app_version:this._options.appVersion}};return this._options.eventgw&&(e.host=this._options.eventgw),this._home&&(e.host=Nt(this._home)),this._publisher=new(this._options.Publisher||Z)(so,this.token,e),this._options.publishEvents===!1?this._publisher.disable():this._publisher.on("error",i=>{this._log.warn("Cannot connect to insights.",i)}),this._publisher}_setupStream(){return this._stream&&(this._log.info("Found existing stream; destroying..."),this._destroyStream()),this._log.info("Setting up VSP"),this._stream=new(this._options.PStream||$)(this.token,this._chunderURIs,{backoffMaxMs:this._options.backoffMaxMs,maxPreferredDurationMs:this._options.maxCallSignalingTimeoutMs}),this._stream.addListener("close",this._onSignalingClose),this._stream.addListener("connected",this._onSignalingConnected),this._stream.addListener("error",this._onSignalingError),this._stream.addListener("invite",this._onSignalingInvite),this._stream.addListener("offline",this._onSignalingOffline),this._stream.addListener("ready",this._onSignalingReady),this._streamConnectedPromise=ot(this._stream,"connected","close").then(()=>this._stream)}_showIncomingCall(e,i){let n;return Promise.race([i(),new Promise((o,r)=>{n=setTimeout(()=>{const s="Playing incoming ringtone took too long; it might not play. Continuing execution...";r(new Error(s))},no)})]).catch(o=>{this._log.warn(o.message)}).then(()=>{clearTimeout(n),this._log.debug("#incoming",JSON.stringify({customParameters:e.customParameters,parameters:e.parameters})),this.emit(f.EventName.Incoming,e)})}_startRegistrationTimer(){this._stopRegistrationTimer(),this._regTimer=setTimeout(()=>{this._sendPresence(!0)},io)}_stopRegistrationTimer(){this._regTimer&&clearTimeout(this._regTimer)}_throwIfDestroyed(){if(this.state===f.State.Destroyed)throw new ne("Device has been destroyed.")}_updateRingtoneSinkIds(e){return Promise.resolve(this._soundcache.get(f.SoundName.Incoming).setSinkIds(e))}_updateSpeakerSinkIds(e){Array.from(this._soundcache.entries()).filter(n=>n[0]!==f.SoundName.Incoming).forEach(n=>n[1].setSinkIds(e)),this._callSinkIds=e;const i=this._activeCall;return i?i._setSinkIds(e):Promise.resolve()}}f._defaultSounds={disconnect:{filename:"disconnect",maxDuration:3e3},dtmf0:{filename:"dtmf-0",maxDuration:1e3},dtmf1:{filename:"dtmf-1",maxDuration:1e3},dtmf2:{filename:"dtmf-2",maxDuration:1e3},dtmf3:{filename:"dtmf-3",maxDuration:1e3},dtmf4:{filename:"dtmf-4",maxDuration:1e3},dtmf5:{filename:"dtmf-5",maxDuration:1e3},dtmf6:{filename:"dtmf-6",maxDuration:1e3},dtmf7:{filename:"dtmf-7",maxDuration:1e3},dtmf8:{filename:"dtmf-8",maxDuration:1e3},dtmf9:{filename:"dtmf-9",maxDuration:1e3},dtmfh:{filename:"dtmf-hash",maxDuration:1e3},dtmfs:{filename:"dtmf-star",maxDuration:1e3},incoming:{filename:"incoming",shouldLoop:!0},outgoing:{filename:"outgoing",maxDuration:3e3}};(function(t){(function(e){e.Error="error",e.Incoming="incoming",e.Destroyed="destroyed",e.Unregistered="unregistered",e.Registering="registering",e.Registered="registered",e.TokenWillExpire="tokenWillExpire"})(t.EventName||(t.EventName={})),function(e){e.Destroyed="destroyed",e.Unregistered="unregistered",e.Registering="registering",e.Registered="registered"}(t.State||(t.State={})),function(e){e.Incoming="incoming",e.Outgoing="outgoing",e.Disconnect="disconnect",e.Dtmf0="dtmf0",e.Dtmf1="dtmf1",e.Dtmf2="dtmf2",e.Dtmf3="dtmf3",e.Dtmf4="dtmf4",e.Dtmf5="dtmf5",e.Dtmf6="dtmf6",e.Dtmf7="dtmf7",e.Dtmf8="dtmf8",e.Dtmf9="dtmf9",e.DtmfS="dtmfs",e.DtmfH="dtmfh"}(t.SoundName||(t.SoundName={}))})(f||(f={}));class Ye{constructor(e,i=!1){this.deleted=!1;let n;const o=e.candidate.split("network-cost ");o[1]&&(n=parseInt(o[1],10)),this.candidateType=e.type,this.ip=e.ip||e.address,this.isRemote=i,this.networkCost=n,this.port=e.port,this.priority=e.priority,this.protocol=e.protocol,this.relatedAddress=e.relatedAddress,this.relatedPort=e.relatedPort,this.tcpType=e.tcpType,this.transportId=e.sdpMid}toPayload(){return{candidate_type:this.candidateType,deleted:this.deleted,ip:this.ip,is_remote:this.isRemote,"network-cost":this.networkCost,port:this.port,priority:this.priority,protocol:this.protocol,related_address:this.relatedAddress,related_port:this.relatedPort,tcp_type:this.tcpType,transport_id:this.transportId}}}const zt=94.768;function ro(t,e,i){if(typeof t!="number"||typeof e!="number"||typeof i!="number"||!Fe(t)||!Fe(e)||!Fe(i))return null;const n=t+e*2+10;let o=0;switch(!0){case n<160:o=zt-n/40;break;case n<1e3:o=zt-(n-120)/10;break}switch(!0){case i<=o/2.5:o=Math.max(o-i*2.5,6.52);break;default:o=0;break}return 1+.035*o+7e-6*o*(o-60)*(100-o)}function Fe(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)&&t>=0}var ao={calculate:ro,isNonNegativeNumber:Fe};const co=5,lo=0,uo=3,ho=1e3,po=5*1e3,fo={audioInputLevel:{minStandardDeviation:327.67,sampleCount:10},audioOutputLevel:{minStandardDeviation:327.67,sampleCount:10},bytesReceived:{clearCount:2,min:1,raiseCount:3,sampleCount:3},bytesSent:{clearCount:2,min:1,raiseCount:3,sampleCount:3},jitter:{max:30},mos:{min:3},packetsLostFraction:[{max:1},{clearValue:1,maxAverage:3,sampleCount:7}],rtt:{max:400}};function mo(t,e){return e.reduce((i,n)=>i+=n>t?1:0,0)}function go(t,e){return e.reduce((i,n)=>i+=n<t?1:0,0)}function _o(t){if(t.length<=0)return null;const e=t.reduce((o,r)=>o+r,0)/t.length,i=t.map(o=>Math.pow(o-e,2));return Math.sqrt(i.reduce((o,r)=>o+r,0)/i.length)}function vo(t){return t.reduce((e,i)=>[...e,...i],[])}class yo extends ie.EventEmitter{constructor(e){super(),this._activeWarnings=new Map,this._currentStreaks=new Map,this._inputVolumes=[],this._outputVolumes=[],this._sampleBuffer=[],this._supplementalSampleBuffers={audioInputLevel:[],audioOutputLevel:[]},this._warningsEnabled=!0,e=e||{},this._getRTCStats=e.getRTCStats||ps,this._mos=e.Mos||ao,this._peerConnection=e.peerConnection,this._thresholds=Object.assign(Object.assign({},fo),e.thresholds);const i=Object.values(this._thresholds).map(n=>n.sampleCount).filter(n=>!!n);this._maxSampleCount=Math.max(co,...i),this._peerConnection&&this.enable(this._peerConnection)}addVolumes(e,i){this._inputVolumes.push(e),this._outputVolumes.push(i)}disable(){return this._sampleInterval&&(clearInterval(this._sampleInterval),delete this._sampleInterval),this}disableWarnings(){return this._warningsEnabled&&this._activeWarnings.clear(),this._warningsEnabled=!1,this}enable(e){if(e){if(this._peerConnection&&e!==this._peerConnection)throw new L("Attempted to replace an existing PeerConnection in StatsMonitor.enable");this._peerConnection=e}if(!this._peerConnection)throw new L("Can not enable StatsMonitor without a PeerConnection");return this._sampleInterval=this._sampleInterval||setInterval(this._fetchSample.bind(this),ho),this}enableWarnings(){return this._warningsEnabled=!0,this}hasActiveWarning(e,i){const n=`${e}:${i}`;return!!this._activeWarnings.get(n)}_addSample(e){const i=this._sampleBuffer;i.push(e),i.length>this._maxSampleCount&&i.splice(0,i.length-this._maxSampleCount)}_clearWarning(e,i,n){const o=`${e}:${i}`,r=this._activeWarnings.get(o);!r||Date.now()-r.timeRaised<po||(this._activeWarnings.delete(o),this.emit("warning-cleared",Object.assign(Object.assign({},n),{name:e,threshold:{name:i,value:this._thresholds[e][i]}})))}_createSample(e,i){const n=i&&i.totals.bytesSent||0,o=i&&i.totals.bytesReceived||0,r=i&&i.totals.packetsSent||0,s=i&&i.totals.packetsReceived||0,a=i&&i.totals.packetsLost||0,l=e.bytesSent-n,c=e.bytesReceived-o,u=e.packetsSent-r,d=e.packetsReceived-s,h=e.packetsLost-a,m=d+h,b=m>0?h/m*100:0,g=e.packetsReceived+e.packetsLost,_=g>0?e.packetsLost/g*100:100,y=typeof e.rtt=="number"||!i?e.rtt:i.rtt,M=this._inputVolumes.splice(0);this._supplementalSampleBuffers.audioInputLevel.push(M);const V=this._outputVolumes.splice(0);return this._supplementalSampleBuffers.audioOutputLevel.push(V),{audioInputLevel:Math.round(Oe(M)),audioOutputLevel:Math.round(Oe(V)),bytesReceived:c,bytesSent:l,codecName:e.codecName,jitter:e.jitter,mos:this._mos.calculate(y,e.jitter,i&&b),packetsLost:h,packetsLostFraction:b,packetsReceived:d,packetsSent:u,rtt:y,timestamp:e.timestamp,totals:{bytesReceived:e.bytesReceived,bytesSent:e.bytesSent,packetsLost:e.packetsLost,packetsLostFraction:_,packetsReceived:e.packetsReceived,packetsSent:e.packetsSent}}}_fetchSample(){this._getSample().then(e=>{this._addSample(e),this._raiseWarnings(),this.emit("sample",e)}).catch(e=>{this.disable(),this.emit("error",e)})}_getSample(){return this._getRTCStats(this._peerConnection).then(e=>{let i=null;return this._sampleBuffer.length&&(i=this._sampleBuffer[this._sampleBuffer.length-1]),this._createSample(e,i)})}_raiseWarning(e,i,n){const o=`${e}:${i}`;if(this._activeWarnings.has(o))return;this._activeWarnings.set(o,{timeRaised:Date.now()});const r=this._thresholds[e];let s;if(Array.isArray(r)){const a=r.find(l=>i in l);a&&(s=a[i])}else s=this._thresholds[e][i];this.emit("warning",Object.assign(Object.assign({},n),{name:e,threshold:{name:i,value:s}}))}_raiseWarnings(){this._warningsEnabled&&Object.keys(this._thresholds).forEach(e=>this._raiseWarningsForStat(e))}_raiseWarningsForStat(e){(Array.isArray(this._thresholds[e])?this._thresholds[e]:[this._thresholds[e]]).forEach(n=>{const o=this._sampleBuffer,r=n.clearCount||lo,s=n.raiseCount||uo,a=n.sampleCount||this._maxSampleCount;let l=o.slice(-a);const c=l.map(h=>h[e]);if(c.some(h=>typeof h>"u"||h===null))return;let d;if(typeof n.max=="number"&&(d=mo(n.max,c),d>=s?this._raiseWarning(e,"max",{values:c,samples:l}):d<=r&&this._clearWarning(e,"max",{values:c,samples:l})),typeof n.min=="number"&&(d=go(n.min,c),d>=s?this._raiseWarning(e,"min",{values:c,samples:l}):d<=r&&this._clearWarning(e,"min",{values:c,samples:l})),typeof n.maxDuration=="number"&&o.length>1){l=o.slice(-2);const h=l[0][e],m=l[1][e],b=this._currentStreaks.get(e)||0,g=h===m?b+1:0;this._currentStreaks.set(e,g),g>=n.maxDuration?this._raiseWarning(e,"maxDuration",{value:g}):g===0&&this._clearWarning(e,"maxDuration",{value:b})}if(typeof n.minStandardDeviation=="number"){const h=this._supplementalSampleBuffers[e];if(!h||h.length<n.sampleCount)return;h.length>n.sampleCount&&h.splice(0,h.length-n.sampleCount);const m=vo(h.slice(-a)),b=_o(m);if(typeof b!="number")return;b<n.minStandardDeviation?this._raiseWarning(e,"minStandardDeviation",{value:b}):this._clearWarning(e,"minStandardDeviation",{value:b})}[["maxAverage",(h,m)=>h>m],["minAverage",(h,m)=>h<m]].forEach(([h,m])=>{if(typeof n[h]=="number"&&c.length>=a){const b=Oe(c);m(b,n[h])?this._raiseWarning(e,h,{values:c,samples:l}):m(b,n.clearValue||n[h])||this._clearWarning(e,h,{values:c,samples:l})}})})}}const Jt={factor:1.1,jitter:.5,max:3e4,min:1},bo=70,So=500,wo=160,Co=10,To=5e3,Kt={disconnect:!0,info:{code:31003,message:"Connection with Twilio was interrupted.",twilioError:new re.ConnectionError}},Zt={packetsLostFraction:{max:"packet-loss",maxAverage:"packets-lost-fraction"}},Xt={audioInputLevel:"audio-input-level",audioOutputLevel:"audio-output-level",bytesReceived:"bytes-received",bytesSent:"bytes-sent",jitter:"jitter",mos:"mos",rtt:"rtt"},xo={max:"high-",maxAverage:"high-",maxDuration:"constant-",min:"low-",minStandardDeviation:"constant-"};class p extends ie.EventEmitter{get direction(){return this._direction}get codec(){return this._codec}get connectToken(){const e=this._signalingReconnectToken,i=this.parameters&&this.parameters.CallSid?this.parameters.CallSid:void 0;if(!e||!i)return;const n=this.customParameters&&typeof this.customParameters.keys=="function"?Array.from(this.customParameters.keys()).reduce((r,s)=>(r[s]=this.customParameters.get(s),r),{}):{},o=this.parameters||{};return btoa(encodeURIComponent(JSON.stringify({customParameters:n,parameters:o,signalingReconnectToken:e})))}constructor(e,i){super(),this.parameters={},this._inputVolumeStreak=0,this._isAnswered=!1,this._isCancelled=!1,this._isRejected=!1,this._latestInputVolume=0,this._latestOutputVolume=0,this._log=new B("Call"),this._mediaStatus=p.State.Pending,this._messages=new Map,this._metricsSamples=[],this._options={MediaHandler:C,MediaStream:null,enableImprovedSignalingErrorPrecision:!1,offerSdp:null,shouldPlayDisconnect:()=>!0,voiceEventSidGenerator:lt},this._outputVolumeStreak=0,this._shouldSendHangup=!0,this._signalingStatus=p.State.Pending,this._soundcache=new Map,this._status=p.State.Pending,this._wasConnected=!1,this.toString=()=>"[Twilio.Call instance]",this._emitWarning=(s,a,l,c,u,d)=>{const m=`${s}warning${u?"-cleared":"-raised"}`;if(a==="constant-audio-input-level"&&this.isMuted())return;let b=u?"info":"warning";a==="constant-audio-output-level"&&(b="info");const g={threshold:l};if(c&&(c instanceof Array?g.values=c.map(_=>typeof _=="number"?Math.round(_*100)/100:c):g.value=c),this._publisher.post(b,m,a,{data:g},this),a!=="constant-audio-output-level"){const _=u?"warning-cleared":"warning";this._log.debug(`#${_}`,a),this.emit(_,a,d&&!u?d:null)}},this._onAck=s=>{const{acktype:a,callsid:l,voiceeventsid:c}=s;if(this.parameters.CallSid!==l){this._log.warn(`Received ack from a different callsid: ${l}`);return}a==="message"&&this._onMessageSent(c)},this._onAnswer=s=>{typeof s.reconnect=="string"&&(this._signalingReconnectToken=s.reconnect),!(this._isAnswered&&this._status!==p.State.Reconnecting)&&(this._setCallSid(s),this._isAnswered=!0,this._maybeTransitionToOpen())},this._onCancel=s=>{const a=s.callsid;this.parameters.CallSid===a&&(this._isCancelled=!0,this._publisher.info("connection","cancel",null,this),this._cleanupEventListeners(),this._mediaHandler.close(),this._status=p.State.Closed,this._log.debug("#cancel"),this.emit("cancel"),this._pstream.removeListener("cancel",this._onCancel))},this._onConnected=()=>{this._log.info("Received connected from pstream"),this._signalingReconnectToken&&this._mediaHandler.version&&this._pstream.reconnect(this._mediaHandler.version.getSDP(),this.parameters.CallSid,this._signalingReconnectToken)},this._onHangup=s=>{if(this.status()!==p.State.Closed){if(s.callsid&&(this.parameters.CallSid||this.outboundConnectionId)){if(s.callsid!==this.parameters.CallSid&&s.callsid!==this.outboundConnectionId)return}else if(s.callsid)return;if(this._log.info("Received HANGUP from gateway"),s.error){const a=s.error.code,l=nt(this._options.enableImprovedSignalingErrorPrecision,a),c=typeof l<"u"?new l(s.error.message):new z.ConnectionError("Error sent from gateway in HANGUP",s.error);this._log.error("Received an error from the gateway:",c),this._log.debug("#error",c),this.emit("error",c)}this._shouldSendHangup=!1,this._publisher.info("connection","disconnected-by-remote",null,this),this._disconnect(null,!0),this._cleanupEventListeners()}},this._onMediaFailure=s=>{const{ConnectionDisconnected:a,ConnectionFailed:l,IceGatheringFailed:c,LowBytes:u}=p.MediaFailure,d=s===l||s===c;if(!gt(window,window.navigator)&&s===l)return this._mediaHandler.onerror(Kt);if(this._mediaStatus===p.State.Reconnecting){if(d){if(Date.now()-this._mediaReconnectStartTime>Jt.max)return this._log.warn("Exceeded max ICE retries"),this._mediaHandler.onerror(Kt);try{this._mediaReconnectBackoff.backoff()}catch(g){if(!(g.message&&g.message==="Backoff in progress."))throw g}}return}const h=this._mediaHandler.version.pc,m=h&&h.iceConnectionState==="disconnected",b=this._monitor.hasActiveWarning("bytesSent","min")||this._monitor.hasActiveWarning("bytesReceived","min");if(s===u&&m||s===a&&b||d){const g=new re.ConnectionError("Media connection failed.");this._log.warn("ICE Connection disconnected."),this._publisher.warn("connection","error",g,this),this._publisher.info("connection","reconnecting",null,this),this._mediaReconnectStartTime=Date.now(),this._status=p.State.Reconnecting,this._mediaStatus=p.State.Reconnecting,this._mediaReconnectBackoff.reset(),this._mediaReconnectBackoff.backoff(),this._log.debug("#reconnecting"),this.emit("reconnecting",g)}},this._onMediaReconnected=()=>{this._mediaStatus===p.State.Reconnecting&&(this._log.info("ICE Connection reestablished."),this._mediaStatus=p.State.Open,this._signalingStatus===p.State.Open&&(this._publisher.info("connection","reconnected",null,this),this._log.debug("#reconnected"),this.emit("reconnected"),this._status=p.State.Open))},this._onMessageReceived=s=>{const{callsid:a,content:l,contenttype:c,messagetype:u,voiceeventsid:d}=s;if(this.parameters.CallSid!==a){this._log.warn(`Received a message from a different callsid: ${a}`);return}const h={content:l,contentType:c,messageType:u,voiceEventSid:d};this._publisher.info("call-message",u,{content_type:c,event_type:"received",voice_event_sid:d},this),this._log.debug("#messageReceived",JSON.stringify(h)),this.emit("messageReceived",h)},this._onMessageSent=s=>{if(!this._messages.has(s)){this._log.warn(`Received a messageSent with a voiceEventSid that doesn't exists: ${s}`);return}const a=this._messages.get(s);this._messages.delete(s),this._publisher.info("call-message",a==null?void 0:a.messageType,{content_type:a==null?void 0:a.contentType,event_type:"sent",voice_event_sid:s},this),this._log.debug("#messageSent",JSON.stringify(a)),this.emit("messageSent",a)},this._onRinging=s=>{if(this._setCallSid(s),this._status!==p.State.Connecting&&this._status!==p.State.Ringing)return;const a=!!s.sdp;this._status=p.State.Ringing,this._publisher.info("connection","outgoing-ringing",{hasEarlyMedia:a},this),this._log.debug("#ringing"),this.emit("ringing",a)},this._onRTCSample=s=>{const a=Object.assign(Object.assign({},s),{inputVolume:this._latestInputVolume,outputVolume:this._latestOutputVolume});this._codec=a.codecName,this._metricsSamples.push(a),this._metricsSamples.length>=Co&&this._publishMetrics(),this.emit("sample",s)},this._onSignalingError=s=>{const{callsid:a,voiceeventsid:l,error:c}=s;if(this.parameters.CallSid!==a){this._log.warn(`Received an error from a different callsid: ${a}`);return}if(l&&this._messages.has(l)){this._messages.delete(l),this._log.warn("Received an error while sending a message.",s),this._publisher.error("call-message","error",{code:c.code,message:c.message,voice_event_sid:l},this);let u;const d=nt(!!this._options.enableImprovedSignalingErrorPrecision,c.code);typeof d<"u"&&(u=new d(c)),u||(this._log.error("Unknown Call Message Error: ",c),u=new z.UnknownError(c.message,c)),this._log.debug("#error",c,u),this.emit("error",u)}},this._onSignalingReconnected=()=>{this._signalingStatus===p.State.Reconnecting&&(this._log.info("Signaling Connection reestablished."),this._signalingStatus=p.State.Open,this._mediaStatus===p.State.Open&&(this._publisher.info("connection","reconnected",null,this),this._log.debug("#reconnected"),this.emit("reconnected"),this._status=p.State.Open))},this._onTransportClose=()=>{this._log.error("Received transportClose from pstream"),this._log.debug("#transportClose"),this.emit("transportClose"),this._signalingReconnectToken?(this._status=p.State.Reconnecting,this._signalingStatus=p.State.Reconnecting,this._publisher.info("connection","reconnecting",null,this),this._log.debug("#reconnecting"),this.emit("reconnecting",new te.ConnectionDisconnected)):(this._status=p.State.Closed,this._signalingStatus=p.State.Closed)},this._reemitWarning=(s,a)=>{const l=/^audio/.test(s.name)?"audio-level-":"network-quality-",c=xo[s.threshold.name];let u;s.name in Zt?u=Zt[s.name][s.threshold.name]:s.name in Xt&&(u=Xt[s.name]);const d=c+u;this._emitWarning(l,d,s.threshold.value,s.values||s.value,a,s)},this._reemitWarningCleared=s=>{this._reemitWarning(s,!0)},this._soundcache=e.soundcache,typeof e.onIgnore=="function"&&(this._onIgnore=e.onIgnore);const n=i&&i.twimlParams||{};this.customParameters=new Map(Object.entries(n).map(([s,a])=>[s,String(a)])),Object.assign(this._options,i),this._options.callParameters&&(this.parameters=this._options.callParameters),this._options.reconnectToken&&(this._signalingReconnectToken=this._options.reconnectToken),this._voiceEventSidGenerator=this._options.voiceEventSidGenerator||lt,this._direction=this.parameters.CallSid&&!this._options.reconnectCallSid?p.CallDirection.Incoming:p.CallDirection.Outgoing,this.parameters?this.callerInfo=this.parameters.StirStatus?{isVerified:this.parameters.StirStatus==="TN-Validation-Passed-A"}:null:this.callerInfo=null,this._mediaReconnectBackoff=new et(Jt),this._mediaReconnectBackoff.on("ready",()=>this._mediaHandler.iceRestart()),this.outboundConnectionId=ko();const o=this._publisher=e.publisher;this._direction===p.CallDirection.Incoming?o.info("connection","incoming",null,this):o.info("connection","outgoing",{preflight:this._options.preflight,reconnect:!!this._options.reconnectCallSid},this);const r=this._monitor=new(this._options.StatsMonitor||yo);r.on("sample",this._onRTCSample),r.disableWarnings(),setTimeout(()=>r.enableWarnings(),To),r.on("warning",(s,a)=>{(s.name==="bytesSent"||s.name==="bytesReceived")&&this._onMediaFailure(p.MediaFailure.LowBytes),this._reemitWarning(s,a)}),r.on("warning-cleared",s=>{this._reemitWarningCleared(s)}),this._mediaHandler=new this._options.MediaHandler(e.audioHelper,e.pstream,{MediaStream:this._options.MediaStream,RTCPeerConnection:this._options.RTCPeerConnection,codecPreferences:this._options.codecPreferences,dscp:this._options.dscp,forceAggressiveIceNomination:this._options.forceAggressiveIceNomination,maxAverageBitrate:this._options.maxAverageBitrate}),this.on("volume",(s,a)=>{this._inputVolumeStreak=this._checkVolume(s,this._inputVolumeStreak,this._latestInputVolume,"input"),this._outputVolumeStreak=this._checkVolume(a,this._outputVolumeStreak,this._latestOutputVolume,"output"),this._latestInputVolume=s,this._latestOutputVolume=a}),this._mediaHandler.onaudio=s=>{this._log.debug("#audio"),this.emit("audio",s)},this._mediaHandler.onvolume=(s,a,l,c)=>{r.addVolumes(l/255*32767,c/255*32767),this.emit("volume",s,a)},this._mediaHandler.ondtlstransportstatechange=s=>{const a=s==="failed"?"error":"debug";this._publisher.post(a,"dtls-transport-state",s,null,this)},this._mediaHandler.onpcconnectionstatechange=s=>{let a="debug";const l=this._mediaHandler.getRTCDtlsTransport();s==="failed"&&(a=l&&l.state==="failed"?"error":"warning"),this._publisher.post(a,"pc-connection-state",s,null,this)},this._mediaHandler.onicecandidate=s=>{const a=new Ye(s).toPayload();this._publisher.debug("ice-candidate","ice-candidate",a,this)},this._mediaHandler.onselectedcandidatepairchange=s=>{const a=new Ye(s.local).toPayload(),l=new Ye(s.remote,!0).toPayload();this._publisher.debug("ice-candidate","selected-ice-candidate-pair",{local_candidate:a,remote_candidate:l},this)},this._mediaHandler.oniceconnectionstatechange=s=>{const a=s==="failed"?"error":"debug";this._publisher.post(a,"ice-connection-state",s,null,this)},this._mediaHandler.onicegatheringfailure=s=>{this._publisher.warn("ice-gathering-state",s,null,this),this._onMediaFailure(p.MediaFailure.IceGatheringFailed)},this._mediaHandler.onicegatheringstatechange=s=>{this._publisher.debug("ice-gathering-state",s,null,this)},this._mediaHandler.onsignalingstatechange=s=>{this._publisher.debug("signaling-state",s,null,this)},this._mediaHandler.ondisconnected=s=>{this._log.warn(s),this._publisher.warn("network-quality-warning-raised","ice-connectivity-lost",{message:s},this),this._log.debug("#warning","ice-connectivity-lost"),this.emit("warning","ice-connectivity-lost"),this._onMediaFailure(p.MediaFailure.ConnectionDisconnected)},this._mediaHandler.onfailed=s=>{this._onMediaFailure(p.MediaFailure.ConnectionFailed)},this._mediaHandler.onconnected=()=>{this._status===p.State.Reconnecting&&this._onMediaReconnected()},this._mediaHandler.onreconnected=s=>{this._log.info(s),this._publisher.info("network-quality-warning-cleared","ice-connectivity-lost",{message:s},this),this._log.debug("#warning-cleared","ice-connectivity-lost"),this.emit("warning-cleared","ice-connectivity-lost"),this._onMediaReconnected()},this._mediaHandler.onerror=s=>{s.disconnect===!0&&this._disconnect(s.info&&s.info.message);const a=s.info.twilioError||new z.UnknownError(s.info.message);this._log.error("Received an error from MediaStream:",s),this._log.debug("#error",a),this.emit("error",a)},this._mediaHandler.onopen=()=>{this._status===p.State.Open||this._status===p.State.Reconnecting||(this._status===p.State.Ringing||this._status===p.State.Connecting?(this.mute(this._mediaHandler.isMuted),this._mediaStatus=p.State.Open,this._maybeTransitionToOpen()):this._mediaHandler.close())},this._mediaHandler.onclose=()=>{this._status=p.State.Closed,this._options.shouldPlayDisconnect&&this._options.shouldPlayDisconnect()&&!this._isCancelled&&!this._isRejected&&this._soundcache.get(f.SoundName.Disconnect).play(),r.disable(),this._publishMetrics(),!this._isCancelled&&!this._isRejected&&(this._log.debug("#disconnect"),this.emit("disconnect",this))},this._pstream=e.pstream,this._pstream.on("ack",this._onAck),this._pstream.on("cancel",this._onCancel),this._pstream.on("error",this._onSignalingError),this._pstream.on("ringing",this._onRinging),this._pstream.on("transportClose",this._onTransportClose),this._pstream.on("connected",this._onConnected),this._pstream.on("message",this._onMessageReceived),this.on("error",s=>{this._publisher.error("connection","error",{code:s.code,message:s.message},this),this._pstream&&this._pstream.status==="disconnected"&&this._cleanupEventListeners()}),this.on("disconnect",()=>{this._cleanupEventListeners()})}_setInputTracksFromStream(e){return this._mediaHandler.setInputTracksFromStream(e)}_setSinkIds(e){return this._mediaHandler._setSinkIds(e)}accept(e){if(this._log.debug(".accept",e),this._status!==p.State.Pending){this._log.debug(`.accept noop. status is '${this._status}'`);return}e=e||{};const i=e.rtcConfiguration||this._options.rtcConfiguration,n=e.rtcConstraints||this._options.rtcConstraints||{},o={audio:typeof n.audio<"u"?n.audio:!0};this._status=p.State.Connecting;const r=()=>{if(this._status!==p.State.Connecting){this._cleanupEventListeners(),this._mediaHandler.close();return}const l=u=>{const d=this._direction===p.CallDirection.Incoming?"accepted-by-local":"accepted-by-remote";this._publisher.info("connection",d,null,this);const{codecName:h,codecParams:m}=Ms(this._mediaHandler.version.getSDP());this._publisher.info("settings","codec",{codec_params:m,selected_codec:h},this),this._monitor.enable(u)},c=typeof this._options.getSinkIds=="function"&&this._options.getSinkIds();if(Array.isArray(c)&&this._mediaHandler._setSinkIds(c).catch(()=>{}),this._pstream.addListener("hangup",this._onHangup),this._direction===p.CallDirection.Incoming)this._isAnswered=!0,this._pstream.on("answer",this._onAnswer),this._mediaHandler.answerIncomingCall(this.parameters.CallSid,this._options.offerSdp,i,l);else{const u=Array.from(this.customParameters.entries()).map(d=>`${encodeURIComponent(d[0])}=${encodeURIComponent(d[1])}`).join("&");this._pstream.on("answer",this._onAnswer),this._mediaHandler.makeOutgoingCall(u,this._signalingReconnectToken,this._options.reconnectCallSid||this.outboundConnectionId,i,l)}};this._options.beforeAccept&&this._options.beforeAccept(this);const s=typeof this._options.getInputStream=="function"&&this._options.getInputStream();(s?this._mediaHandler.setInputTracksFromStream(s):this._mediaHandler.openDefaultDeviceWithConstraints(o)).then(()=>{this._publisher.info("get-user-media","succeeded",{data:{audioConstraints:o}},this),r()},l=>{let c;l.code===31208||["PermissionDeniedError","NotAllowedError"].indexOf(l.name)!==-1?(c=new Pe.PermissionDeniedError,this._publisher.error("get-user-media","denied",{data:{audioConstraints:o,error:l}},this)):(c=new Pe.AcquisitionFailedError,this._publisher.error("get-user-media","failed",{data:{audioConstraints:o,error:l}},this)),this._disconnect(),this._log.debug("#error",l),this.emit("error",c)})}disconnect(){this._log.debug(".disconnect"),this._disconnect()}getLocalStream(){return this._mediaHandler&&this._mediaHandler.stream}getRemoteStream(){return this._mediaHandler&&this._mediaHandler._remoteStream}ignore(){if(this._log.debug(".ignore"),this._status!==p.State.Pending){this._log.debug(`.ignore noop. status is '${this._status}'`);return}this._status=p.State.Closed,this._mediaHandler.ignore(this.parameters.CallSid),this._publisher.info("connection","ignored-by-local",null,this),this._onIgnore&&this._onIgnore()}isMuted(){return this._mediaHandler.isMuted}mute(e=!0){this._log.debug(".mute",e);const i=this._mediaHandler.isMuted;this._mediaHandler.mute(e);const n=this._mediaHandler.isMuted;i!==n&&(this._publisher.info("connection",n?"muted":"unmuted",null,this),this._log.debug("#mute",n),this.emit("mute",n,this))}postFeedback(e,i){if(typeof e>"u"||e===null)return this._postFeedbackDeclined();if(!Object.values(p.FeedbackScore).includes(e))throw new L(`Feedback score must be one of: ${Object.values(p.FeedbackScore)}`);if(typeof i<"u"&&i!==null&&!Object.values(p.FeedbackIssue).includes(i))throw new L(`Feedback issue must be one of: ${Object.values(p.FeedbackIssue)}`);return this._publisher.info("feedback","received",{issue_name:i,quality_score:e},this,!0)}reject(){if(this._log.debug(".reject"),this._status!==p.State.Pending){this._log.debug(`.reject noop. status is '${this._status}'`);return}this._isRejected=!0,this._pstream.reject(this.parameters.CallSid),this._mediaHandler.reject(this.parameters.CallSid),this._publisher.info("connection","rejected-by-local",null,this),this._cleanupEventListeners(),this._mediaHandler.close(),this._status=p.State.Closed,this._log.debug("#reject"),this.emit("reject")}sendDigits(e){if(this._log.debug(".sendDigits",e),e.match(/[^0-9*#w]/))throw new L("Illegal character passed into sendDigits");const i=this._options.customSounds||{},n=[];e.split("").forEach(a=>{let l=a!=="w"?`dtmf${a}`:"";l==="dtmf*"&&(l="dtmfs"),l==="dtmf#"&&(l="dtmfh"),n.push(l)});const o=()=>{const a=n.shift();a&&(this._options.dialtonePlayer&&!i[a]?this._options.dialtonePlayer.play(a):this._soundcache.get(a).play()),n.length&&setTimeout(()=>o(),200)};o();const r=this._mediaHandler.getOrCreateDTMFSender();function s(a){if(!a.length)return;const l=a.shift();l&&l.length&&r.insertDTMF(l,wo,bo),setTimeout(s.bind(null,a),So)}if(r){if(!("canInsertDTMF"in r)||r.canInsertDTMF){this._log.info("Sending digits using RTCDTMFSender"),s(e.split("w"));return}this._log.info("RTCDTMFSender cannot insert DTMF")}if(this._log.info("Sending digits over PStream"),this._pstream!==null&&this._pstream.status!=="disconnected")this._pstream.dtmf(this.parameters.CallSid,e);else{const a=new z.ConnectionError("Could not send DTMF: Signaling channel is disconnected");this._log.debug("#error",a),this.emit("error",a)}}sendMessage(e){this._log.debug(".sendMessage",JSON.stringify(e));const{content:i,contentType:n,messageType:o}=e;if(typeof i>"u"||i===null)throw new L("`content` is empty");if(typeof o!="string")throw new L("`messageType` must be a string.");if(o.length===0)throw new L("`messageType` must be a non-empty string.");if(this._pstream===null)throw new ne("Could not send CallMessage; Signaling channel is disconnected");const r=this.parameters.CallSid;if(typeof this.parameters.CallSid>"u")throw new ne("Could not send CallMessage; Call has no CallSid");const s=this._voiceEventSidGenerator();return this._messages.set(s,{content:i,contentType:n,messageType:o,voiceEventSid:s}),this._pstream.sendMessage(r,i,n,o,s),s}status(){return this._status}_checkVolume(e,i,n,o){const r=i>=10;let s=0;return n===e&&(s=i),s>=10?this._emitWarning("audio-level-",`constant-audio-${o}-level`,10,s,!1):r&&this._emitWarning("audio-level-",`constant-audio-${o}-level`,10,s,!0),s}_cleanupEventListeners(){const e=()=>{this._pstream&&(this._pstream.removeListener("ack",this._onAck),this._pstream.removeListener("answer",this._onAnswer),this._pstream.removeListener("cancel",this._onCancel),this._pstream.removeListener("error",this._onSignalingError),this._pstream.removeListener("hangup",this._onHangup),this._pstream.removeListener("ringing",this._onRinging),this._pstream.removeListener("transportClose",this._onTransportClose),this._pstream.removeListener("connected",this._onConnected),this._pstream.removeListener("message",this._onMessageReceived))};e(),setTimeout(e,0)}_createMetricPayload(){const e={call_sid:this.parameters.CallSid,dscp:!!this._options.dscp,sdk_version:Ee};return this._options.gateway&&(e.gateway=this._options.gateway),e.direction=this._direction,e}_disconnect(e,i){if(e=typeof e=="string"?e:null,!(this._status!==p.State.Open&&this._status!==p.State.Connecting&&this._status!==p.State.Reconnecting&&this._status!==p.State.Ringing)){if(this._log.info("Disconnecting..."),this._pstream!==null&&this._pstream.status!=="disconnected"&&this._shouldSendHangup){const n=this.parameters.CallSid||this.outboundConnectionId;n&&this._pstream.hangup(n,e)}this._cleanupEventListeners(),this._mediaHandler.close(),i||this._publisher.info("connection","disconnected-by-local",null,this)}}_maybeTransitionToOpen(){this._wasConnected,this._isAnswered&&(this._onSignalingReconnected(),this._signalingStatus=p.State.Open,this._mediaHandler&&this._mediaHandler.status==="open"&&(this._status=p.State.Open,this._wasConnected||(this._wasConnected=!0,this._log.debug("#accept"),this.emit("accept",this))))}_postFeedbackDeclined(){return this._publisher.info("feedback","received-none",null,this,!0)}_publishMetrics(){this._metricsSamples.length!==0&&this._publisher.postMetrics("quality-metrics-samples","metrics-sample",this._metricsSamples.splice(0),this._createMetricPayload(),this).catch(e=>{this._log.warn("Unable to post metrics to Insights. Received error:",e)})}_setCallSid(e){const i=e.callsid;i&&(this.parameters.CallSid=i,this._mediaHandler.callSid=i)}}p.toString=()=>"[Twilio.Call class]";(function(t){(function(e){e.Closed="closed",e.Connecting="connecting",e.Open="open",e.Pending="pending",e.Reconnecting="reconnecting",e.Ringing="ringing"})(t.State||(t.State={})),function(e){e.AudioLatency="audio-latency",e.ChoppyAudio="choppy-audio",e.DroppedCall="dropped-call",e.Echo="echo",e.NoisyCall="noisy-call",e.OneWayAudio="one-way-audio"}(t.FeedbackIssue||(t.FeedbackIssue={})),function(e){e[e.One=1]="One",e[e.Two=2]="Two",e[e.Three=3]="Three",e[e.Four=4]="Four",e[e.Five=5]="Five"}(t.FeedbackScore||(t.FeedbackScore={})),function(e){e.Incoming="INCOMING",e.Outgoing="OUTGOING"}(t.CallDirection||(t.CallDirection={})),function(e){e.Opus="opus",e.PCMU="pcmu"}(t.Codec||(t.Codec={})),function(e){e.None="none",e.Timeout="timeout"}(t.IceGatheringFailureReason||(t.IceGatheringFailureReason={})),function(e){e.ConnectionDisconnected="ConnectionDisconnected",e.ConnectionFailed="ConnectionFailed",e.IceGatheringFailed="IceGatheringFailed",e.LowBytes="LowBytes"}(t.MediaFailure||(t.MediaFailure={}))})(p||(p={}));function ko(){return"TJSxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}const Io={class:"lucide lucide-phone",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"};function Eo(t,e){return k(),R("svg",Io,[...e[0]||(e[0]=[v("path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384"},null,-1)])])}const pe=ze({name:"lucide-phone",render:Eo}),Pi={__name:"CountUpTimer",setup(t,{expose:e}){const i=E(0),n=E(0),o=E(0),r=E(null),s=E("0:00");function a(){s.value=u()}function l(){r.value=setInterval(()=>a(),1e3)}function c(){clearInterval(r.value);let d=s.value;return i.value=0,n.value=0,o.value=0,s.value="0:00",d}function u(d=0){d&&(typeof d=="string"&&(d=parseInt(d)),o.value=d,o.value>=60?(n.value=Math.floor(o.value/60),o.value=o.value%60):n.value=0,n.value>=60?(i.value=Math.floor(n.value/60),n.value=n.value%60):i.value=0),o.value===59&&(o.value=0,n.value=n.value+1,o.value--),n.value===60&&(n.value=0,i.value=i.value+1),o.value++;let h=n.value,m=o.value<10?"0"+o.value:o.value,b=i.value>0?i.value+":":"";return b&&(h=h<10?"0"+h:h,m=m<10?"0"+m:m,h===0&&(h="00")),b+h+":"+m}return e({start:l,stop:c,getTime:u,updatedTime:s}),(d,h)=>Qt(d.$slots,"default")}},Po={},Ao={xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-minimize-2"};function Ro(t,e){return k(),R("svg",Ao,[...e[0]||(e[0]=[v("polyline",{points:"4 14 10 14 10 20"},null,-1),v("polyline",{points:"20 10 14 10 14 4"},null,-1),v("line",{x1:"14",y1:"10",x2:"21",y2:"3"},null,-1),v("line",{x1:"3",y1:"21",x2:"10",y2:"14"},null,-1)])])}const Ai=be(Po,[["render",Ro]]),Do={class:"flex flex-row-reverse items-center gap-1"},Lo={class:"flex flex-col items-center justify-center gap-3"},Mo={class:"flex flex-col items-center justify-center gap-1"},Oo={class:"text-xl font-medium"},$o={class:"text-sm text-ink-gray-5"},jo={key:0,class:"my-1 text-base"},Uo={key:0,class:"my-1 text-base"},Fo={key:1,class:"flex gap-2"},No={key:2},Vo={key:3,class:"flex gap-2"},Ho={class:"flex items-center gap-2"},Wo={class:"max-w-[120px] truncate"},Bo={key:0,class:"flex items-center gap-2"},Go={class:"my-1 min-w-[40px] text-center"},qo={key:1,class:"flex items-center gap-3"},zo={class:"my-1"},Jo={key:2,class:"flex items-center gap-2"},Ko=Ae({__name:"TwilioCallUI",setup(t,{expose:e}){const i=dt(),n=Te("onCallStarted"),o=Te("onCallEnded"),r=Te("onCallFailed");let s=null,a=E(""),l=null,c=E(!1),u=E(!1),d=E(!1),h=E(!1),m=E(!1),b=E(null),g=E(null),_=E("");const y=E(""),M=E({full_name:"",image:"",mobile_no:"",phone:""});xe(y,P=>{P&&ke("telephony.api.get_contact_by_phone_number",{phone_number:y.value}).then(he=>{M.value=he})});const{width:V,height:U}=si();let{x:J,y:Re,style:ue}=ei(b,{initialValue:{x:V.value-280,y:U.value-310},preventDefault:!0});xe([V,U],()=>{J.value=Math.max(0,V.value-280),Re.value=Math.max(0,U.value-310)});async function ge(){a.value="Requesting Access Token...";try{const P=await ke("telephony.twilio.api.generate_access_token");a.value="Got a token.",ae(P.token)}catch(P){a.value="An error occurred. "+P.message}}function ae(P){s=new f(P,{codecPreferences:[p.Codec.Opus,p.Codec.PCMU]}),S(),s.register()}function S(){s.on("registered",()=>{a.value="Ready to make and receive calls!"}),s.on("unregistered",P=>{a.value="Logged out"}),s.on("error",P=>{a.value="Twilio.Device Error: "+P.message}),s.on("incoming",F),s.on("tokenWillExpire",async()=>{const P=await ke("telephony.twilio.api.generate_access_token");s.updateToken(P.token)})}function T(){l.isMuted()?(l.mute(!1),m.value=!1):(l.mute(),m.value=!0)}function F(P){a.value=`Incoming call from ${P.parameters.From}`,y.value=P.parameters.From,c.value=!0,l=P,P.on("cancel",Se),P.on("disconnect",Se),P.on("reject",Se)}async function X(){a.value="Accepted incoming call.",d.value=!0,await l.accept(),n&&n(),g.value.start()}function de(){l.reject(),a.value="Rejected incoming call",c.value=!1,u.value==null,u.value=!1,_.value="",m.value=!1,r&&r()}function _e(){l.disconnect(),a.value="Hanging up incoming call",d.value=!1,_.value="",m.value=!1,g.value.stop(),o&&o()}function Se(){a.value="Call ended from handle disconnected Incoming call.",c.value=!1,u.value==null,u.value=!1,l=null,m.value=!1,d.value=!1,g.value.stop(),o&&o()}async function je(P){if(y.value=P,s){a.value=`Attempting to call ${P} ...`,n&&n();try{l=await s.connect({params:{To:P,link_doctype:i.linkDoc.doctype,link_docname:i.linkDoc.docname}}),c.value=!0,_.value="initiating",l.on("messageReceived",he=>{let Q=he.content;_.value=Q.CallStatus,a.value=`Call status: ${Q.CallStatus}`,Q.CallStatus=="in-progress"&&(a.value="Call in progress.",h.value=!1,d.value=!0,g.value.start())}),l.on("accept",()=>{a.value="Initiated call!",c.value=!0,h.value=!0,d.value=!1}),l.on("disconnect",he=>{a.value="Call ended from makeOutgoing call disconnect.",h.value=!1,d.value=!1,c.value=!1,u.value=!1,l=null,_.value="",m.value=!1,g.value.stop(),o&&o()}),l.on("cancel",()=>{a.value="Call ended from makeOutgoing call cancel.",h.value=!1,d.value=!1,c.value=!1,u.value=!1,l=null,_.value="",m.value=!1,g.value.stop(),o&&o()})}catch(he){r&&r(),a.value=`Could not connect call: ${he.message}`,We.error(he.message)}}else r&&r(),a.value="Unable to make call.",We.error("Unable to make call.")}function De(){l.disconnect(),c.value=!1,u.value==null,u.value=!1,h.value=!1,d.value=!1,_.value="",m.value=!1}function Le(){c.value=!c.value,u.value==null?u.value=!u:u.value=!u.value}return xe(()=>a.value,P=>{console.log(P)},{immediate:!0}),e({makeOutgoingCall:je,setup:ge}),(P,he)=>{var yt,bt,St,wt,Ct,Tt,xt,kt,It;const Q=qe("Button");return k(),R(ut,null,[Ne(v("div",ii(ni(P.$attrs)),[v("div",{ref_key:"callPopup",ref:b,class:"fixed z-20 flex w-60 cursor-move select-none flex-col rounded-lg bg-surface-gray-7 p-4 !text-ink-gray-2 shadow-2xl",style:ti(w(ue))},[v("div",Do,[I(Ai,{class:"h-4 w-4 cursor-pointer",onClick:Le})]),v("div",Lo,[I(w(Be),{image:(yt=M.value)==null?void 0:yt.image,label:(bt=M.value)==null?void 0:bt.full_name,class:se(["relative flex !h-24 !w-24 items-center justify-center [&>div]:text-[30px]",w(d)||w(h)?"":"pulse"])},null,8,["image","label","class"]),v("div",Mo,[v("div",Oo,H(((St=M.value)==null?void 0:St.full_name)??"Unknown"),1),v("div",$o,H(((wt=M.value)==null?void 0:wt.mobile_no)||((Ct=M.value)==null?void 0:Ct.phone)),1)]),I(Pi,{ref_key:"counterUp",ref:g},{default:q(()=>{var Et;return[w(d)?(k(),R("div",jo,H((Et=w(g))==null?void 0:Et.updatedTime),1)):He("",!0)]}),_:1},512),w(d)?He("",!0):(k(),R("div",Uo,H(w(_)=="initiating"?"Initiating call...":w(_)=="ringing"?"Ringing...":w(h)?"Calling...":"Incoming call..."),1)),w(d)?(k(),R("div",Fo,[I(Q,{icon:w(m)?"mic-off":"mic",class:"rounded-full",onClick:T},null,8,["icon"]),I(Q,{class:"rounded-full bg-surface-red-5 hover:bg-surface-red-6",onClick:_e},{icon:q(()=>[I(w(pe),{class:"h-4 w-4 rotate-[135deg] text-ink-white"})]),_:1})])):w(h)||w(_)=="initiating"?(k(),R("div",No,[I(Q,{size:"md",variant:"solid",theme:"red",label:"Cancel",onClick:De,class:"rounded-lg"},{prefix:q(()=>[I(w(pe),{class:"h-4 w-4 rotate-[135deg]"})]),_:1})])):(k(),R("div",Vo,[I(Q,{size:"md",variant:"solid",theme:"green",label:"Accept",class:"rounded-lg",onClick:X},{prefix:q(()=>[I(w(pe),{class:"h-4 w-4"})]),_:1}),I(Q,{size:"md",variant:"solid",theme:"red",label:"Reject",class:"rounded-lg",onClick:de},{prefix:q(()=>[I(w(pe),{class:"h-4 w-4 rotate-[135deg]"})]),_:1})]))])],4)],16),[[Ve,w(c)]]),Ne(v("div",Bi({class:"ml-2 mt-1 flex cursor-pointer select-none items-center justify-between gap-3 rounded-lg bg-surface-gray-7 px-2 py-1 text-base !text-ink-gray-2",onClick:Le},P.$attrs),[v("div",Ho,[I(w(Be),{image:(Tt=M.value)==null?void 0:Tt.image,label:(xt=M.value)==null?void 0:xt.full_name,class:"relative flex !h-5 !w-5 items-center justify-center"},null,8,["image","label"]),v("div",Wo,H(((kt=M.value)==null?void 0:kt.full_name)??"Unknown"),1)]),w(d)?(k(),R("div",Bo,[v("div",Go,H((It=w(g))==null?void 0:It.updatedTime),1),I(Q,{variant:"solid",theme:"red",class:"!h-6 !w-6 rounded-full",onClick:Me(_e,["stop"])},{icon:q(()=>[I(w(pe),{class:"h-4 w-4 rotate-[135deg]"})]),_:1})])):w(h)?(k(),R("div",qo,[v("div",zo,H(w(_)=="ringing"?"Ringing...":"Calling..."),1),I(Q,{variant:"solid",theme:"red",class:"!h-6 !w-6 rounded-full",onClick:Me(De,["stop"])},{icon:q(()=>[I(w(pe),{class:"h-4 w-4 rotate-[135deg]"})]),_:1})])):(k(),R("div",Jo,[I(Q,{variant:"solid",theme:"green",class:"pulse relative !h-6 !w-6 rounded-full",onClick:Me(X,["stop"])},{icon:q(()=>[I(w(pe),{class:"h-4 w-4 animate-pulse"})]),_:1}),I(Q,{variant:"solid",theme:"red",class:"!h-6 !w-6 rounded-full",onClick:Me(de,["stop"])},{icon:q(()=>[I(w(pe),{class:"h-4 w-4 rotate-[135deg]"})]),_:1})]))],16),[[Ve,w(u)]])],64)}}});const Zo=be(Ko,[["__scopeId","data-v-31535601"]]),Xo={},Qo={width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function Yo(t,e){return k(),R("svg",Qo,[...e[0]||(e[0]=[v("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M8 7C9.65685 7 11 5.65685 11 4C11 2.34315 9.65685 1 8 1C6.34315 1 5 2.34315 5 4C5 5.65685 6.34315 7 8 7ZM7.5969 8C4.50582 8 2 10.5058 2 13.5969C2 14.118 2.37677 14.5628 2.89081 14.6485L4.52397 14.9207C6.82545 15.3042 9.17455 15.3042 11.476 14.9207L13.1092 14.6485C13.6232 14.5628 14 14.118 14 13.5969C14 10.5058 11.4942 8 8.4031 8H7.5969Z",fill:"currentColor","fill-opacity":"0.54"},null,-1)])])}const er=be(Xo,[["render",Yo]]),tr={class:"flex justify-center items-center size-5 rounded-full bg-surface-gray-6 shrink-0 mr-1"},ir={key:0},nr={key:0},sr={key:2},or={class:"flex flex-row-reverse items-center"},rr={class:"flex flex-col items-center justify-center gap-3"},ar={class:"flex flex-col items-center justify-center gap-1"},cr={class:"text-xl font-medium"},lr={class:"text-sm text-ink-gray-5"},ur={class:"my-1 text-base"},dr={class:"my-1 text-base"},hr=Ae({__name:"ExotelCallUI",setup(t,{expose:e}){const i=dt(),n=Te("onCallStarted"),o=Te("onCallEnded"),r=Te("onCallFailed"),s=E(null),a=E(!1);let l=E(!1);const{$socket:c}=Zi();function u(){a.value=!a.value,l.value==null,l.value=!l.value}const{width:d,height:h}=si();let{style:m,x:b,y:g}=ei(s,{initialValue:{x:d.value-280,y:h.value-310},preventDefault:!0});xe([d,h],()=>{b.value=Math.max(0,d.value-280),g.value=Math.max(0,h.value-310)});const _=E(""),y=E(""),M=E(null),V=E(null),U=E({full_name:"",image:"",mobile_no:"",phone:""});xe(y,S=>{S&&ke("telephony.api.get_contact_by_phone_number",{phone_number:y.value}).then(T=>{U.value=T})});function J(S){y.value=S,ke("telephony.exotel.handler.make_a_call",{to_number:y.value,link_doctype:i.linkDoc.doctype,link_docname:i.linkDoc.docname}).then(T=>{M.value=T,_.value="Calling...",a.value=!0,l.value=!1,n&&n()}).catch(T=>{var X;const F=((X=T==null?void 0:T.messages)==null?void 0:X[0])||"Something went wrong";We.error(F),r&&r()})}function Re(S){c.on("exotel_call",T=>{M.value=T,_.value=ae(T),!a.value&&!l.value&&(T.AgentEmail&&T.AgentEmail==S?(y.value=T.CallFrom||T.From,a.value=!0):y.value=T.To)})}Gi(()=>{c.off("exotel_call")});function ue(){a.value=!1,l.value=!1}const ge=E("00:00");function ae(S){if(S.EventType=="answered"&&S.Direction=="outbound-api"&&S.Status=="in-progress"&&S["Legs[0][Status]"]=="in-progress"&&S["Legs[1][Status]"]=="")return"Ringing...";if(S.EventType=="answered"&&S.Direction=="outbound-api"&&S.Status=="in-progress"&&S["Legs[1][Status]"]=="in-progress")return V.value.start(),n&&n(),"In progress";if(S.EventType=="terminal"&&S.Direction=="outbound-api"&&(S.Status=="no-answer"||S.Status=="busy")&&(S["Legs[1][Status]"]=="no-answer"||S["Legs[0][Status]"]=="no-answer"||S["Legs[1][Status]"]=="busy"||S["Legs[0][Status]"]=="busy"))return V.value.stop(),r&&r(),"No answer";if(S.EventType=="terminal"&&S.Direction=="outbound-api"&&S.Status=="completed")return V.value.stop(),ge.value=V.value.getTime(parseInt(S["Legs[0][OnCallDuration]"])||parseInt(S.DialCallDuration)),ue(),o&&o(),"Call ended";if(S.EventType=="Dial"&&S.Direction=="incoming"&&S.Status=="busy")return y.value=S.From||S.CallFrom,V.value.start(),"Incoming call";if(S.Direction=="incoming"&&S.CallType=="incomplete"&&S.DialCallStatus=="no-answer")return r&&r(),V.value.stop(),"No answer";if(S.Direction=="incoming"&&(S.CallType=="completed"||S.CallType=="client-hangup")&&(S.DialCallStatus=="completed"||S.DialCallStatus=="canceled"))return o&&o(),ge.value=V.value.getTime(parseInt(S["Legs[0][OnCallDuration]"])||parseInt(S.DialCallDuration)),ue(),V.value.stop(),"Call ended"}return e({makeOutgoingCall:J,setup:Re}),(S,T)=>{var F,X,de,_e,Se,je,De,Le;return k(),R("div",null,[Ne(v("div",{class:"ml-2 flex cursor-pointer select-none items-center justify-between gap-1 rounded-full bg-surface-gray-7 px-2 py-1 mt-1 text-base !text-ink-gray-2",onClick:u},[v("div",tr,[(F=U.value)!=null&&F.image?(k(),me(w(Be),{key:0,image:U.value.image,label:U.value.full_name,class:"!size-5"},null,8,["image","label"])):(k(),me(er,{key:1,class:"size-3"}))]),v("span",null,H(((X=U.value)==null?void 0:X.full_name)??(((de=U.value)==null?void 0:de.mobile_no)||((_e=U.value)==null?void 0:_e.phone))),1),T[1]||(T[1]=v("span",null,"",-1)),_.value=="In progress"?(k(),R("div",ir,H((Se=V.value)==null?void 0:Se.updatedTime),1)):_.value=="Call ended"||_.value=="No answer"?(k(),R("div",{key:1,class:se(["blink",{"text-red-700":_.value=="Call ended"||_.value=="No answer"}])},[v("span",null,H(_.value),1),_.value=="Call ended"?(k(),R("span",nr,[T[0]||(T[0]=v("span",null,"  ",-1)),v("span",null,H(ge.value),1)])):He("",!0)],2)):(k(),R("div",sr,H(_.value),1))],512),[[Ve,w(l)]]),Ne(v("div",ii(ni(S.$attrs)),[v("div",{ref_key:"callPopupHeader",ref:s,class:"fixed z-20 flex w-60 cursor-move select-none flex-col rounded-lg bg-surface-gray-7 p-2 !text-ink-gray-2 shadow-2xl",style:ti(w(m))},[v("div",or,[I(w(At),{onClick:ue,class:"bg-surface-gray-7 text-ink-white hover:bg-surface-gray-6 shrink-0",icon:"x",size:"md"}),I(w(At),{onClick:u,variant:"ghost",class:"bg-surface-gray-7 text-ink-white hover:bg-surface-gray-6 shrink-0"},{default:q(()=>[I(Ai,{class:"size-4 cursor-pointer"})]),_:1})]),v("div",rr,[I(w(Be),{image:U.value.image,label:U.value.full_name,class:se(["relative flex !h-24 !w-24 items-center justify-center [&>div]:text-[30px]",_.value=="In progress"?"":"pulse"])},null,8,["image","label","class"]),v("div",ar,[v("div",cr,H(((je=U.value)==null?void 0:je.full_name)??"Unknown"),1),v("div",lr,H(((De=U.value)==null?void 0:De.mobile_no)||((Le=U.value)==null?void 0:Le.phone)),1)]),I(Pi,{ref_key:"counterUp",ref:V},{default:q(()=>{var P;return[v("div",ur,H((P=V.value)==null?void 0:P.updatedTime),1)]}),_:1},512),v("div",dr,H(_.value),1)])],4)],16),[[Ve,a.value]])])}}});const pr=be(hr,[["__scopeId","data-v-7ebd4035"]]),fr={class:"flex flex-col gap-4"},mr={class:"flex flex-col gap-1"},gr={key:0,class:"text-sm text-ink-gray-4"},Rr=Ae({__name:"CallUI",props:{userEmail:{type:String,default:""}},setup(t){const e=dt(),{defaultCallingMedium:i,isExotelEnabled:n,isTwilioEnabled:o}=qi(e),r=E(null),s=E(null),a=E("Twilio"),l=E(!1),c=E(!1),u=E(""),d=t;function h({number:g,doctype:_,docname:y}){if(e.setLinkDoc({docname:y,doctype:_}),o.value&&n.value&&!i.value||!g){u.value=g,c.value=!0;return}a.value=o.value?"Twilio":"Exotel",i.value&&(a.value=i.value),u.value=g,m()}function m(){l.value&&a.value&&(b(),l.value=!1),a.value==="Twilio"&&r.value.makeOutgoingCall(u.value),a.value==="Exotel"&&s.value.makeOutgoingCall(u.value),c.value=!1}async function b(){await ke("telephony.api.set_default_calling_medium",{medium:a.value}),e.setDefaultCallingMedium(a.value),e.fetchCallIntegrationStatus(),We.success(`Default calling medium set successfully to ${a.value}`)}return xe([o,n],([g,_])=>zi(()=>{g&&(r.value.setup(),a.value="Twilio"),_&&(s.value.setup(d.userEmail),a.value="Exotel"),(g||_)&&(a.value="Twilio",e.setMakeCall(h))}),{immediate:!0}),(g,_)=>{const y=qe("Dialog");return k(),R(ut,null,[I(Zo,{ref_key:"twilio",ref:r},null,512),I(pr,{ref_key:"exotel",ref:s},null,512),I(y,{modelValue:c.value,"onUpdate:modelValue":_[3]||(_[3]=M=>c.value=M),options:{title:"Make call",actions:[{label:`Call using ${a.value}`,variant:"solid",onClick:m}]}},{"body-content":q(()=>[v("div",fr,[I(w(Qe),{type:"text",modelValue:u.value,"onUpdate:modelValue":_[0]||(_[0]=M=>u.value=M),label:"Mobile Number"},null,8,["modelValue"]),I(w(Qe),{type:"select",modelValue:a.value,"onUpdate:modelValue":_[1]||(_[1]=M=>a.value=M),label:"Calling Medium",options:["Twilio","Exotel"]},null,8,["modelValue"]),v("div",mr,[I(w(Qe),{type:"checkbox",modelValue:l.value,"onUpdate:modelValue":_[2]||(_[2]=M=>l.value=M),label:`Make ${a.value} as default calling medium`},null,8,["modelValue","label"]),l.value?(k(),R("div",gr,H(g.__("You can change the default calling medium from the settings")),1)):He("",!0)])])]),_:1},8,["modelValue","options"])],64)}}});export{cn as H,kr as L,Ir as _,Er as a,xr as b,Pr as c,Tr as d,Rr as e,sn as u};
//# sourceMappingURL=CallUI.vue_vue_type_script_setup_true_lang-4f864ee1.js.map
