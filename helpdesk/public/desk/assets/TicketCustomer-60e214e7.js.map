{"version":3,"mappings":"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","names":["emit","__emit","ticket","inject","ITicket","slaData","computed","firstResponse","firstResponseData","resolution","resolutionData","dayjs","formatTime","ticketBasicInfo","ticketAdditionalInfo","fields","custom_fields","field","_openBlock","_createElementBlock","_hoisted_1","_createElementVNode","_hoisted_2","_hoisted_3","_createVNode","_unref","Avatar","_hoisted_4","Tooltip","_hoisted_5","_toDisplayString","_hoisted_6","_component_Button","_component_EmailIcon","_Fragment","_renderList","_hoisted_7","_hoisted_8","_normalizeClass","data","_hoisted_9","_hoisted_10","_component_Badge","_createBlock","_component_TicketFeedback","_hoisted_11","_hoisted_12","_hoisted_13","TicketTextEditor","defineAsyncComponent","router","useRouter","props","__props","getStatus","useTicketStatusStore","createResource","isCustomerPortal","_a","setupCustomizations","call","toast","$dialog","updateField","__","provide","editor","ref","editorContent","attachments","showFeedbackDialog","isExpanded","isMobileView","useScreenSize","globalStore","send","name","value","callback","updateTicket","sendEmail","isContentEmpty","fieldname","handleClose","showFeedback","showConfirmationDialog","close","setValue","params","breadcrumbs","items","showEditor","isFeedbackMandatory","useConfigStore","_b","c","startViewing","stopViewing","useActiveViewers","onMounted","socket","ticket_id","onUnmounted","LayoutHeader","Breadcrumbs","_component_CustomActions","Button","_component_LucideCheck","TicketCustomerTemplateFields","TicketConversation","$event","file","uploadFunction","$refs","TicketCustomerSidebar","TicketFeedback"],"sources":["../../../../desk/src/components/ticket/TicketCustomerSidebar.vue","../../../../desk/src/pages/ticket/TicketCustomer.vue"],"sourcesContent":["<template>\n  <div class=\"flex w-[382px] flex-col border-l gap-4\">\n    <!-- Ticket ID -->\n    <div class=\"flex items-center justify-between border-b px-5 py-3\">\n      <span class=\"cursor-copy text-lg font-semibold\">Ticket details</span>\n    </div>\n    <!-- user info and sla info -->\n    <div class=\"flex flex-col gap-4 pt-0 px-5 py-3 border-b\">\n      <!-- user info -->\n      <div class=\"flex gap-2\">\n        <Avatar\n          size=\"2xl\"\n          :image=\"ticket.data.contact.image\"\n          :label=\"ticket.data.contact.name\"\n        />\n        <div class=\"flex items-center justify-between\">\n          <Tooltip :text=\"ticket.data.contact.name\">\n            <div class=\"w-[242px] truncate text-2xl font-medium\">\n              {{ ticket.data.contact.name }}\n            </div>\n          </Tooltip>\n          <div class=\"flex gap-1.5\" v-if=\"!ticket.data.feedback_rating\">\n            <Tooltip :text=\"ticket.data.contact.email_id\">\n              <Button class=\"h-7 w-7\" @click=\"emit('open')\">\n                <template #icon>\n                  <EmailIcon class=\"h-4 w-4\" />\n                </template>\n              </Button>\n            </Tooltip>\n          </div>\n        </div>\n      </div>\n\n      <!-- Ticket Info -->\n      <div\n        class=\"flex items-center text-base leading-5\"\n        v-for=\"field in ticketBasicInfo\"\n      >\n        <span class=\"w-[126px] text-sm text-gray-600\">{{ field.label }}</span>\n        <span\n          class=\"text-base text-gray-800 flex-1\"\n          :class=\"!field.value && 'text-ink-gray-4'\"\n        >\n          {{ field.value || \"—\" }}\n        </span>\n      </div>\n\n      <!-- sla info -->\n      <div\n        v-for=\"data in slaData\"\n        :key=\"data.label\"\n        class=\"flex items-center text-base\"\n      >\n        <div class=\"w-[126px] text-gray-600 text-sm\">{{ data.title }}</div>\n\n        <div class=\"break-words text-base text-gray-800\">\n          <Tooltip :text=\"dayjs(data.value).long()\">\n            <Badge :label=\"data.label\" :theme=\"data.theme\" variant=\"subtle\" />\n          </Tooltip>\n        </div>\n      </div>\n    </div>\n    <!-- feedback component -->\n    <TicketFeedback\n      v-if=\"ticket.data.feedback_rating\"\n      class=\"border-b text-base text-gray-600\"\n      :ticket=\"ticket.data\"\n    />\n    <div class=\"flex flex-col gap-4 pt-0 px-5 py-3 overflow-y-scroll\">\n      <div\n        class=\"flex items-center text-base leading-5\"\n        v-for=\"field in ticketAdditionalInfo\"\n      >\n        <span class=\"w-[126px] text-sm text-gray-600\">{{ field.label }}</span>\n        <span\n          class=\"text-base text-gray-800 flex-1\"\n          :class=\"!field.value && 'text-ink-gray-4'\"\n        >\n          {{ field.value || \"—\" }}\n        </span>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { dayjs } from \"@/dayjs\";\nimport { ITicket } from \"@/pages/ticket/symbols\";\nimport { Field } from \"@/types\";\nimport { formatTime } from \"@/utils\";\nimport { Avatar, Tooltip } from \"frappe-ui\";\nimport { computed, inject } from \"vue\";\n\nconst emit = defineEmits([\"open\"]);\n\nconst ticket = inject(ITicket);\n\nconst slaData = computed(() => {\n  const firstResponse = firstResponseData();\n  const resolution = resolutionData();\n  return [\n    {\n      title: \"First Response\",\n      value: ticket.data.first_responded_on || ticket.data.response_by,\n      label: firstResponse.label,\n      theme: firstResponse.color,\n    },\n    {\n      title: \"Resolution\",\n      value: ticket.data.resolution_date || ticket.data.resolution_by,\n      label: resolution.label,\n      theme: resolution.color,\n    },\n  ];\n});\n\nfunction firstResponseData() {\n  let firstResponse = null;\n  if (\n    !ticket.data.first_responded_on &&\n    dayjs().isBefore(dayjs(ticket.data.response_by))\n  ) {\n    firstResponse = {\n      label: `Due in ${formatTime(\n        dayjs(ticket.data.response_by).diff(dayjs(), \"s\")\n      )}`,\n      color: \"orange\",\n    };\n  } else if (\n    dayjs(ticket.data.first_responded_on).isBefore(\n      dayjs(ticket.data.response_by)\n    )\n  ) {\n    firstResponse = {\n      label: `Fulfilled in ${formatTime(\n        dayjs(ticket.data.first_responded_on).diff(\n          dayjs(ticket.data.creation),\n          \"s\"\n        )\n      )}`,\n      color: \"green\",\n    };\n  } else {\n    firstResponse = {\n      label: \"Failed\",\n      color: \"red\",\n    };\n  }\n  return firstResponse;\n}\n\nfunction resolutionData() {\n  let resolution = null;\n  if (\n    !ticket.data.resolution_date &&\n    dayjs().isBefore(ticket.data.resolution_by)\n  ) {\n    resolution = {\n      label: `Due in ${formatTime(\n        dayjs(ticket.data.resolution_by).diff(dayjs(), \"s\")\n      )}`,\n      color: \"orange\",\n    };\n  } else if (ticket.data.agreement_status === \"Fulfilled\") {\n    resolution = {\n      label: `Fulfilled in ${formatTime(\n        dayjs(ticket.data.resolution_time, \"s\")\n      )}`,\n      color: \"green\",\n    };\n  } else {\n    resolution = {\n      label: \"Failed\",\n      color: \"red\",\n    };\n  }\n  return resolution;\n}\n\nconst ticketBasicInfo = computed(() => [\n  {\n    label: \"Ticket ID\",\n    value: ticket.data.name,\n  },\n  {\n    label: \"Status\",\n    value: ticket.data.status,\n    bold: true,\n  },\n]);\n\nconst ticketAdditionalInfo = computed(() => {\n  const fields = [\n    {\n      label: \"Subject\",\n      value: ticket.data.subject,\n    },\n    {\n      label: \"Team\",\n      value: ticket.data.agent_group || \"-\",\n    },\n    {\n      label: \"Priority\",\n      value: ticket.data.priority,\n    },\n  ];\n  const custom_fields = ticket.data.template.fields\n    .filter(\n      (field: Field) =>\n        !field.hide_from_customer &&\n        [\"subject\", \"team\", \"priority\"].indexOf(field.fieldname) === -1\n    )\n    .map((field: Field) => ({\n      label: field.label,\n      value: ticket.data[field.fieldname],\n    }));\n\n  return [...fields, ...custom_fields];\n});\n</script>\n\n<style scoped></style>\n","<template>\n  <div v-if=\"ticket.data\" class=\"flex flex-col\">\n    <LayoutHeader>\n      <template #left-header>\n        <Breadcrumbs :items=\"breadcrumbs\" />\n      </template>\n      <template #right-header>\n        <CustomActions\n          v-if=\"ticket.data._customActions\"\n          :actions=\"ticket.data._customActions\"\n        />\n        <Button\n          v-if=\"ticket.data.status !== 'Closed'\"\n          :label=\"__('Close')\"\n          theme=\"gray\"\n          variant=\"solid\"\n          @click=\"handleClose()\"\n        >\n          <template #prefix>\n            <LucideCheck class=\"size-4\" />\n          </template>\n        </Button>\n      </template>\n    </LayoutHeader>\n    <div class=\"flex overflow-hidden h-full w-full\">\n      <!-- Main Ticket Comm -->\n      <section class=\"flex flex-col flex-1 w-full md:max-w-[calc(100%-382px)]\">\n        <!-- show for only mobile -->\n        <TicketCustomerTemplateFields v-if=\"isMobileView\" />\n\n        <TicketConversation class=\"grow\" />\n        <div\n          class=\"w-full p-5\"\n          @keydown.ctrl.enter.capture.stop=\"sendEmail\"\n          @keydown.meta.enter.capture.stop=\"sendEmail\"\n        >\n          <TicketTextEditor\n            v-if=\"showEditor\"\n            ref=\"editor\"\n            v-model:attachments=\"attachments\"\n            v-model:content=\"editorContent\"\n            v-model:expand=\"isExpanded\"\n            :placeholder=\"__('Type a message')\"\n            autofocus\n            @clear=\"() => (isExpanded = false)\"\n            :uploadFunction=\"\n              (file: any) => uploadFunction(file, 'HD Ticket', props.ticketId)\n            \"\n          >\n            <template #bottom-right>\n              <Button\n                :label=\"__('Send')\"\n                theme=\"gray\"\n                variant=\"solid\"\n                :disabled=\"$refs.editor?.editor.isEmpty || send.loading\"\n                :loading=\"send.loading\"\n                @click=\"sendEmail\"\n              />\n            </template>\n          </TicketTextEditor>\n        </div>\n      </section>\n      <!-- Ticket Sidebar only for desktop view-->\n      <TicketCustomerSidebar v-if=\"!isMobileView\" @open=\"isExpanded = true\" />\n    </div>\n    <TicketFeedback v-model:open=\"showFeedbackDialog\" />\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { LayoutHeader } from \"@/components\";\nimport TicketCustomerSidebar from \"@/components/ticket/TicketCustomerSidebar.vue\";\nimport { setupCustomizations } from \"@/composables/formCustomisation\";\nimport { useActiveViewers } from \"@/composables/realtime\";\nimport { useScreenSize } from \"@/composables/screen\";\nimport { socket } from \"@/socket\";\nimport { useConfigStore } from \"@/stores/config\";\nimport { globalStore } from \"@/stores/globalStore\";\nimport { useTicketStatusStore } from \"@/stores/ticketStatus\";\nimport { isContentEmpty, isCustomerPortal, uploadFunction } from \"@/utils\";\nimport { Breadcrumbs, Button, call, createResource, toast } from \"frappe-ui\";\nimport { __ } from \"@/translation\";\nimport {\n  computed,\n  defineAsyncComponent,\n  onMounted,\n  onUnmounted,\n  provide,\n  ref,\n} from \"vue\";\nimport { useRouter } from \"vue-router\";\nimport { ITicket } from \"./symbols\";\nimport TicketConversation from \"./TicketConversation.vue\";\nimport TicketCustomerTemplateFields from \"./TicketCustomerTemplateFields.vue\";\nimport TicketFeedback from \"./TicketFeedback.vue\";\nconst TicketTextEditor = defineAsyncComponent(\n  () => import(\"./TicketTextEditor.vue\")\n);\n\ninterface P {\n  ticketId: string;\n}\nconst router = useRouter();\n\nconst props = defineProps<P>();\n\nconst { getStatus } = useTicketStatusStore();\n\nconst ticket = createResource({\n  url: \"helpdesk.helpdesk.doctype.hd_ticket.api.get_one\",\n  cache: [\"Ticket\", props.ticketId],\n  params: {\n    name: props.ticketId,\n    is_customer_portal: isCustomerPortal.value,\n  },\n  auto: true,\n  onSuccess: (data) => {\n    data.status = getStatus(data.status)?.label_customer;\n    setupCustomizations(ticket, {\n      doc: data,\n      call,\n      router,\n      toast,\n      $dialog,\n      updateField,\n      createToast: toast.create,\n    });\n  },\n  onError: () => {\n    toast.error(__(\"Ticket not found\"));\n    router.replace(\"/my-tickets\");\n  },\n});\n\nprovide(ITicket, ticket);\nconst editor = ref(null);\nconst editorContent = ref(\"\");\nconst attachments = ref([]);\nconst showFeedbackDialog = ref(false);\nconst isExpanded = ref(false);\n\nconst { isMobileView } = useScreenSize();\nconst { $dialog } = globalStore();\n\nconst send = createResource({\n  url: \"run_doc_method\",\n  debounce: 300,\n  makeParams: () => ({\n    dt: \"HD Ticket\",\n    dn: props.ticketId,\n    method: \"create_communication_via_contact\",\n    args: {\n      message: editorContent.value,\n      attachments: attachments.value,\n    },\n  }),\n  onSuccess: () => {\n    editor.value.editor.commands.clearContent(true);\n    attachments.value = [];\n    isExpanded.value = false;\n    ticket.reload();\n  },\n});\n\nfunction updateField(name, value, callback = () => {}) {\n  updateTicket(name, value);\n  callback();\n}\n\nfunction sendEmail() {\n  if (isContentEmpty(editorContent.value) || send.loading) {\n    return;\n  }\n  send.submit();\n}\n\nfunction updateTicket(fieldname: string, value: string) {\n  createResource({\n    url: \"frappe.client.set_value\",\n    params: {\n      doctype: \"HD Ticket\",\n      name: props.ticketId,\n      fieldname,\n      value,\n    },\n    auto: true,\n    onSuccess: () => {\n      ticket.reload();\n      toast.success(__(\"Ticket updated\"));\n    },\n  });\n}\n\nfunction handleClose() {\n  if (showFeedback.value) {\n    showFeedbackDialog.value = true;\n  } else {\n    showConfirmationDialog();\n  }\n}\n\nfunction showConfirmationDialog() {\n  $dialog({\n    title: __(\"Close Ticket\"),\n    message: __(\"Are you sure you want to close this ticket?\"),\n    actions: [\n      {\n        label: __(\"Confirm\"),\n        variant: \"solid\",\n        onClick(close: Function) {\n          ticket.data.status = \"Closed\";\n          setValue.submit(\n            { fieldname: \"status\", value: \"Closed\" },\n            {\n              onSuccess: () => {\n                toast.success(__(\"Ticket closed\"));\n              },\n            }\n          );\n          close();\n        },\n      },\n    ],\n  });\n}\n\nconst setValue = createResource({\n  url: \"frappe.client.set_value\",\n  debounce: 300,\n  makeParams: (params) => {\n    return {\n      doctype: \"HD Ticket\",\n      name: props.ticketId,\n      fieldname: params.fieldname,\n      value: params.value,\n    };\n  },\n  onSuccess: () => {\n    showFeedbackDialog.value = false;\n    ticket.reload();\n  },\n});\n\nconst breadcrumbs = computed(() => {\n  let items = [{ label: __(\"Tickets\"), route: { name: \"TicketsCustomer\" } }];\n  items.push({\n    label: ticket.data?.subject,\n    route: { name: \"TicketCustomer\" },\n  });\n  return items;\n});\n\nconst showEditor = computed(() => ticket.data.status !== \"Closed\");\n\n// this handles whether the ticket was raised and then was closed without any reply from the agent.\nconst { isFeedbackMandatory } = useConfigStore();\nconst showFeedback = computed(() => {\n  const hasAgentCommunication = ticket.data?.communications?.some(\n    (c) => c.sender !== ticket.data.raised_by\n  );\n  return hasAgentCommunication && isFeedbackMandatory;\n});\nconst { startViewing, stopViewing } = useActiveViewers(props.ticketId);\nonMounted(() => {\n  startViewing(props.ticketId);\n  document.title = props.ticketId;\n\n  socket.on(\"helpdesk:ticket-update\", ({ ticket_id }) => {\n    if (ticket_id === props.ticketId) {\n      ticket.reload();\n    }\n  });\n});\n\nonUnmounted(() => {\n  stopViewing(props.ticketId);\n  document.title = \"Helpdesk\";\n  socket.off(\"helpdesk:ticket-update\");\n});\n</script>\n"],"file":"assets/TicketCustomer-60e214e7.js"}